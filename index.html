<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchoStream</title>

<!-- Firebase (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --bg:#fff; --text:#000; --card:#f3f3f3; --border:#ddd; --accent:#1da1f2; --red:#ff0000;
}
body.dark { --bg:#000; --text:#fff; --card:#1a1a1a; --border:#333; }
body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); transition:0.3s; }
header { position:fixed; top:0; left:0; right:0; padding:14px; background:var(--bg); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:bold; z-index:10; }
nav { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; padding:12px 0; background:var(--bg); border-top:1px solid var(--border); }
nav i{font-size:20px; cursor:pointer;}
main{padding:80px 16px 90px; max-width:600px; margin:auto;}
.card{background:var(--card); padding:16px; border-radius:16px; margin-bottom:12px;}
textarea,input{width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text); box-sizing:border-box;}
button{background:var(--accent); color:white; border:none; padding:10px 18px; border-radius:999px; font-weight:600; margin-top:8px; cursor:pointer;}
.hidden{display:none;}
.avatar{width:60px; height:60px; border-radius:50%; background:#666; color:white; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:700;}
.verified{color:#1da1f2; margin-left:6px;}
.post-image{max-width:100%; border-radius:12px; margin-top:8px;}
.comment{display:flex; gap:12px; margin-top:8px;}
.comment-body{flex:1;}
.modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:50;}
.modal-content{background:var(--card); padding:32px; border-radius:16px; width:90%; max-width:400px; text-align:center;}
.username-link { cursor:pointer; }
.username-link:hover { text-decoration:underline; }
</style>
</head>
<body>

<header>
  EchoStream
  <i class="fas fa-cog" onclick="route('settings')"></i>
</header>

<main>
<!-- LOGIN -->
<div id="login">
  <h2>Welcome to EchoStream</h2>
  <button onclick="login()">Sign in with Google</button>
</div>

<!-- FEED -->
<div id="feed" class="hidden">
  <div class="card">
    <textarea id="postText" placeholder="Whatâ€™s happening?"></textarea>
    <input type="file" id="postImage" accept="image/*" style="margin-top:8px;">
    <button onclick="createPost()">Post</button>
  </div>
  <div id="posts"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden"></div>

<!-- SETTINGS -->
<div id="settings" class="hidden">
  <div class="card">
    <h3>Settings</h3>
    <label><input type="checkbox" id="darkToggle"> Dark mode</label><br><br>
    <label><input type="checkbox" id="privateToggle"> Private account</label><br><br>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<!-- ADMIN -->
<div id="admin" class="hidden">
  <div class="card">
    <h3>Admin Panel</h3>
    <input id="verifyUid" placeholder="User UID to verify">
    <button onclick="verifyUser()">Verify User</button>
  </div>
  <div id="adminPanel"></div>
</div>

<!-- USERNAME MODAL -->
<div id="usernameModal" class="modal">
  <div class="modal-content">
    <h3>Pick a username</h3>
    <input id="usernameInput" placeholder="username" maxlength="20">
    <button onclick="saveUsername()">Save</button>
  </div>
</div>

</main>

<nav>
  <i class="fa fa-house" onclick="route('feed')"></i>
  <i class="fa fa-user" onclick="route('profile')"></i>
  <i class="fa fa-gear" onclick="route('settings')"></i>
  <i class="fa fa-shield" onclick="route('admin')"></i>
</nav>

<script>
  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
    authDomain: "echostream-a102a.firebaseapp.com",
    projectId: "echostream-a102a",
    storageBucket: "echostream-a102a.firebasestorage.app",
    messagingSenderId: "789062222400",
    appId: "1:789062222400:web:73d478269135a77d7d55a5",
    measurementId: "G-QCJ1240EC5"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();
  let currentUser = null;
  let userData = null;

  // ===== AUTH =====
  function login() {
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }

  function logout() {
    auth.signOut().then(() => location.reload());
  }

  auth.onAuthStateChanged(async user => {
    if (!user) {
      document.getElementById("login").style.display = "block";
      ["feed","profile","settings","admin"].forEach(p => document.getElementById(p).classList.add("hidden"));
      return;
    }
    currentUser = user;
    document.getElementById("login").style.display = "none";

    const userRef = db.collection("users").doc(user.uid);
    const snap = await userRef.get();

    if (!snap.exists) {
      await userRef.set({
        username: user.displayName?.replace(/\s/g,"").toLowerCase() || "user",
        verified: false,
        role: "user",
        private: false,
        followers: [],
        following: []
      });
      document.getElementById("usernameModal").style.display = "flex";
    } else {
      userData = snap.data();
      document.getElementById("darkToggle").checked = localStorage.getItem("darkMode") === "true";
      document.getElementById("privateToggle").checked = userData.private || false;
    }

    if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark");

    route("feed");
  });

  // ===== ROUTING =====
  function route(page) {
    ["feed","profile","settings","admin"].forEach(p => document.getElementById(p).classList.add("hidden"));
    document.getElementById(page).classList.remove("hidden");

    if (page === "profile") loadProfile(currentUser.uid);
    if (page === "admin") {
      if (!userData || !["owner","admin"].includes(userData.role)) {
        alert("Admins only");
        route("feed");
      } else {
        loadAdminPanel();
      }
    }
  }

  // ===== DARK MODE =====
  document.getElementById("darkToggle").onchange = function() {
    document.body.classList.toggle("dark", this.checked);
    localStorage.setItem("darkMode", this.checked);
  };

  // ===== PRIVATE ACCOUNT =====
  document.getElementById("privateToggle").onchange = function() {
    togglePrivate(this.checked);
  };

  async function togglePrivate(isPrivate) {
    await db.collection("users").doc(currentUser.uid).update({ private: isPrivate });
    userData.private = isPrivate;
    alert(`Account is now ${isPrivate ? "private" : "public"}`);
    loadFeed();
  }

  // ===== POST FUNCTIONS =====
  async function createPost() {
    const text = document.getElementById("postText").value.trim();
    const file = document.getElementById("postImage").files[0];
    if (!text && !file) return alert("Post cannot be empty");

    let imageUrl = "";
    if (file) {
      const path = "posts/" + currentUser.uid + "/" + Date.now() + "_" + file.name;
      const ref = storage.ref(path);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }

    await db.collection("posts").add({
      uid: currentUser.uid,
      username: userData.username,
      text,
      imageUrl,
      likes: [],
      comments: [],
      reposts: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("postText").value = "";
    document.getElementById("postImage").value = "";
    loadFeed();
  }

  function timeAgo(timestamp) {
    if (!timestamp) return "now";
    const seconds = Math.floor((Date.now() - timestamp.toDate()) / 1000);
    if (seconds < 60) return seconds + "s";
    if (seconds < 3600) return Math.floor(seconds/60) + "m";
    if (seconds < 86400) return Math.floor(seconds/3600) + "h";
    return Math.floor(seconds/86400) + "d";
  }

  // ===== USERNAME MODAL =====
  async function saveUsername() {
    let input = document.getElementById("usernameInput").value.trim().toLowerCase();
    if (input.length < 3) return alert("Username too short (min 3 chars)");
    if (!/^[a-z0-9_]+$/.test(input)) return alert("Only lowercase letters, numbers, and underscore allowed");

    const snap = await db.collection("users").where("username", "==", input).get();
    if (!snap.empty) return alert("Username already taken");

    await db.collection("users").doc(currentUser.uid).update({ username: input });
    userData.username = input;
    document.getElementById("usernameModal").style.display = "none";
    loadFeed();
  }

  // ===== INITIAL LOAD =====
  if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark");

</script>
</body>
</html>