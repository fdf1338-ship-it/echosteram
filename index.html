<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchoStream</title>

<!-- Firebase (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* Keep your styles the same */
:root {
  --bg:#fff; --text:#000; --card:#f3f3f3; --border:#ddd; --accent:#1da1f2; --red:#ff0000;
}
body.dark { --bg:#000; --text:#fff; --card:#1a1a1a; --border:#333; }
body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); transition:0.3s; }
header { position:fixed; top:0; left:0; right:0; padding:14px; background:var(--bg); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:bold; z-index:10; }
nav { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; padding:12px 0; background:var(--bg); border-top:1px solid var(--border); }
nav i{font-size:20px; cursor:pointer;}
main{padding:80px 16px 90px; max-width:600px; margin:auto;}
.card{background:var(--card); padding:16px; border-radius:16px; margin-bottom:12px;}
textarea,input{width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text); box-sizing:border-box;}
button{background:var(--accent); color:white; border:none; padding:10px 18px; border-radius:999px; font-weight:600; margin-top:8px; cursor:pointer;}
.hidden{display:none;}
.avatar{width:60px; height:60px; border-radius:50%; background:#666; color:white; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:700;}
.verified{color:#1da1f2; margin-left:6px;}
.post-image{max-width:100%; border-radius:12px; margin-top:8px;}
.comment{display:flex; gap:12px; margin-top:8px;}
.comment-body{flex:1;}
.modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:50;}
.modal-content{background:var(--card); padding:32px; border-radius:16px; width:90%; max-width:400px; text-align:center;}
.username-link { cursor:pointer; }
.username-link:hover { text-decoration:underline; }
</style>
</head>
<body>

<header>
  EchoStream
  <i class="fas fa-cog" onclick="route('settings')"></i>
</header>

<main>
  <!-- LOGIN -->
  <div id="login">
    <h2>Welcome to EchoStream</h2>
    <button id="loginBtn">Sign in with Google</button>
  </div>

  <!-- FEED -->
  <div id="feed" class="hidden">
    <div class="card">
      <textarea id="postText" placeholder="Whatâ€™s happening?"></textarea>
      <input type="file" id="postImage" accept="image/*" style="margin-top:8px;">
      <button onclick="createPost()">Post</button>
    </div>
    <div id="posts"></div>
  </div>

  <!-- SETTINGS -->
  <div id="settings" class="hidden">
    <div class="card">
      <h3>Settings</h3>
      <label><input type="checkbox" id="darkToggle"> Dark mode</label><br><br>
      <button onclick="logout()">Logout</button>
    </div>
  </div>
</main>

<nav>
  <i class="fa fa-house" onclick="route('feed')"></i>
  <i class="fa fa-gear" onclick="route('settings')"></i>
</nav>

<script>
// ===== FIREBASE CONFIG - REPLACE WITH YOUR PROJECT =====
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
});

// ===== GLOBAL VARIABLES =====
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let currentUser = null;
let userData = null;

// ===== LOGIN =====
window.login = function() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
    .then(result => console.log("Logged in as:", result.user.displayName))
    .catch(err => alert("Login error: " + err.message));
};

document.getElementById("loginBtn").addEventListener("click", login);

// ===== LOGOUT =====
function logout() {
  auth.signOut().then(() => location.reload());
}

// ===== AUTH STATE =====
auth.onAuthStateChanged(async user => {
  if (!user) {
    document.getElementById("login").style.display = "block";
    ["feed","settings"].forEach(p => document.getElementById(p).classList.add("hidden"));
    return;
  }

  currentUser = user;
  document.getElementById("login").style.display = "none";
  document.getElementById("feed").classList.remove("hidden");

  // Load user data
  const snap = await db.collection("users").doc(user.uid).get();
  if (!snap.exists) {
    await db.collection("users").doc(user.uid).set({
      username: user.displayName.replace(/\s/g,"").toLowerCase(),
      role: "user",
      private: false
    });
  }
  userData = (await db.collection("users").doc(user.uid).get()).data();

  // Apply dark mode if saved
  if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark");

  loadFeed();
});

// ===== ROUTING =====
function route(page) {
  ["feed","settings"].forEach(p => document.getElementById(p).classList.add("hidden"));
  document.getElementById(page).classList.remove("hidden");
}

// ===== DARK MODE =====
document.getElementById("darkToggle").onchange = function() {
  document.body.classList.toggle("dark", this.checked);
  localStorage.setItem("darkMode", this.checked);
};

// ===== FEED FUNCTIONS =====
async function createPost() {
  const text = document.getElementById("postText").value.trim();
  const file = document.getElementById("postImage").files[0];
  if (!text && !file) return alert("Post cannot be empty");

  let imageUrl = "";
  if (file) {
    const path = "posts/" + currentUser.uid + "/" + Date.now() + "_" + file.name;
    const ref = storage.ref(path);
    await ref.put(file);
    imageUrl = await ref.getDownloadURL();
  }

  await db.collection("posts").add({
    uid: currentUser.uid,
    username: userData.username,
    text,
    imageUrl,
    likes: [],
    comments: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("postText").value = "";
  document.getElementById("postImage").value = "";
  loadFeed();
}

async function loadFeed() {
  const postsDiv = document.getElementById("posts");
  postsDiv.innerHTML = "<p>Loading...</p>";

  db.collection("posts").orderBy("timestamp", "desc").onSnapshot(snapshot => {
    postsDiv.innerHTML = "";
    snapshot.docs.forEach(doc => {
      const post = doc.data();
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <strong>${post.username}</strong><br>
        <p>${post.text || ""}</p>
        ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image">` : ""}
      `;
      postsDiv.appendChild(div);
    });
  });
}
</script>
</body>
</html>