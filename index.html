<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EchoStream</title>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#666;
      --card:#f3f3f3; --border:#ddd;
      --accent:#1da1f2; --danger:#ff3b30;
      --good:#22c55e;
    }
    body.dark{
      --bg:#0b0b0b; --text:#fff; --muted:#aaa;
      --card:#151515; --border:#2a2a2a;
    }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{
      position:fixed; top:0; left:0; right:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      z-index:20;
      font-weight:800;
    }
    header .left{display:flex; align-items:center; gap:10px;}
    header .icon-btn{
      width:40px; height:40px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    header .icon-btn:hover{ background:rgba(127,127,127,.12); }

    main{
      padding:72px 14px 88px;
      max-width:640px; margin:0 auto;
    }

    nav{
      position:fixed; bottom:0; left:0; right:0;
      display:flex; justify-content:space-around; align-items:center;
      padding:10px 0;
      background:var(--bg);
      border-top:1px solid var(--border);
      z-index:20;
    }
    nav .tab{
      width:25%;
      display:flex; flex-direction:column; align-items:center;
      gap:6px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      padding:6px 0;
    }
    nav .tab.active{ color:var(--accent); }
    nav i{ font-size:20px; }

    .hidden{ display:none !important; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
    }

    textarea, input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }

    button{
      border:none;
      background:var(--accent);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
    }
    button.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    button.danger{ background:var(--danger); }
    button.good{ background:var(--good); }

    .row{ display:flex; gap:10px; align-items:center; }
    .space{ flex:1; }

    .avatar{
      width:42px; height:42px;
      border-radius:999px;
      background:#666;
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      font-weight:800;
    }
    .post-image{
      margin-top:10px;
      max-width:100%;
      border-radius:14px;
      border:1px solid var(--border);
    }

    .muted{ color:var(--muted); font-size:13px; }
    .click{ cursor:pointer; }
    .click:hover{ text-decoration:underline; }

    .post-actions{
      display:flex; gap:18px;
      margin-top:10px;
      color:var(--muted);
      user-select:none;
    }
    .post-actions span{ cursor:pointer; }
    .post-actions span:hover{ color:var(--text); }

    .comment{
      display:flex; gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--border);
    }
    .comment .avatar{ width:34px; height:34px; font-size:14px; }

    /* Drawer */
    .drawer-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      z-index:50;
      display:none;
    }
    .drawer-backdrop.show{ display:block; }

    .drawer{
      position:fixed; top:0; left:-320px;
      width:300px; height:100%;
      background:var(--bg);
      border-right:1px solid var(--border);
      z-index:60;
      padding:14px;
      transition:left .2s ease;
    }
    .drawer.show{ left:0; }

    .drawer h3{ margin:6px 0 10px; }
    .drawer .item{
      padding:12px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex; gap:10px; align-items:center;
    }
    .drawer .item:hover{ background:rgba(127,127,127,.12); }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      z-index:80;
      padding:14px;
    }
    .modal.show{ display:flex; }
    .modal .box{
      width:100%;
      max-width:420px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
    }

    /* List modal */
    .list-item{
      padding:12px;
      border-radius:12px;
      cursor:pointer;
      border:1px solid var(--border);
      background:var(--bg);
      margin-bottom:10px;
    }
    .list-item:hover{ background:rgba(127,127,127,.12); }

    /* Settings pages */
    .settings-title{
      font-size:18px; font-weight:900;
      margin:0 0 10px;
    }
    .settings-row{
      display:flex; align-items:center; gap:10px;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--bg);
      cursor:pointer;
      margin-bottom:10px;
    }
    .settings-row:hover{ background:rgba(127,127,127,.12); }
    .settings-row i{ width:20px; text-align:center; color:var(--muted); }
    .settings-row .right{ margin-left:auto; color:var(--muted); }

    .top-back{
      display:flex; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .top-back .backbtn{
      width:40px; height:40px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .top-back .backbtn:hover{ background:rgba(127,127,127,.12); }

  </style>
</head>

<body>

<header>
  <div class="left">
    <div class="icon-btn" onclick="openDrawer()"><i class="fa-solid fa-bars"></i></div>
    <div id="headerTitle">EchoStream</div>
  </div>
  <div class="icon-btn" onclick="route('settings')"><i class="fa-solid fa-gear"></i></div>
</header>

<!-- Drawer -->
<div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
<div id="drawer" class="drawer">
  <div class="row">
    <div style="font-weight:900;">Menu</div>
    <div class="space"></div>
    <div class="icon-btn" onclick="closeDrawer()"><i class="fa-solid fa-xmark"></i></div>
  </div>
  <div style="height:8px;"></div>
  <div class="item" onclick="route('feed'); closeDrawer();"><i class="fa-solid fa-house"></i> Feed</div>
  <div class="item" onclick="route('search'); closeDrawer();"><i class="fa-solid fa-magnifying-glass"></i> Search</div>
  <div class="item" onclick="route('messages'); closeDrawer();"><i class="fa-solid fa-message"></i> Messages</div>
  <div class="item" onclick="route('profile'); closeDrawer();"><i class="fa-solid fa-user"></i> Profile</div>
  <div class="item" onclick="route('settings'); closeDrawer();"><i class="fa-solid fa-gear"></i> Settings</div>
</div>

<main>

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <h2 style="margin:0 0 8px;">Welcome to EchoStream</h2>
    <p class="muted" style="margin:0 0 12px;">Sign in to post, follow, message, and search.</p>
    <button onclick="login()">Sign in with Google</button>
  </div>

  <!-- FEED -->
  <div id="feedView" class="hidden">
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Post</div>
      <textarea id="postText" placeholder="What’s happening?"></textarea>

      <div style="height:10px;"></div>
      <input id="postImage" type="file" accept="image/*"/>

      <div class="row" style="margin-top:10px;">
        <button onclick="createPost()">Post</button>
        <div class="space"></div>
        <span class="muted" id="postStatus"></span>
      </div>
    </div>

    <div id="posts"></div>
  </div>

  <!-- SEARCH -->
  <div id="searchView" class="hidden">
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Search users</div>
      <input id="searchInput" placeholder="Search by username..." oninput="doSearch()"/>
    </div>
    <div id="searchResults"></div>
  </div>

  <!-- MESSAGES -->
  <div id="messagesView" class="hidden">
    <div class="card">
      <div class="row">
        <div style="font-weight:800;">Chat</div>
        <div class="space"></div>
        <button class="secondary" onclick="setChatAI()">EchoBot</button>
      </div>
      <div class="muted" id="chatWith" style="margin-top:6px;">Chatting with: EchoBot</div>
    </div>

    <div class="card" style="padding:10px;">
      <div id="chatBox" style="height:320px; overflow:auto;"></div>
    </div>

    <div class="card">
      <input id="chatInput" placeholder="Type a message..."/>
      <div class="row" style="margin-top:10px;">
        <button onclick="sendMessage()">Send</button>
        <div class="space"></div>
        <span class="muted" id="msgStatus"></span>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profileView" class="hidden"></div>

  <!-- SETTINGS ROOT -->
  <div id="settingsView" class="hidden"></div>

</main>

<!-- Bottom Nav -->
<nav>
  <div class="tab" id="tab-feed" onclick="route('feed')">
    <i class="fa-solid fa-house"></i><div class="muted" style="font-size:12px;">Feed</div>
  </div>
  <div class="tab" id="tab-search" onclick="route('search')">
    <i class="fa-solid fa-magnifying-glass"></i><div class="muted" style="font-size:12px;">Search</div>
  </div>
  <div class="tab" id="tab-messages" onclick="route('messages')">
    <i class="fa-solid fa-message"></i><div class="muted" style="font-size:12px;">Messages</div>
  </div>
  <div class="tab" id="tab-profile" onclick="route('profile')">
    <i class="fa-solid fa-user"></i><div class="muted" style="font-size:12px;">Profile</div>
  </div>
</nav>

<!-- Username Modal -->
<div id="usernameModal" class="modal">
  <div class="box">
    <h3 style="margin:0 0 8px;">Pick a username</h3>
    <p class="muted" style="margin:0 0 12px;">Unique, lowercase letters/numbers/underscore only.</p>
    <input id="usernameInput" placeholder="username" maxlength="20"/>
    <div class="row" style="margin-top:12px;">
      <button onclick="saveUsernameFromModal()">Save</button>
      <div class="space"></div>
      <span class="muted" id="usernameStatus"></span>
    </div>
  </div>
</div>

<!-- Followers/Following Modal -->
<div id="listModal" class="modal">
  <div class="box">
    <div class="row" style="align-items:center;">
      <div style="font-weight:900;" id="listTitle">List</div>
      <div class="space"></div>
      <div class="icon-btn" onclick="closeListModal()"><i class="fa-solid fa-xmark"></i></div>
    </div>
    <div style="height:8px;"></div>
    <div id="listBody" class="muted">Loading...</div>
  </div>
</div>

<script>
  // =========================
  // FIREBASE CONFIG (yours)
  // =========================
  firebase.initializeApp({
    apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
    authDomain: "echostream-a102a.firebaseapp.com",
    projectId: "echostream-a102a",
    storageBucket: "echostream-a102a.appspot.com",
    messagingSenderId: "789062222400",
    appId: "1:789062222400:web:73d478269135a77d7d55a5"
  });

  const auth = firebase.auth();
  const db = firebase.firestore();

  let storage = null;
  try { storage = firebase.storage(); } catch(e) { storage = null; }

  let currentUser = null;
  let userData = null;
  let isAdminUser = false;

  // messaging
  let activeChatUid = "AI";
  let chatUnsub = null;

  // feed
  let feedUnsub = null;

  // =========================
  // helpers
  // =========================
  function openDrawer(){
    document.getElementById("drawerBackdrop").classList.add("show");
    document.getElementById("drawer").classList.add("show");
  }
  function closeDrawer(){
    document.getElementById("drawerBackdrop").classList.remove("show");
    document.getElementById("drawer").classList.remove("show");
  }

  function setHeader(title){
    document.getElementById("headerTitle").textContent = title || "EchoStream";
  }

  function setActiveTab(page){
    ["feed","search","messages","profile"].forEach(p=>{
      const el = document.getElementById("tab-"+p);
      if (!el) return;
      el.classList.toggle("active", p===page);
    });
  }

  function showView(id){
    const views = ["loginView","feedView","searchView","messagesView","profileView","settingsView"];
    views.forEach(v => document.getElementById(v).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  function safeString(x, fallback=""){
    return (typeof x === "string" && x.trim().length) ? x : fallback;
  }
  function safeArray(x){
    return Array.isArray(x) ? x : [];
  }
  function initialLetter(name){
    const s = safeString(name, "?");
    return (s[0] ? s[0].toUpperCase() : "?");
  }
  function timeAgo(ts){
    if (!ts || !ts.toDate) return "now";
    const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
    if (seconds < 60) return seconds + "s";
    if (seconds < 3600) return Math.floor(seconds/60) + "m";
    if (seconds < 86400) return Math.floor(seconds/3600) + "h";
    return Math.floor(seconds/86400) + "d";
  }

  // =========================
  // AUTH
  // =========================
  function login(){
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }
  function logout(){
    auth.signOut().then(()=>location.reload());
  }

  async function checkAdmin(uid){
    try{
      const snap = await db.collection("admins").doc(uid).get();
      return snap.exists;
    } catch(e){
      return false;
    }
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user){
      currentUser = null;
      userData = null;
      isAdminUser = false;
      showView("loginView");
      setHeader("EchoStream");
      return;
    }

    currentUser = user;
    showView("feedView");
    setActiveTab("feed");
    setHeader("EchoStream");

    // Check admin (safe)
    isAdminUser = await checkAdmin(user.uid);

    // Load or create user doc
    const userRef = db.collection("users").doc(user.uid);
    const snap = await userRef.get();

    if (!snap.exists){
      const auto = safeString(user.displayName, "user").replace(/\s/g,"").toLowerCase();
      await userRef.set({
        username: auto,
        followers: [],
        following: []
      });
      userData = { username: auto, followers: [], following: [] };
      document.getElementById("usernameInput").value = auto;
      document.getElementById("usernameModal").classList.add("show");
    } else {
      userData = snap.data() || {};
      if (!userData.username){
        userData.username = safeString(user.displayName, "user").replace(/\s/g,"").toLowerCase();
        await userRef.update({ username: userData.username });
      }
    }

    // dark mode init
    const dark = localStorage.getItem("darkMode") === "true";
    document.body.classList.toggle("dark", dark);

    // start feed + chat
    startFeedListener();
    setChatAI();
  });

  // =========================
  // ROUTING
  // =========================
  function route(page){
    if (!currentUser){
      showView("loginView");
      return;
    }

    closeDrawer();

    if (page === "feed"){
      setHeader("EchoStream");
      showView("feedView");
      setActiveTab("feed");
      startFeedListener();
      return;
    }
    if (page === "search"){
      setHeader("Search");
      showView("searchView");
      setActiveTab("search");
      document.getElementById("searchInput").value = "";
      document.getElementById("searchResults").innerHTML = "";
      return;
    }
    if (page === "messages"){
      setHeader("Messages");
      showView("messagesView");
      setActiveTab("messages");
      ensureChatListener();
      return;
    }
    if (page === "profile"){
      setHeader("Profile");
      showView("profileView");
      setActiveTab("profile");
      openProfile(currentUser.uid);
      return;
    }
    if (page === "settings"){
      setHeader("Settings");
      showView("settingsView");
      renderSettingsHome();
      return;
    }
  }

  // =========================
  // USERNAME (unique)
  // =========================
  async function saveUsername(name){
    name = safeString(name, "").toLowerCase().trim();

    if (name.length < 3) throw new Error("Too short (min 3).");
    if (!/^[a-z0-9_]+$/.test(name)) throw new Error("Only a-z 0-9 _");

    // unique
    const taken = await db.collection("users").where("username","==",name).limit(1).get();
    if (!taken.empty && taken.docs[0].id !== currentUser.uid){
      throw new Error("Username taken.");
    }

    await db.collection("users").doc(currentUser.uid).update({ username: name });
    userData.username = name;
  }

  async function saveUsernameFromModal(){
    const status = document.getElementById("usernameStatus");
    status.textContent = "";
    try{
      await saveUsername(document.getElementById("usernameInput").value);
      document.getElementById("usernameModal").classList.remove("show");
    } catch(e){
      status.textContent = e.message || String(e);
    }
  }

  // =========================
  // POSTS
  // =========================
  async function createPost(){
    const status = document.getElementById("postStatus");
    status.textContent = "";

    const text = safeString(document.getElementById("postText").value, "").trim();
    const file = document.getElementById("postImage").files[0];

    if (!text && !file){
      status.textContent = "Write something first.";
      return;
    }

    let imageUrl = "";

    if (file && storage){
      try{
        const path = `posts/${currentUser.uid}/${Date.now()}_${file.name}`;
        const ref = storage.ref(path);
        await ref.put(file);
        imageUrl = await ref.getDownloadURL();
      } catch(e){
        console.warn("Storage upload skipped:", e);
      }
    }

    const uname = safeString(userData?.username, "user");

    await db.collection("posts").add({
      uid: currentUser.uid,
      username: uname,
      text: text,
      imageUrl: imageUrl,
      likes: [],
      comments: [],
      shares: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("postText").value = "";
    document.getElementById("postImage").value = "";
    status.textContent = "Posted.";
    setTimeout(()=>status.textContent="", 1200);
  }

  function renderPost(doc){
    const post = doc.data() || {};
    const postId = doc.id;

    const username = safeString(post.username, "user");
    const likes = safeArray(post.likes);
    const comments = safeArray(post.comments);
    const shares = safeArray(post.shares);
    const liked = likes.includes(currentUser.uid);

    const avatar = initialLetter(username);
    const img = safeString(post.imageUrl, "");

    let commentsHtml = "";
    for (const c of comments){
      const cu = safeString(c.username, "user");
      const ct = safeString(c.text, "");
      commentsHtml += `
        <div class="comment">
          <div class="avatar">${initialLetter(cu)}</div>
          <div style="flex:1;">
            <div style="font-weight:800;">${escapeHtml(cu)}</div>
            <div class="muted">${escapeHtml(ct)}</div>
          </div>
        </div>
      `;
    }

    return `
      <div class="card">
        <div class="row">
          <div class="avatar">${avatar}</div>
          <div style="flex:1;">
            <div style="font-weight:900;">
              <span class="click" onclick="openProfile('${post.uid}')">${escapeHtml(username)}</span>
            </div>
            <div class="muted">${timeAgo(post.timestamp)}</div>
          </div>
        </div>

        ${post.text ? `<div style="margin-top:10px;">${escapeHtml(post.text)}</div>` : ""}

        ${img ? `<img class="post-image" src="${escapeAttr(img)}" alt="post image"/>` : ""}

        <div class="post-actions">
          <span onclick="toggleLike('${postId}')">
            <i class="${liked ? "fa-solid" : "fa-regular"} fa-heart"></i> ${likes.length}
          </span>
          <span onclick="toggleComments('${postId}')">
            <i class="fa-regular fa-comment"></i> ${comments.length}
          </span>
          <span onclick="sharePost('${postId}')">
            <i class="fa-solid fa-retweet"></i> ${shares.length}
          </span>
        </div>

        <div id="comments-${postId}" class="hidden" style="margin-top:12px;">
          ${commentsHtml}
          <div style="height:10px;"></div>
          <input id="commentInput-${postId}" placeholder="Write a comment..."/>
          <div class="row" style="margin-top:10px;">
            <button onclick="addComment('${postId}')">Send</button>
            <div class="space"></div>
          </div>
        </div>
      </div>
    `;
  }

  function startFeedListener(){
    if (feedUnsub) return;
    const postsDiv = document.getElementById("posts");
    postsDiv.innerHTML = `<div class="muted">Loading feed...</div>`;

    feedUnsub = db.collection("posts")
      .orderBy("timestamp","desc")
      .onSnapshot((snap)=>{
        let html = "";
        snap.forEach(doc => { html += renderPost(doc); });
        postsDiv.innerHTML = html || `<div class="muted">No posts yet.</div>`;
      }, (err)=>{
        console.error("Feed listen error:", err);
        postsDiv.innerHTML = `<div class="muted">Feed error: ${escapeHtml(err.message || String(err))}</div>`;
      });
  }

  async function toggleLike(postId){
    const ref = db.collection("posts").doc(postId);
    const snap = await ref.get();
    const data = snap.data() || {};
    let likes = safeArray(data.likes);

    if (likes.includes(currentUser.uid)){
      likes = likes.filter(x => x !== currentUser.uid);
    } else {
      likes.push(currentUser.uid);
    }
    await ref.update({ likes: likes });
  }

  function toggleComments(postId){
    const el = document.getElementById(`comments-${postId}`);
    if (!el) return;
    el.classList.toggle("hidden");
  }

  async function addComment(postId){
    const input = document.getElementById(`commentInput-${postId}`);
    if (!input) return;
    const text = safeString(input.value, "").trim();
    if (!text) return;

    const comment = {
      uid: currentUser.uid,
      username: safeString(userData?.username, "user"),
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("posts").doc(postId).update({
      comments: firebase.firestore.FieldValue.arrayUnion(comment)
    });

    input.value = "";
  }

  async function sharePost(postId){
    await db.collection("posts").doc(postId).update({
      shares: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });
  }

  // =========================
  // PROFILES + FOLLOWERS LIST
  // =========================
  function openListModal(title){
    document.getElementById("listTitle").textContent = title;
    document.getElementById("listBody").innerHTML = `<div class="muted">Loading...</div>`;
    document.getElementById("listModal").classList.add("show");
  }
  function closeListModal(){
    document.getElementById("listModal").classList.remove("show");
  }

  async function showUserIdList(title, uidList){
    openListModal(title);
    const body = document.getElementById("listBody");

    const ids = safeArray(uidList);
    if (!ids.length){
      body.innerHTML = `<div class="muted">No users.</div>`;
      return;
    }

    // Firestore "in" supports up to 10
    const chunks = [];
    for (let i=0;i<ids.length;i+=10) chunks.push(ids.slice(i,i+10));

    let users = [];
    for (const chunk of chunks){
      const snap = await db.collection("users").where(firebase.firestore.FieldPath.documentId(), "in", chunk).get();
      snap.forEach(d=>{
        const u = d.data() || {};
        users.push({ uid: d.id, username: safeString(u.username, d.id) });
      });
    }

    // Keep original order
    const map = new Map(users.map(u => [u.uid, u]));
    const ordered = ids.map(id => map.get(id)).filter(Boolean);

    body.innerHTML = ordered.map(u => `
      <div class="list-item" onclick="closeListModal(); openProfile('${u.uid}')">
        <div class="row">
          <div class="avatar">${initialLetter(u.username)}</div>
          <div style="flex:1;">
            <div style="font-weight:900;">${escapeHtml(u.username)}</div>
            <div class="muted">${escapeHtml(u.uid)}</div>
          </div>
        </div>
      </div>
    `).join("");
  }

  async function openProfile(uid){
    setHeader("Profile");
    showView("profileView");
    setActiveTab("profile");

    const profile = document.getElementById("profileView");
    profile.innerHTML = `<div class="muted">Loading profile...</div>`;

    try{
      const userSnap = await db.collection("users").doc(uid).get();
      if (!userSnap.exists){
        profile.innerHTML = `<div class="card">User not found.</div>`;
        return;
      }

      const u = userSnap.data() || {};
      const username = safeString(u.username, "user");
      const followers = safeArray(u.followers);
      const following = safeArray(u.following);

      const isMe = uid === currentUser.uid;
      const iFollow = followers.includes(currentUser.uid);

      let postsHtml = "";
      const postsSnap = await db.collection("posts")
        .where("uid","==",uid)
        .orderBy("timestamp","desc")
        .get();

      postsSnap.forEach(doc=>{
        const p = doc.data() || {};
        const txt = safeString(p.text, "");
        const img = safeString(p.imageUrl, "");
        postsHtml += `
          <div class="card">
            ${txt ? `<div>${escapeHtml(txt)}</div>` : ""}
            ${img ? `<img class="post-image" src="${escapeAttr(img)}" alt="post image"/>` : ""}
            <div class="muted" style="margin-top:8px;">${timeAgo(p.timestamp)}</div>
          </div>
        `;
      });

      profile.innerHTML = `
        <div class="card" style="text-align:center;">
          <div class="avatar" style="width:64px;height:64px;margin:0 auto;font-size:24px;">${initialLetter(username)}</div>
          <div style="margin-top:10px; font-size:20px; font-weight:900;">${escapeHtml(username)}</div>
          <div class="muted">UID: ${escapeHtml(uid)}</div>

          <div class="row" style="justify-content:center; gap:18px; margin-top:12px;">
            <div class="click" onclick="showUserIdList('Followers', ${escapeAttr(JSON.stringify(followers))})">
              <div style="font-weight:900;">${followers.length}</div>
              <div class="muted">Followers</div>
            </div>
            <div class="click" onclick="showUserIdList('Following', ${escapeAttr(JSON.stringify(following))})">
              <div style="font-weight:900;">${following.length}</div>
              <div class="muted">Following</div>
            </div>
          </div>

          ${isMe ? "" : `
            <div style="margin-top:12px;">
              <button onclick="toggleFollow('${uid}')">${iFollow ? "Unfollow" : "Follow"}</button>
              <button class="secondary" style="margin-left:8px;" onclick="startChatWith('${uid}','${escapeAttr(username)}')">Message</button>
            </div>
          `}
        </div>

        <div style="font-weight:900; margin:10px 0 8px;">Posts</div>
        ${postsHtml || `<div class="muted">No posts yet.</div>`}
      `;
    } catch(e){
      console.error(e);
      profile.innerHTML = `<div class="card">Profile error: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  async function toggleFollow(targetUid){
    const meUid = currentUser.uid;

    const myRef = db.collection("users").doc(meUid);
    const targetRef = db.collection("users").doc(targetUid);

    const [mySnap, targetSnap] = await Promise.all([myRef.get(), targetRef.get()]);
    const my = mySnap.data() || {};
    const t = targetSnap.data() || {};

    let following = safeArray(my.following);
    let followers = safeArray(t.followers);

    const iAlreadyFollow = following.includes(targetUid);

    if (iAlreadyFollow){
      following = following.filter(x => x !== targetUid);
      followers = followers.filter(x => x !== meUid);
    } else {
      following.push(targetUid);
      followers.push(meUid);
    }

    await Promise.all([
      myRef.update({ following }),
      targetRef.update({ followers })
    ]);

    openProfile(targetUid);
  }

  // =========================
  // SEARCH (prefix on username)
  // =========================
  let searchTimer = null;
  function doSearch(){
    clearTimeout(searchTimer);
    searchTimer = setTimeout(runSearch, 200);
  }

  async function runSearch(){
    const q = safeString(document.getElementById("searchInput").value, "").toLowerCase().trim();
    const res = document.getElementById("searchResults");

    if (!q){
      res.innerHTML = "";
      return;
    }

    res.innerHTML = `<div class="muted">Searching...</div>`;

    try{
      const snap = await db.collection("users")
        .orderBy("username")
        .startAt(q)
        .endAt(q + "\uf8ff")
        .limit(20)
        .get();

      let html = "";
      snap.forEach(doc=>{
        const u = doc.data() || {};
        const uname = safeString(u.username, "");
        if (!uname) return;

        html += `
          <div class="card">
            <div class="row">
              <div class="avatar">${initialLetter(uname)}</div>
              <div style="flex:1;">
                <div style="font-weight:900;" class="click" onclick="openProfile('${doc.id}')">${escapeHtml(uname)}</div>
                <div class="muted">${escapeHtml(doc.id)}</div>
              </div>
              <button class="secondary" onclick="startChatWith('${doc.id}','${escapeAttr(uname)}')">Message</button>
            </div>
          </div>
        `;
      });

      res.innerHTML = html || `<div class="muted">No matches.</div>`;
    } catch(e){
      console.error(e);
      res.innerHTML = `<div class="card">Search error: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  // =========================
  // MESSAGES
  // =========================
  function chatId(a,b){
    return (a < b) ? `${a}_${b}` : `${b}_${a}`;
  }

  function setChatAI(){
    activeChatUid = "AI";
    document.getElementById("chatWith").textContent = "Chatting with: EchoBot";
    ensureChatListener();
  }

  function startChatWith(uid, username){
    activeChatUid = uid;
    document.getElementById("chatWith").textContent = "Chatting with: " + safeString(username, uid);
    route("messages");
    ensureChatListener();
  }

  function ensureChatListener(){
    if (!currentUser) return;

    if (chatUnsub){
      chatUnsub();
      chatUnsub = null;
    }

    const me = currentUser.uid;
    const other = activeChatUid === "AI" ? "AI" : activeChatUid;
    const cid = chatId(me, other);

    const box = document.getElementById("chatBox");
    box.innerHTML = `<div class="muted">Loading chat...</div>`;

    chatUnsub = db.collection("messages")
      .doc(cid)
      .collection("messages")
      .orderBy("timestamp","asc")
      .limit(200)
      .onSnapshot((snap)=>{
        let html = "";
        snap.forEach(doc=>{
          const m = doc.data() || {};
          const uname = safeString(m.username, m.uid === "AI" ? "EchoBot" : "user");
          const text = safeString(m.text, "");
          const mine = m.uid === currentUser.uid;

          html += `
            <div class="card" style="margin:8px 0; padding:10px; border-radius:14px; ${mine ? "border-color: rgba(29,161,242,.6);" : ""}">
              <div style="font-weight:900;">${escapeHtml(uname)}</div>
              <div>${escapeHtml(text)}</div>
            </div>
          `;
        });
        box.innerHTML = html || `<div class="muted">No messages yet.</div>`;
        box.scrollTop = box.scrollHeight;
      }, (err)=>{
        console.error("Chat listen error:", err);
        box.innerHTML = `<div class="card">Chat error: ${escapeHtml(err.message || String(err))}</div>`;
      });
  }

  // Send on Enter
  document.addEventListener("keydown", (e)=>{
    const active = document.activeElement;
    if (active && active.id === "chatInput" && e.key === "Enter"){
      e.preventDefault();
      sendMessage();
    }
  });

  let aiCooldown = 0;

  async function sendMessage(){
    const status = document.getElementById("msgStatus");
    status.textContent = "";

    const input = document.getElementById("chatInput");
    const text = safeString(input.value, "").trim();
    if (!text) return;

    const me = currentUser.uid;
    const other = activeChatUid === "AI" ? "AI" : activeChatUid;
    const cid = chatId(me, other);

    try{
      await db.collection("messages")
        .doc(cid)
        .collection("messages")
        .add({
          uid: me,
          username: safeString(userData?.username, "user"),
          text: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

      input.value = "";

      if (other === "AI"){
        const now = Date.now();
        if (now > aiCooldown){
          aiCooldown = now + 800; // avoid duplicates
          aiReply(cid, text);
        }
      }
    } catch(e){
      console.error(e);
      status.textContent = "Send failed: " + (e.message || String(e));
    }
  }

  async function aiReply(cid, userText){
    const t = (userText || "").toLowerCase();
    let msg = "Tell me more.";

    if (t.includes("hi") || t.includes("hello")) msg = "Hey! What are you up to today?";
    else if (t.includes("help")) msg = "What do you want help with in EchoStream?";
    else if (t.includes("joke")) msg = "Why did the dev go broke? Because he used up all his cache.";
    else if (t.includes("bye")) msg = "Bye! Come back anytime.";

    setTimeout(async ()=>{
      try{
        await db.collection("messages")
          .doc(cid)
          .collection("messages")
          .add({
            uid: "AI",
            username: "EchoBot",
            text: msg,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
      } catch(e){
        console.warn("AI reply failed:", e);
      }
    }, 450);
  }

  // =========================
  // SETTINGS (like X)
  // =========================
  function renderSettingsHome(){
    const root = document.getElementById("settingsView");

    const uname = safeString(userData?.username, "user");
    const uid = safeString(currentUser?.uid, "");
    const email = safeString(currentUser?.email, "");

    const dark = localStorage.getItem("darkMode") === "true";

    root.innerHTML = `
      <div class="card">
        <div class="row">
          <div class="avatar">${initialLetter(uname)}</div>
          <div style="flex:1;">
            <div style="font-weight:900; font-size:16px;">${escapeHtml(uname)}</div>
            <div class="muted">${escapeHtml(email || uid)}</div>
          </div>
        </div>
      </div>

      <div class="settings-row" onclick="renderAccountInfo()">
        <i class="fa-regular fa-user"></i>
        <div>
          <div style="font-weight:900;">Your account</div>
          <div class="muted">Account information, username, admin</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      <div class="settings-row" onclick="renderPrivacy()">
        <i class="fa-solid fa-shield-halved"></i>
        <div>
          <div style="font-weight:900;">Privacy & safety</div>
          <div class="muted">Basic privacy options</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      <div class="card">
        <div class="row" style="align-items:center;">
          <div style="font-weight:900;">Dark mode</div>
          <div class="space"></div>
          <input type="checkbox" id="darkToggle" style="width:auto;" ${dark ? "checked" : ""}/>
        </div>
        <div class="muted" style="margin-top:8px;">Toggle theme for this device.</div>
      </div>

      <div class="card">
        <button class="danger" onclick="logout()">Logout</button>
      </div>
    `;

    document.getElementById("darkToggle").addEventListener("change", (e)=>{
      const v = !!e.target.checked;
      document.body.classList.toggle("dark", v);
      localStorage.setItem("darkMode", String(v));
    });
  }

  function settingsBack(){
    renderSettingsHome();
  }

  function renderAccountInfo(){
    const root = document.getElementById("settingsView");

    const uname = safeString(userData?.username, "user");
    const uid = safeString(currentUser?.uid, "");
    const email = safeString(currentUser?.email, "");

    root.innerHTML = `
      <div class="top-back">
        <div class="backbtn" onclick="settingsBack()"><i class="fa-solid fa-arrow-left"></i></div>
        <div class="settings-title">Your account</div>
      </div>

      <div class="card">
        <div style="font-weight:900; margin-bottom:6px;">Account information</div>
        <div class="muted">Username</div>
        <div style="font-weight:900; margin-bottom:10px;">@${escapeHtml(uname)}</div>

        <div class="muted">Email</div>
        <div style="font-weight:900; margin-bottom:10px;">${escapeHtml(email || "—")}</div>

        <div class="muted">UID</div>
        <div style="font-weight:900; word-break:break-all;">${escapeHtml(uid)}</div>
      </div>

      <div class="settings-row" onclick="renderChangeUsername()">
        <i class="fa-solid fa-at"></i>
        <div>
          <div style="font-weight:900;">Change username</div>
          <div class="muted">Pick a new unique username</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      ${isAdminUser ? `
        <div class="settings-row" onclick="renderAdminPanel()">
          <i class="fa-solid fa-user-shield"></i>
          <div>
            <div style="font-weight:900;">Admin settings</div>
            <div class="muted">Admin-only tools</div>
          </div>
          <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
      ` : `
        <div class="card">
          <div class="muted">Admin settings will appear here after you create <b>/admins/${escapeHtml(uid)}</b> in Firestore.</div>
        </div>
      `}
    `;
  }

  function renderChangeUsername(){
    const root = document.getElementById("settingsView");
    const current = safeString(userData?.username, "user");

    root.innerHTML = `
      <div class="top-back">
        <div class="backbtn" onclick="renderAccountInfo()"><i class="fa-solid fa-arrow-left"></i></div>
        <div class="settings-title">Change username</div>
      </div>

      <div class="card">
        <div class="muted" style="margin-bottom:8px;">New username</div>
        <input id="newUsername" maxlength="20" value="${escapeAttr(current)}" />
        <div class="muted" style="margin-top:10px;">Use lowercase letters, numbers, underscore.</div>
        <div class="row" style="margin-top:12px;">
          <button class="good" onclick="saveUsernameFromSettings()">Save</button>
          <div class="space"></div>
          <span class="muted" id="unameSaveStatus"></span>
        </div>
      </div>
    `;
  }

  async function saveUsernameFromSettings(){
    const status = document.getElementById("unameSaveStatus");
    status.textContent = "";
    try{
      await saveUsername(document.getElementById("newUsername").value);
      status.textContent = "Saved!";
      setTimeout(()=>renderAccountInfo(), 650);
    } catch(e){
      status.textContent = e.message || String(e);
    }
  }

  function renderPrivacy(){
    const root = document.getElementById("settingsView");
    root.innerHTML = `
      <div class="top-back">
        <div class="backbtn" onclick="renderSettingsHome()"><i class="fa-solid fa-arrow-left"></i></div>
        <div class="settings-title">Privacy & safety</div>
      </div>

      <div class="card">
        <div style="font-weight:900; margin-bottom:6px;">Basic privacy</div>
        <div class="muted">This is a simple demo page. We can add blocks/mutes later.</div>
      </div>
    `;
  }

  function renderAdminPanel(){
    const root = document.getElementById("settingsView");
    root.innerHTML = `
      <div class="top-back">
        <div class="backbtn" onclick="renderAccountInfo()"><i class="fa-solid fa-arrow-left"></i></div>
        <div class="settings-title">Admin settings</div>
      </div>

      <div class="card">
        <div style="font-weight:900; margin-bottom:8px;">Admin tools</div>
        <div class="muted">You are marked as admin because /admins/${escapeHtml(currentUser.uid)} exists.</div>
      </div>

      <div class="card">
        <div style="font-weight:900; margin-bottom:8px;">Quick checks</div>
        <button class="secondary" onclick="alert('Admin ok ✅')">Test admin</button>
      </div>
    `;
  }

  // =========================
  // HTML escaping
  // =========================
  function escapeHtml(str){
    str = String(str ?? "");
    return str
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return escapeHtml(str);
  }
</script>

</body>
</html>