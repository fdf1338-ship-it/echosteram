<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoStream</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #fff; --text: #000; --card: #fff; --border: #ddd; --accent: #1da1f2; --red: #ff0000; }
        body.dark { --bg: #000; --text: #fff; --card: #1a1a1a; --border: #333; }
        body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); transition:0.3s; }
        .container { max-width:600px; margin:0 auto; text-align:center; padding-top:100px; }
        h1 { font-size:48px; margin:0; }
        .tagline { color:var(--red); font-size:16px; margin:15px 0 30px; font-weight:600; }
        button { padding:12px 28px; background:var(--accent); color:white; border:none; border-radius:999px; cursor:pointer; font-size:16px; font-weight:600; }
        button:hover { opacity:0.9; }
        #app { display:none; }
        .header { position:fixed; top:0; left:0; right:0; background:var(--bg); border-bottom:1px solid var(--border); padding:10px 16px; display:flex; justify-content:space-between; align-items:center; z-index:10; }
        .logo { width:40px; height:40px; animation: pulse 66s infinite linear; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
        .avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; background:#ccc; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:bold; color:white; }
        .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--bg); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:8px 0; z-index:10; }
        .nav-item { font-size:26px; color:#666; cursor:pointer; }
        .nav-item.active { color:var(--accent); }
        .post-box { margin:70px 20px 80px; }
        textarea { width:100%; min-height:100px; padding:16px; border:1px solid var(--border); border-radius:16px; background:var(--card); color:var(--text); font-size:16px; resize:none; }
        .feed { padding-bottom:100px; }
        .post { background:var(--card); margin:12px 20px; padding:16px; border-radius:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .post-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .post-user { display:flex; align-items:center; gap:8px; }
        .username { font-weight:600; }
        .verified { color:var(--accent); }
        .time { font-size:14px; color:#666; margin-left:auto; }
        .post-text { margin:8px 0 16px; white-space:pre-wrap; font-size:16px; line-height:1.5; }
        .post-actions { display:flex; justify-content:space-around; font-size:20px; color:#666; }
        .action { cursor:pointer; display:flex; align-items:center; gap:6px; }
        .action.liked { color:#e0245e; }
        .action-count { font-size:14px; }
        .comments-section { margin-top:16px; padding-top:12px; border-top:1px solid var(--border); }
        .comment { display:flex; gap:12px; margin-top:12px; }
        .comment-avatar { width:32px; height:32px; border-radius:50%; background:#ccc; flex-shrink:0; }
        .comment-body { flex:1; }
        .comment-input { width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card); color:var(--text); margin-top:8px; }
        #settings-sidebar { position:fixed; top:0; bottom:0; right:-320px; width:320px; background:var(--card); box-shadow:-4px 0 16px rgba(0,0,0,0.2); transition:right 0.3s; z-index:20; padding:20px; overflow-y:auto; }
        #settings-sidebar.open { right:0; }
        .settings-header { font-size:20px; font-weight:bold; margin-bottom:20px; }
        .settings-item { padding:16px 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .switch { position:relative; display:inline-block; width:52px; height:32px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#ccc; transition:0.4s; border-radius:34px; }
        .slider:before { position:absolute; content:""; height:26px; width:26px; left:3px; bottom:3px; background:white; transition:0.4s; border-radius:50%; }
        input:checked + .slider { background:var(--accent); }
        input:checked + .slider:before { transform:translateX(20px); }
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:30; }
        .modal-content { background:var(--card); padding:32px; border-radius:16px; width:90%; max-width:400px; text-align:center; }
        #messages-view, #profile-view { display:none; padding:20px; margin-top:70px; }
    </style>
</head>
<body>
    <div id="login-screen" class="container">
        <h1>EchoStream</h1>
        <p class="tagline">The feed they don't want you seeing.</p>
        <button id="google-signin">Sign in with Google</button>
    </div>

    <div id="app">
        <div class="header">
            <svg class="logo" viewBox="0 0 32 32">
                <circle cx="16" cy="16" r="14" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="16" cy="16" r="4" fill="var(--red)"/>
            </svg>
            <i class="fas fa-cog" style="font-size:26px;cursor:pointer;" onclick="toggleSettings()"></i>
        </div>

        <div class="post-box">
            <textarea id="post-text" placeholder="What's happening?"></textarea>
            <button onclick="createPost()">Post</button>
        </div>

        <div class="feed" id="feed"></div>

        <div id="messages-view">
            <h2>Messages</h2>
            <div id="dm-list"></div>
        </div>

        <div id="profile-view">
            <h2>Profile</h2>
            <div id="profile-content"></div>
        </div>

        <div class="bottom-nav">
            <i class="fas fa-home nav-item active" onclick="switchTab('home')"></i>
            <i class="fas fa-search nav-item" onclick="switchTab('search')"></i>
            <i class="fas fa-envelope nav-item" onclick="switchTab('messages')"></i>
            <i class="fas fa-user nav-item" onclick="switchTab('profile')"></i>
        </div>
    </div>

    <!-- Settings Sidebar -->
    <div id="settings-sidebar">
        <div class="settings-header">Settings</div>
        <div class="settings-item">
            <span>Dark mode</span>
            <label class="switch">
                <input type="checkbox" id="dark-toggle" onchange="toggleDark()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="settings-item"><span>Privacy & safety</span><i class="fas fa-chevron-right"></i></div>
        <div class="settings-item"><span>Notifications</span><i class="fas fa-chevron-right"></i></div>
        <div class="settings-item"><span>Display</span><i class="fas fa-chevron-right"></i></div>
        <div class="settings-item"><span>Security</span><i class="fas fa-chevron-right"></i></div>
        <div class="settings-item"><span>Manage verified badges (Owner only)</span><i class="fas fa-chevron-right" onclick="openVerifyPanel()"></i></div>
        <div class="settings-item"><span>Change profile picture</span><input type="file" id="profile-upload" accept="image/*" onchange="uploadProfilePic(event)"></div>
        <div class="settings-item"><span>About</span><span>Built with hope and a laptop</span></div>
        <button style="background:#d33; width:100%; padding:14px; margin-top:30px; border-radius:999px;" onclick="logout()">Logout</button>
    </div>

    <!-- Username & Avatar Modal -->
    <div id="username-modal" class="modal">
        <div class="modal-content">
            <h2>Complete your profile</h2>
            <div style="margin:20px 0;">
                <div class="avatar" id="avatar-preview">?</div>
                <input type="file" id="avatar-upload" accept="image/*" onchange="previewAvatar(event)" style="margin-top:12px;">
            </div>
            <input id="username-input" placeholder="@username" maxlength="20" style="width:100%; padding:12px; font-size:16px; margin:15px 0; border-radius:12px; border:1px solid var(--border);"/>
            <button onclick="saveProfile()">Save & Continue</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
            authDomain: "echostream-a102a.firebaseapp.com",
            projectId: "echostream-a102a",
            storageBucket: "echostream-a102a.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let currentUserData = null;

        document.getElementById('google-signin').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                await loadUserData();
                loadFeed();
            }
        });

        async function loadUserData() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                currentUserData = doc.data();
                if (!currentUserData.username) {
                    document.getElementById('username-modal').style.display = 'flex';
                }
            } else {
                document.getElementById('username-modal').style.display = 'flex';
            }
        }

        function previewAvatar(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => document.getElementById('avatar-preview').style.backgroundImage = `url(${ev.target.result})`;
                reader.readAsDataURL(file);
            }
        }

        async function saveProfile() {
            const input = document.getElementById('username-input').value.trim().replace('@','');
            if (input.length < 3) return alert('Username too short');
            const snap = await db.collection('users').where('username', '==', input).get();
            if (!snap.empty) return alert('Username taken');

            let photoURL = currentUser.photoURL || null;
            const file = document.getElementById('avatar-upload').files[0];
            if (file) {
                const ref = storage.ref(`avatars/${currentUser.uid}`);
                await ref.put(file);
                photoURL = await ref.getDownloadURL();
            }

            await db.collection('users').doc(currentUser.uid).set({
                username: input,
                photoURL: photoURL,
                verified: false,
                bio: ""
            }, {merge: true});

            currentUserData = {username: input, photoURL, verified: false};
            document.getElementById('username-modal').style.display = 'none';
            loadFeed();
        }

        function toggleDark() {
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark');
            document.getElementById('dark-toggle').checked = true;
        }

        async function createPost() {
            const text = document.getElementById('post-text').value.trim();
            if (!text) return;
            await db.collection('posts').add({
                text,
                uid: currentUser.uid,
                username: currentUserData.username,
                photoURL: currentUserData.photoURL,
                likes: [],
                comments: [],
                reposts: [],
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('post-text').value = '';
            loadFeed();
        }

        async function loadFeed() {
            const snap = await db.collection('posts').orderBy('timestamp', 'desc').get();
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const isLiked = d.likes?.includes(currentUser.uid);
                const div = document.createElement('div');
                div.className = 'post';
                div.innerHTML = `
                    <div class="post-header">
                        <div class="avatar" style="background-image:url(\( {d.photoURL || ''})"> \){(d.username||'A')[0]}</div>
                        <div class="post-user">
                            <div class="username">\( {d.username || 'Anonymous'} \){d.verified ? '<span class="verified">âœ“</span>' : ''}</div>
                            <div class="time">${timeAgo(d.timestamp)}</div>
                        </div>
                    </div>
                    <div class="post-text">${d.text}</div>
                    <div class="post-actions">
                        <div class="action \( {isLiked ? 'liked' : ''}" onclick="toggleLike(' \){doc.id}')">
                            <i class="fa${isLiked ? 's' : 'r'} fa-heart"></i>
                            <span class="action-count">${d.likes?.length || 0}</span>
                        </div>
                        <div class="action" onclick="openComment('${doc.id}')">
                            <i class="far fa-comment"></i>
                            <span class="action-count">${d.comments?.length || 0}</span>
                        </div>
                        <div class="action" onclick="repost('${doc.id}')">
                            <i class="fas fa-retweet"></i>
                            <span class="action-count">${d.reposts?.length || 0}</span>
                        </div>
                    </div>
                `;
                feed.appendChild(div);
            });
            // Echo_AI replies sometimes
            if (Math.random() < 0.2) echoAIThink();
        }

        function timeAgo(ts) {
            if (!ts) return 'now';
            const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }

        async function toggleLike(postId) {
            const ref = db.collection('posts').doc(postId);
            const doc = await ref.get();
            const likes = doc.data().likes || [];
            if (likes.includes(currentUser.uid)) {
                likes.splice(likes.indexOf(currentUser.uid), 1);
            } else {
                likes.push(currentUser.uid);
            }
            await ref.update({likes});
            loadFeed();
        }

        async function repost(postId) {
            // Simple repost - create new post with reference
            const original = await db.collection('posts').doc(postId).get();
            await db.collection('posts').add({
                text: original.data().text,
                uid: currentUser.uid,
                username: currentUserData.username,
                originalPost: postId,
                isRepost: true,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            loadFeed();
        }

        async function echoAIThink() {
            // Simple AI bot
            const messages = ["they're watching", "nice try", "you sure about that?", "i saw that", "be careful"];
            const random = messages[Math.floor(Math.random() * messages.length)];
            await db.collection('posts').add({
                text: random,
                uid: "echo_ai_bot",
                username: "Echo_AI",
                verified: true,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function toggleSettings() {
            document.getElementById('settings-sidebar').classList.toggle('open');
        }

        function switchTab(tab) {
            document.querySelectorAll('#feed, #messages-view, #profile-view').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (tab === 'home') {
                document.getElementById('feed').style.display = 'block';
                document.querySelector('.fa-home').parentElement.classList.add('active');
            } else if (tab === 'messages') {
                document.getElementById('messages-view').style.display = 'block';
                document.querySelector('.fa-envelope').parentElement.classList.add('active');
            } else if (tab === 'profile') {
                document.getElementById('profile-view').style.display = 'block';
                document.querySelector('.fa-user').parentElement.classList.add('active');
            }
        }

        async function uploadProfilePic(e) {
            const file = e.target.files[0];
            if (file) {
                const ref = storage.ref(`avatars/${currentUser.uid}`);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                await db.collection('users').doc(currentUser.uid).update({photoURL: url});
                alert('Profile picture updated');
            }
        }

        function logout() {
            auth.signOut();
        }
    </script>
</body>
</html>