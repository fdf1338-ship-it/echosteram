<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoStream</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { margin:0; font-family:system-ui,sans-serif; background:#f0f0f0; color:#000; }
        .container { max-width:600px; margin:0 auto; padding:20px; text-align:center; padding-top:100px; }
        h1 { font-size:48px; }
        .tagline { color:#ff0000; font-size:16px; margin:20px 0; }
        button { padding:14px 32px; background:#4285F4; color:white; border:none; border-radius:8px; font-size:18px; cursor:pointer; }
        #app { display:none; }
        .header { position:fixed; top:0; left:0; right:0; background:#fff; border-bottom:1px solid #ddd; padding:10px; text-align:right; z-index:10; }
        .post-box { margin-top:70px; padding:20px; }
        textarea { width:100%; height:100px; padding:12px; border:1px solid #ccc; border-radius:8px; font-size:16px; resize:none; }
        .feed { padding:20px; }
        .post { background:white; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:left; }
        .post-header { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
        .avatar { width:48px; height:48px; border-radius:50%; background:#666; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px; }
        .username { font-weight:bold; }
        .time { margin-left:auto; color:#666; font-size:14px; }
        .post-text { margin:10px 0; white-space:pre-wrap; }
        .post-actions { display:flex; justify-content:space-around; color:#666; font-size:20px; margin-top:15px; }
        .action { cursor:pointer; }
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:20; }
        .modal-content { background:white; padding:30px; border-radius:12px; width:90%; max-width:400px; text-align:center; }
    </style>
</head>
<body>
    <div id="login-screen" class="container">
        <h1>EchoStream</h1>
        <p class="tagline">The feed they don't want you seeing.</p>
        <button id="google-signin">Sign in with Google</button>
    </div>

    <div id="app">
        <div class="header">
            <button onclick="logout()">Logout</button>
        </div>

        <div class="post-box">
            <textarea id="post-text" placeholder="What's happening?"></textarea>
            <button onclick="createPost()">Post</button>
        </div>

        <div class="feed" id="feed"></div>
    </div>

    <div id="username-modal" class="modal">
        <div class="modal-content">
            <h2>Pick a username</h2>
            <input id="username-input" placeholder="username" maxlength="20" style="width:100%; padding:12px; font-size:16px; margin:15px 0;"/>
            <button onclick="saveUsername()">Save</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
            authDomain: "echostream-a102a.firebaseapp.com",
            projectId: "echostream-a102a",
            storageBucket: "echostream-a102a.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let username = null;

        document.getElementById('google-signin').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists && doc.data().username) {
                    username = doc.data().username;
                } else {
                    document.getElementById('username-modal').style.display = 'flex';
                }
                loadPosts();
            }
        });

        async function saveUsername() {
            const input = document.getElementById('username-input').value.trim();
            if (input.length < 3) return alert('Too short');
            const snap = await db.collection('users').where('username', '==', input).get();
            if (!snap.empty) return alert('Taken');
            await db.collection('users').doc(currentUser.uid).set({username: input}, {merge: true});
            username = input;
            document.getElementById('username-modal').style.display = 'none';
            loadPosts();
        }

        async function createPost() {
            const text = document.getElementById('post-text').value.trim();
            if (!text) return;
            await db.collection('posts').add({
                text: text,
                uid: currentUser.uid,
                username: username || currentUser.displayName || 'Anonymous',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('post-text').value = '';
            loadPosts();
        }

        async function loadPosts() {
            const snap = await db.collection('posts').orderBy('timestamp', 'desc').get();
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const userName = d.username || 'Anonymous';
                const firstLetter = userName.charAt(0).toUpperCase() || 'A';
                const div = document.createElement('div');
                div.className = 'post';
                div.innerHTML = `
                    <div class="post-header">
                        <div class="avatar">${firstLetter}</div>
                        <div class="username">${userName}</div>
                        <div class="time">${timeAgo(d.timestamp)}</div>
                    </div>
                    <div class="post-text">${d.text || ''}</div>
                    <div class="post-actions">
                        <div class="action"><i class="far fa-heart"></i></div>
                        <div class="action"><i class="far fa-comment"></i></div>
                        <div class="action"><i class="fas fa-retweet"></i></div>
                    </div>
                `;
                feed.appendChild(div);
            });
        }

        function timeAgo(ts) {
            if (!ts) return 'now';
            const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }

        function logout() {
            auth.signOut();
        }
    </script>
</body>
</html>