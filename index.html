<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EchoStream</title>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root {
      --bg:#ffffff;
      --text:#111111;
      --muted:#666;
      --card:#f3f3f3;
      --border:#dddddd;
      --accent:#1da1f2;
      --danger:#ff3b30;
      --ok:#34c759;
      --shadow: 0 8px 22px rgba(0,0,0,.08);
    }

    body.dark {
      --bg:#0b0b0b;
      --text:#f5f5f5;
      --muted:#b9b9b9;
      --card:#171717;
      --border:#2a2a2a;
      --shadow: 0 8px 22px rgba(0,0,0,.5);
    }

    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background .2s, color .2s;
      overscroll-behavior: none;
    }

    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      padding: 14px 14px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index: 50;
      font-weight: 800;
      letter-spacing: .2px;
    }

    header .left, header .right {
      display:flex;
      align-items:center;
      gap:12px;
    }

    header .pill {
      font-weight:700;
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
    }

    nav.bottom {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: 10px 0;
      background: var(--bg);
      border-top: 1px solid var(--border);
      display:flex;
      justify-content: space-around;
      z-index: 50;
    }

    nav.bottom .tab {
      width: 25%;
      text-align:center;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    nav.bottom .tab i { font-size: 20px; }
    nav.bottom .tab .lbl { font-size: 11px; margin-top: 2px; }
    nav.bottom .tab.active { color: var(--accent); }

    main {
      padding: 74px 14px 86px;
      max-width: 720px;
      margin: 0 auto;
    }

    .hidden { display:none; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
    }

    .row { display:flex; gap:10px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:10px; }
    .space { justify-content:space-between; }
    .muted { color: var(--muted); }
    .small { font-size: 12px; }
    .hr { height:1px; background: var(--border); margin: 10px 0; }

    textarea, input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      outline:none;
    }

    textarea { resize: vertical; min-height: 78px; }

    button {
      border: none;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      cursor: pointer;
      user-select:none;
    }
    button.primary { background: var(--accent); color: #fff; }
    button.ghost { background: transparent; border:1px solid var(--border); color: var(--text); }
    button.danger { background: var(--danger); color:#fff; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .avatar {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: #6b7280;
      color: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      flex: 0 0 auto;
    }

    .post-image {
      width: 100%;
      border-radius: 14px;
      margin-top: 10px;
      border: 1px solid var(--border);
      background: #000;
    }

    .click { cursor:pointer; }
    .click:hover { text-decoration: underline; }

    .actions {
      display:flex;
      gap: 18px;
      margin-top: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .action { cursor:pointer; user-select:none; color: var(--muted); }
    .action i { margin-right: 6px; }
    .action.active { color: var(--accent); font-weight: 800; }

    .comment {
      display:flex;
      gap: 10px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.06);
    }

    /* Drawer (side settings) */
    .drawerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display:none;
      z-index: 90;
    }
    .drawer {
      position: fixed;
      top: 0; bottom: 0; right: -340px;
      width: 320px;
      background: var(--bg);
      border-left: 1px solid var(--border);
      z-index: 100;
      transition: right .22s ease;
      padding: 14px;
      overflow:auto;
    }
    .drawerOverlay.show { display:block; }
    .drawer.show { right: 0; }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 90px;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 200;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show { display:block; }

    /* Chat */
    #chatBox {
      height: 340px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: var(--bg);
    }
    .bubble {
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      margin: 8px 0;
      background: var(--card);
    }
    .bubble.me {
      margin-left: auto;
      border-color: rgba(29,161,242,.35);
    }
    .bubble .meta {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      font-weight: 700;
    }
  </style>
</head>

<body>
  <header>
    <div class="left">
      <span>EchoStream</span>
      <span id="statusPill" class="pill">offline</span>
    </div>
    <div class="right">
      <i class="fa-solid fa-gear click" title="Settings" onclick="openDrawer()"></i>
    </div>
  </header>

  <main>
    <!-- LOGIN -->
    <section id="loginView">
      <div class="card">
        <h2 style="margin:0 0 6px;">Welcome</h2>
        <div class="muted">Sign in to continue.</div>
        <div style="height:12px;"></div>
        <button class="primary" onclick="login()">Sign in with Google</button>
      </div>
    </section>

    <!-- FEED -->
    <section id="feedView" class="hidden">
      <div class="card">
        <div class="row space">
          <div class="row" style="gap:10px;">
            <div id="meAvatar" class="avatar">?</div>
            <div class="col" style="gap:2px;">
              <div style="font-weight:900;">Create a post</div>
              <div class="small muted" id="meUsername">@...</div>
            </div>
          </div>
          <button class="ghost" onclick="refreshFeed()">Refresh</button>
        </div>

        <div style="height:10px;"></div>
        <textarea id="postText" placeholder="What‚Äôs happening?"></textarea>

        <div style="height:10px;"></div>
        <div class="row">
          <input type="file" id="postImage" accept="image/*" />
        </div>

        <button class="primary" onclick="createPost()">Post</button>
        <div class="small muted" style="margin-top:10px;">
          Tip: If you don‚Äôt want Storage, just don‚Äôt pick an image (text posts work).
        </div>
      </div>

      <div id="posts"></div>
    </section>

    <!-- SEARCH -->
    <section id="searchView" class="hidden">
      <div class="card">
        <div style="font-weight:900; margin-bottom:8px;">Search</div>
        <input id="searchInput" placeholder="Search usernames..." oninput="doSearch()" />
        <div class="small muted" style="margin-top:8px;">Type at least 2 letters.</div>
      </div>
      <div id="searchResults"></div>
    </section>

    <!-- MESSAGES -->
    <section id="messagesView" class="hidden">
      <div class="card">
        <div class="row space">
          <div class="col" style="gap:2px;">
            <div style="font-weight:900;">Messages</div>
            <div class="small muted" id="chatWithLabel">Chat: Global</div>
          </div>
          <button class="ghost" onclick="setChatGlobal()">Global</button>
        </div>
        <div style="height:10px;"></div>
        <div id="chatBox"></div>
        <div style="height:10px;"></div>
        <input id="chatInput" placeholder="Type a message..." />
        <div class="row" style="margin-top:8px;">
          <button class="primary" onclick="sendMessage()">Send</button>
          <button class="ghost" onclick="aiAssist()">AI Assist</button>
        </div>
        <div class="small muted" style="margin-top:8px;">
          Tip: Open a user profile and tap ‚ÄúMessage‚Äù to DM.
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="profileView" class="hidden"></section>
  </main>

  <!-- Bottom nav -->
  <nav class="bottom">
    <div class="tab active" id="tabFeed" onclick="route('feed')">
      <i class="fa-solid fa-house"></i>
      <div class="lbl">Feed</div>
    </div>
    <div class="tab" id="tabSearch" onclick="route('search')">
      <i class="fa-solid fa-magnifying-glass"></i>
      <div class="lbl">Search</div>
    </div>
    <div class="tab" id="tabMessages" onclick="route('messages')">
      <i class="fa-solid fa-message"></i>
      <div class="lbl">Messages</div>
    </div>
    <div class="tab" id="tabProfile" onclick="openProfile(currentUser?.uid)">
      <i class="fa-solid fa-user"></i>
      <div class="lbl">Profile</div>
    </div>
  </nav>

  <!-- Drawer -->
  <div id="drawerOverlay" class="drawerOverlay" onclick="closeDrawer()"></div>
  <aside id="drawer" class="drawer">
    <div class="row space">
      <div style="font-weight:900;">Settings</div>
      <i class="fa-solid fa-xmark click" onclick="closeDrawer()"></i>
    </div>

    <div class="hr"></div>

    <div class="card" style="box-shadow:none; margin-bottom:10px;">
      <div style="font-weight:900;">Appearance</div>
      <div style="height:8px;"></div>
      <label class="row" style="gap:10px;">
        <input type="checkbox" id="darkToggle" />
        <span>Dark mode</span>
      </label>
    </div>

    <div class="card" style="box-shadow:none; margin-bottom:10px;">
      <div style="font-weight:900;">Account</div>
      <div style="height:8px;"></div>
      <div class="small muted">Signed in as</div>
      <div id="acctEmail" style="font-weight:800;">-</div>
      <div class="small muted" style="margin-top:6px;">UID</div>
      <div id="acctUid" class="small" style="word-break:break-all;">-</div>

      <div class="hr"></div>

      <button class="ghost" onclick="openUsernameChange()">Change username</button>
      <button class="danger" style="margin-top:8px;" onclick="logout()">Logout</button>
    </div>

    <div class="card" style="box-shadow:none;">
      <div style="font-weight:900;">Debug</div>
      <div class="small muted" style="margin-top:6px;">
        If you see ‚ÄúCORS Listen channel failed‚Äù, that‚Äôs usually network/adblock/browser privacy blocking Firestore realtime.
        Try: disable strict tracking, disable adblock for your site, or test in Chrome.
      </div>
    </div>
  </aside>

  <!-- Username modal -->
  <div id="usernameModal" class="drawerOverlay" style="display:none; z-index:300;">
    <div class="card" style="max-width:420px; margin:80px auto 0; position:relative;">
      <div class="row space">
        <div style="font-weight:900;">Pick a username</div>
        <i class="fa-solid fa-xmark click" onclick="closeUsernameModal()"></i>
      </div>
      <div class="small muted" style="margin-top:6px;">Unique. Lowercase letters, numbers, underscore.</div>
      <div style="height:10px;"></div>
      <input id="usernameInput" placeholder="username" maxlength="20" />
      <button class="primary" style="margin-top:10px;" onclick="saveUsername()">Save</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    /***********************
     * 1) Firebase config
     ***********************/
    firebase.initializeApp({
      apiKey:"AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
      authDomain:"echostream-a102a.firebaseapp.com",
      projectId:"echostream-a102a",
      storageBucket:"echostream-a102a.appspot.com",
      messagingSenderId:"789062222400",
      appId:"1:789062222400:web:73d478269135a77d7d55a5"
    });

    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    /***********************
     * 2) Helpers (fix your crashes)
     ***********************/
    const $ = (id) => document.getElementById(id);

    function safeStr(v) {
      return (typeof v === "string") ? v : "";
    }
    function safeArray(v) {
      return Array.isArray(v) ? v : [];
    }
    function initialFrom(name) {
      const s = safeStr(name).trim();
      return (s[0] ? s[0].toUpperCase() : "?");
    }
    function toast(msg, ms=2200) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => t.classList.remove("show"), ms);
    }
    function timeAgo(ts) {
      if (!ts || !ts.toDate) return "now";
      const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
      if (seconds < 60) return seconds + "s";
      if (seconds < 3600) return Math.floor(seconds/60) + "m";
      if (seconds < 86400) return Math.floor(seconds/3600) + "h";
      return Math.floor(seconds/86400) + "d";
    }

    /***********************
     * 3) App state
     ***********************/
    let currentUser = null;
    let userData = null;

    let currentRoute = "feed";

    // Messaging
    let activeChat = { type: "global", peerUid: null, peerUsername: null };
    let unsubscribeChat = null;

    // Feed listener
    let unsubscribeFeed = null;

    /***********************
     * 4) Auth
     ***********************/
    function login() {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => {
        console.error(err);
        toast("Login failed: " + (err?.message || err));
      });
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    auth.onAuthStateChanged(async (user) => {
      currentUser = user || null;

      if (!currentUser) {
        $("statusPill").textContent = "offline";
        showView("login");
        return;
      }

      $("statusPill").textContent = "online";
      $("acctEmail").textContent = currentUser.email || "(no email)";
      $("acctUid").textContent = currentUser.uid;

      // Load (or create) user doc
      const userRef = db.collection("users").doc(currentUser.uid);
      const snap = await userRef.get();

      if (!snap.exists) {
        // Create a basic doc first (username set later via modal)
        await userRef.set({
          uid: currentUser.uid,
          username: "",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          followers: [],
          following: []
        });
        userData = (await userRef.get()).data();
        openUsernameModal();
      } else {
        userData = snap.data();
        if (!safeStr(userData.username)) openUsernameModal();
      }

      // Dark mode load
      const dark = localStorage.getItem("darkMode") === "true";
      $("darkToggle").checked = dark;
      document.body.classList.toggle("dark", dark);

      // Update top UI
      $("meAvatar").textContent = initialFrom(userData.username || currentUser.displayName || "?");
      $("meUsername").textContent = "@" + (userData.username || "set-username");

      // Start on feed
      showView("feed");
      route("feed");
      startFeedListener();
      setChatGlobal();
    });

    /***********************
     * 5) Views / routing
     ***********************/
    function showView(which) {
      $("loginView").classList.toggle("hidden", which !== "login");
      $("feedView").classList.toggle("hidden", which !== "feed");
      $("searchView").classList.toggle("hidden", which !== "search");
      $("messagesView").classList.toggle("hidden", which !== "messages");
      $("profileView").classList.toggle("hidden", which !== "profile");
    }

    function setActiveTab(name) {
      const tabs = [
        ["feed","tabFeed"],
        ["search","tabSearch"],
        ["messages","tabMessages"],
        ["profile","tabProfile"],
      ];
      tabs.forEach(([routeName, tabId]) => {
        $(tabId).classList.toggle("active", routeName === name);
      });
    }

    function route(name) {
      currentRoute = name;
      setActiveTab(name);

      if (name === "feed") showView("feed");
      if (name === "search") showView("search");
      if (name === "messages") showView("messages");
      if (name === "profile") showView("profile");

      if (name === "messages") loadChat();
      if (name === "feed") refreshFeed();
    }

    /***********************
     * 6) Drawer
     ***********************/
    function openDrawer() {
      $("drawerOverlay").classList.add("show");
      $("drawer").classList.add("show");
    }
    function closeDrawer() {
      $("drawerOverlay").classList.remove("show");
      $("drawer").classList.remove("show");
    }

    // Simple swipe to open (right edge swipe)
    let touchStartX = null;
    document.addEventListener("touchstart", (e) => {
      if (!e.touches?.length) return;
      touchStartX = e.touches[0].clientX;
    }, { passive:true });

    document.addEventListener("touchend", (e) => {
      if (touchStartX == null) return;
      const endX = e.changedTouches?.[0]?.clientX ?? touchStartX;
      const dx = endX - touchStartX;
      // Swipe from right edge to left = close; from mid to right edge = ignore
      // Swipe from near right edge towards left = open
      if (touchStartX > (window.innerWidth - 40) && dx < -40) openDrawer();
      touchStartX = null;
    }, { passive:true });

    /***********************
     * 7) Dark mode toggle
     ***********************/
    $("darkToggle").addEventListener("change", (e) => {
      const on = !!e.target.checked;
      document.body.classList.toggle("dark", on);
      localStorage.setItem("darkMode", String(on));
    });

    /***********************
     * 8) Username uniqueness (real fix)
     *    Uses: users/{uid} and usernames/{username} -> {uid}
     ***********************/
    function openUsernameModal() {
      $("usernameModal").style.display = "block";
    }
    function closeUsernameModal() {
      $("usernameModal").style.display = "none";
    }
    function openUsernameChange() {
      closeDrawer();
      openUsernameModal();
      $("usernameInput").value = userData?.username || "";
      $("usernameInput").focus();
    }

    async function saveUsername() {
      if (!currentUser) return;
      const name = safeStr($("usernameInput").value).trim().toLowerCase();

      if (name.length < 3) return toast("Username too short (min 3).");
      if (name.length > 20) return toast("Username too long (max 20).");
      if (!/^[a-z0-9_]+$/.test(name)) return toast("Use only lowercase, numbers, underscore.");

      const userRef = db.collection("users").doc(currentUser.uid);
      const unameRef = db.collection("usernames").doc(name);

      try {
        await db.runTransaction(async (tx) => {
          const unameSnap = await tx.get(unameRef);
          if (unameSnap.exists) {
            const existingUid = unameSnap.data()?.uid;
            if (existingUid !== currentUser.uid) {
              throw new Error("USERNAME_TAKEN");
            }
          }

          // If user had an old username, release it
          const meSnap = await tx.get(userRef);
          const old = safeStr(meSnap.data()?.username).toLowerCase();
          if (old && old !== name) {
            tx.delete(db.collection("usernames").doc(old));
          }

          tx.set(unameRef, { uid: currentUser.uid }, { merge: true });
          tx.set(userRef, {
            uid: currentUser.uid,
            username: name,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        });

        // refresh local
        userData = (await userRef.get()).data();
        $("meAvatar").textContent = initialFrom(userData.username || currentUser.displayName || "?");
        $("meUsername").textContent = "@" + userData.username;
        closeUsernameModal();
        toast("Username saved!");
      } catch (e) {
        console.error(e);
        if (String(e?.message || "").includes("USERNAME_TAKEN")) return toast("That username is taken.");
        toast("Could not save username. Check Firestore rules.");
      }
    }

    /***********************
     * 9) Posts (fix likes/comments/shares types)
     ***********************/
    async function createPost() {
      if (!currentUser) return;

      const text = safeStr($("postText").value).trim();
      const file = $("postImage").files?.[0] || null;

      if (!text && !file) return toast("Post can‚Äôt be empty.");

      // If user didn't pick username yet, force it
      if (!safeStr(userData?.username)) {
        openUsernameModal();
        return toast("Set a username first.");
      }

      let imageUrl = "";

      // Image is optional. If Storage fails, still allow text post.
      if (file) {
        try {
          const path = `posts/${currentUser.uid}/${Date.now()}_${file.name}`;
          const ref = storage.ref(path);
          await ref.put(file);
          imageUrl = await ref.getDownloadURL();
        } catch (e) {
          console.warn("Storage upload failed:", e);
          toast("Image upload failed (Storage). Posting text only.");
          imageUrl = "";
        }
      }

      await db.collection("posts").add({
        uid: currentUser.uid,
        username: userData.username,
        text,
        imageUrl,
        likes: [],
        comments: [],
        shares: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      $("postText").value = "";
      $("postImage").value = "";
      toast("Posted!");
    }

    function renderPost(post, postId) {
      const username = safeStr(post.username) || "unknown";
      const likesArr = safeArray(post.likes);
      const commentsArr = safeArray(post.comments);
      const sharesArr = safeArray(post.shares);

      const liked = likesArr.includes(currentUser.uid);

      const commentsHtml = commentsArr.map(c => {
        const cu = safeStr(c?.username) || "unknown";
        const ct = safeStr(c?.text) || "";
        return `
          <div class="comment">
            <div class="avatar">${initialFrom(cu)}</div>
            <div class="col" style="gap:2px; flex:1;">
              <div style="font-weight:900;">${escapeHtml(cu)}</div>
              <div>${escapeHtml(ct)}</div>
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="card">
          <div class="row space">
            <div class="row" style="gap:10px;">
              <div class="avatar">${initialFrom(username)}</div>
              <div class="col" style="gap:2px;">
                <div style="font-weight:900;">
                  <span class="click" onclick="openProfile('${escapeAttr(post.uid)}')">${escapeHtml(username)}</span>
                  <span class="badge">@${escapeHtml(username)}</span>
                </div>
                <div class="small muted">${timeAgo(post.createdAt)}</div>
              </div>
            </div>
            <div class="small muted">${post.uid === currentUser.uid ? "You" : ""}</div>
          </div>

          ${safeStr(post.text) ? `<div style="margin-top:10px;">${escapeHtml(post.text)}</div>` : ""}

          ${safeStr(post.imageUrl) ? `<img src="${escapeAttr(post.imageUrl)}" class="post-image" />` : ""}

          <div class="actions">
            <span class="action ${liked ? "active" : ""}" onclick="toggleLike('${escapeAttr(postId)}')">
              <i class="${liked ? "fa-solid" : "fa-regular"} fa-heart"></i>${likesArr.length}
            </span>

            <span class="action" onclick="toggleComments('${escapeAttr(postId)}')">
              <i class="fa-regular fa-comment"></i>${commentsArr.length}
            </span>

            <span class="action" onclick="sharePost('${escapeAttr(postId)}')">
              <i class="fa-solid fa-retweet"></i>${sharesArr.length}
            </span>
          </div>

          <div id="comments-${escapeAttr(postId)}" class="hidden">
            ${commentsHtml || `<div class="small muted" style="margin-top:10px;">No comments yet.</div>`}

            <div class="row" style="margin-top:10px;">
              <input id="commentInput-${escapeAttr(postId)}" placeholder="Write a comment..." />
              <button class="primary" onclick="addComment('${escapeAttr(postId)}')">Send</button>
            </div>
          </div>
        </div>
      `;
    }

    function startFeedListener() {
      if (unsubscribeFeed) unsubscribeFeed();

      unsubscribeFeed = db.collection("posts")
        .orderBy("createdAt", "desc")
        .limit(50)
        .onSnapshot((snap) => {
          const postsDiv = $("posts");
          postsDiv.innerHTML = "";
          snap.forEach(doc => {
            const data = doc.data() || {};
            postsDiv.innerHTML += renderPost(data, doc.id);
          });
        }, (err) => {
          console.error(err);
          toast("Feed error: " + (err?.message || err));
        });
    }

    function refreshFeed() {
      // feed is realtime already; this just gives user feedback
      toast("Refreshing‚Ä¶");
    }

    async function toggleLike(postId) {
      if (!currentUser) return;

      const ref = db.collection("posts").doc(postId);
      const snap = await ref.get();
      const data = snap.data() || {};
      const likes = safeArray(data.likes);

      const next = likes.includes(currentUser.uid)
        ? likes.filter(x => x !== currentUser.uid)
        : [...likes, currentUser.uid];

      await ref.update({ likes: next });
    }

    function toggleComments(postId) {
      const el = document.getElementById(`comments-${postId}`);
      if (el) el.classList.toggle("hidden");
    }

    async function addComment(postId) {
      const input = document.getElementById(`commentInput-${postId}`);
      const text = safeStr(input?.value).trim();
      if (!text) return;

      const ref = db.collection("posts").doc(postId);
      const snap = await ref.get();
      const data = snap.data() || {};
      const comments = safeArray(data.comments);

      comments.push({
        uid: currentUser.uid,
        username: userData.username || "unknown",
        text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await ref.update({ comments });
      input.value = "";
    }

    async function sharePost(postId) {
      const ref = db.collection("posts").doc(postId);
      const snap = await ref.get();
      const data = snap.data() || {};
      const shares = safeArray(data.shares);

      if (!shares.includes(currentUser.uid)) shares.push(currentUser.uid);
      await ref.update({ shares });
      toast("Shared!");
    }

    /***********************
     * 10) Profile (clickable + followers)
     ***********************/
    async function openProfile(uid) {
      if (!uid) return;
      route("profile");
      await loadProfile(uid);
    }

    async function loadProfile(uid) {
      if (!uid) return;

      const uSnap = await db.collection("users").doc(uid).get();
      const u = uSnap.data() || {};
      const uname = safeStr(u.username) || "unknown";

      // Get posts without composite index requirement:
      const pSnap = await db.collection("posts").where("uid", "==", uid).get();
      const posts = [];
      pSnap.forEach(d => posts.push({ id: d.id, ... (d.data() || {}) }));

      // Sort in JS
      posts.sort((a,b) => {
        const at = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
        const bt = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
        return bt - at;
      });

      const followers = safeArray(u.followers);
      const following = safeArray(u.following);

      const isMe = uid === currentUser.uid;
      const iFollow = safeArray(userData?.following).includes(uid);

      const postsHtml = posts.length
        ? posts.map(p => `
            <div class="card">
              <div class="small muted">${timeAgo(p.createdAt)}</div>
              ${safeStr(p.text) ? `<div style="margin-top:8px;">${escapeHtml(p.text)}</div>` : ""}
              ${safeStr(p.imageUrl) ? `<img class="post-image" src="${escapeAttr(p.imageUrl)}" />` : ""}
            </div>
          `).join("")
        : `<div class="card"><div class="muted">No posts yet.</div></div>`;

      $("profileView").innerHTML = `
        <div class="card">
          <div class="row space">
            <div class="row" style="gap:10px;">
              <div class="avatar" style="width:54px;height:54px;font-size:22px;">${initialFrom(uname)}</div>
              <div class="col" style="gap:2px;">
                <div style="font-weight:900; font-size:18px;">@${escapeHtml(uname)}</div>
                <div class="small muted">${escapeHtml(currentUser.displayName || "")}</div>
              </div>
            </div>
            <div class="col" style="gap:8px; align-items:flex-end;">
              ${!isMe ? `<button class="primary" onclick="toggleFollow('${escapeAttr(uid)}')">${iFollow ? "Following" : "Follow"}</button>` : ""}
              ${!isMe ? `<button class="ghost" onclick="startDM('${escapeAttr(uid)}','${escapeAttr(uname)}')">Message</button>` : ""}
            </div>
          </div>

          <div class="hr"></div>

          <div class="row" style="gap:10px; flex-wrap:wrap;">
            <span class="badge"><b>${followers.length}</b>&nbsp;Followers</span>
            <span class="badge"><b>${following.length}</b>&nbsp;Following</span>
            <span class="badge"><b>${posts.length}</b>&nbsp;Posts</span>
          </div>

          <div class="small muted" style="margin-top:10px;">
            (Prototype) Follower list UI can be added next.
          </div>
        </div>

        <div style="font-weight:900; margin:10px 2px;">Posts</div>
        ${postsHtml}
      `;
    }

    async function toggleFollow(targetUid) {
      if (!currentUser || !targetUid) return;
      if (targetUid === currentUser.uid) return toast("You can't follow yourself.");

      const myRef = db.collection("users").doc(currentUser.uid);
      const tRef = db.collection("users").doc(targetUid);

      await db.runTransaction(async (tx) => {
        const mySnap = await tx.get(myRef);
        const tSnap = await tx.get(tRef);

        const my = mySnap.data() || {};
        const t = tSnap.data() || {};

        let myFollowing = safeArray(my.following);
        let tFollowers = safeArray(t.followers);

        const already = myFollowing.includes(targetUid);

        if (already) {
          myFollowing = myFollowing.filter(x => x !== targetUid);
          tFollowers = tFollowers.filter(x => x !== currentUser.uid);
        } else {
          myFollowing.push(targetUid);
          tFollowers.push(currentUser.uid);
        }

        tx.update(myRef, { following: myFollowing });
        tx.update(tRef, { followers: tFollowers });
      });

      // Refresh local userData
      userData = (await db.collection("users").doc(currentUser.uid).get()).data();

      toast("Updated follow!");
      await loadProfile(targetUid);
    }

    /***********************
     * 11) Search (fix undefined username crash)
     ***********************/
    async function doSearch() {
      const q = safeStr($("searchInput").value).trim().toLowerCase();
      const res = $("searchResults");

      if (q.length < 2) {
        res.innerHTML = "";
        return;
      }

      try {
        const snap = await db.collection("users").limit(200).get();
        let html = "";

        snap.forEach(doc => {
          const u = doc.data() || {};
          const uname = safeStr(u.username).toLowerCase();
          if (!uname) return;

          if (uname.includes(q)) {
            html += `
              <div class="card">
                <div class="row space">
                  <div class="row" style="gap:10px;">
                    <div class="avatar">${initialFrom(uname)}</div>
                    <div class="col" style="gap:2px;">
                      <div style="font-weight:900;" class="click" onclick="openProfile('${escapeAttr(doc.id)}')">@${escapeHtml(uname)}</div>
                      <div class="small muted">${escapeHtml(doc.id)}</div>
                    </div>
                  </div>
                  <button class="ghost" onclick="startDM('${escapeAttr(doc.id)}','${escapeAttr(uname)}')">Message</button>
                </div>
              </div>
            `;
          }
        });

        res.innerHTML = html || `<div class="card"><div class="muted">No results.</div></div>`;
      } catch (e) {
        console.error(e);
        toast("Search error: " + (e?.message || e));
      }
    }

    /***********************
     * 12) Messages (Global + DM)
     ***********************/
    function chatDocIdForGlobal() {
      return "global";
    }
    function chatDocIdForDM(aUid, bUid) {
      return (aUid < bUid) ? (aUid + "_" + bUid) : (bUid + "_" + aUid);
    }

    function setChatGlobal() {
      activeChat = { type: "global", peerUid: null, peerUsername: null };
      $("chatWithLabel").textContent = "Chat: Global";
      route("messages");
      loadChat();
    }

    function startDM(uid, username) {
      activeChat = { type: "dm", peerUid: uid, peerUsername: username };
      $("chatWithLabel").textContent = "Chat: @" + (username || "user");
      route("messages");
      loadChat();
      toast("Opened DM with @" + (username || "user"));
    }

    function loadChat() {
      if (!currentUser) return;

      if (unsubscribeChat) unsubscribeChat();

      const box = $("chatBox");
      box.innerHTML = `<div class="muted small">Loading‚Ä¶</div>`;

      const chatId = (activeChat.type === "global")
        ? chatDocIdForGlobal()
        : chatDocIdForDM(currentUser.uid, activeChat.peerUid);

      const ref = db.collection("chats").doc(chatId).collection("messages")
        .orderBy("createdAt", "asc")
        .limit(200);

      unsubscribeChat = ref.onSnapshot((snap) => {
        box.innerHTML = "";
        snap.forEach(doc => {
          const m = doc.data() || {};
          const who = safeStr(m.username) || "unknown";
          const text = safeStr(m.text) || "";
          const mine = m.uid === currentUser.uid;

          box.innerHTML += `
            <div class="bubble ${mine ? "me" : ""}">
              <div class="meta">${escapeHtml(who)} ‚Ä¢ ${timeAgo(m.createdAt)}</div>
              <div>${escapeHtml(text)}</div>
            </div>
          `;
        });
        box.scrollTop = box.scrollHeight;
      }, (err) => {
        console.error(err);
        toast("Chat listen error: " + (err?.message || err));
        box.innerHTML = `<div class="muted small">Chat error. Check rules/network.</div>`;
      });
    }

    async function sendMessage() {
      const text = safeStr($("chatInput").value).trim();
      if (!text) return;

      $("chatInput").value = "";

      const chatId = (activeChat.type === "global")
        ? chatDocIdForGlobal()
        : chatDocIdForDM(currentUser.uid, activeChat.peerUid);

      try {
        await db.collection("chats").doc(chatId).set({
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          type: activeChat.type,
          members: activeChat.type === "global" ? ["*"] : [currentUser.uid, activeChat.peerUid]
        }, { merge: true });

        await db.collection("chats").doc(chatId).collection("messages").add({
          uid: currentUser.uid,
          username: userData.username || "unknown",
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        console.error(e);
        toast("Send failed: " + (e?.message || e));
      }
    }

    // Very simple ‚ÄúAI Assist‚Äù (no paid API)
    async function aiAssist() {
      const prompt = safeStr($("chatInput").value).trim();
      if (!prompt) return toast("Type something first.");

      // This is a local ‚Äúfake AI helper‚Äù (no server). You can replace later with a real AI API.
      const reply = localAi(prompt);

      const chatId = (activeChat.type === "global")
        ? chatDocIdForGlobal()
        : chatDocIdForDM(currentUser.uid, activeChat.peerUid);

      try {
        await db.collection("chats").doc(chatId).collection("messages").add({
          uid: "AI",
          username: "EchoBot",
          text: reply,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast("EchoBot replied.");
      } catch (e) {
        console.error(e);
        toast("AI message failed (rules?)");
      }
    }

    function localAi(text) {
      const t = text.toLowerCase();
      if (t.includes("hi") || t.includes("hello")) return "Hey! üëã What are you working on in EchoStream?";
      if (t.includes("fix") || t.includes("error")) return "Tell me the exact error text and where it happens. I‚Äôll help you patch it.";
      if (t.includes("idea")) return "Feature idea: add a 'following feed' toggle and show only posts from people you follow.";
      if (t.includes("rules")) return "Rules tip: allow users to like/comment but block changing post.uid/username.";
      return "Got it. Want help with feed, search, profiles, or chat next?";
    }

    /***********************
     * 13) HTML escaping (security)
     ***********************/
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s) {
      // ok for putting inside "..."
      return escapeHtml(s).replaceAll("`","&#096;");
    }
  </script>
</body>
</html>