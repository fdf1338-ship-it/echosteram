<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EchoStream</title>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#666;
      --card:#f3f3f3; --border:#ddd;
      --accent:#1da1f2; --danger:#ff3b30;
    }
    body.dark{
      --bg:#0b0b0b; --text:#fff; --muted:#aaa;
      --card:#151515; --border:#2a2a2a;
    }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{
      position:fixed; top:0; left:0; right:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      z-index:20;
      font-weight:800;
    }
    header .left{display:flex; align-items:center; gap:10px;}
    header .icon-btn{
      width:40px; height:40px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    header .icon-btn:hover{ background:rgba(127,127,127,.12); }

    main{
      padding:72px 14px 88px;
      max-width:640px; margin:0 auto;
    }

    nav{
      position:fixed; bottom:0; left:0; right:0;
      display:flex; justify-content:space-around; align-items:center;
      padding:10px 0;
      background:var(--bg);
      border-top:1px solid var(--border);
      z-index:20;
    }
    nav .tab{
      width:25%;
      display:flex; flex-direction:column; align-items:center;
      gap:6px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      padding:6px 0;
    }
    nav .tab.active{ color:var(--accent); }
    nav i{ font-size:20px; }

    .hidden{ display:none !important; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
    }

    textarea, input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }

    button{
      border:none;
      background:var(--accent);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
    }
    button.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    button.danger{ background:var(--danger); }

    .row{ display:flex; gap:10px; align-items:center; }
    .space{ flex:1; }

    .avatar{
      width:42px; height:42px;
      border-radius:999px;
      background:#666;
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      font-weight:800;
    }
    .post-image{
      margin-top:10px;
      max-width:100%;
      border-radius:14px;
      border:1px solid var(--border);
    }

    .muted{ color:var(--muted); font-size:13px; }
    .click{ cursor:pointer; }
    .click:hover{ text-decoration:underline; }

    .post-actions{
      display:flex; gap:18px;
      margin-top:10px;
      color:var(--muted);
      user-select:none;
    }
    .post-actions span{ cursor:pointer; }
    .post-actions span:hover{ color:var(--text); }

    .comment{
      display:flex; gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--border);
    }
    .comment .avatar{ width:34px; height:34px; font-size:14px; }

    /* Prevent Android text-select / dictionary popups on tappable UI */
    .noselect, .noselect *{
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
    }

    .stat-btn{
      background: transparent;
      border: 0;
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
    }
    .stat-btn:active{ background: rgba(127,127,127,.12); }
    .stat-num{ font-weight: 900; font-size: 18px; }
    .stat-label{ color: var(--muted); font-size: 13px; margin-top: 2px; }

    /* Drawer */
    .drawer-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      z-index:50;
      display:none;
    }
    .drawer-backdrop.show{ display:block; }

    .drawer{
      position:fixed; top:0; left:-320px;
      width:300px; height:100%;
      background:var(--bg);
      border-right:1px solid var(--border);
      z-index:60;
      padding:14px;
      transition:left .2s ease;
    }
    .drawer.show{ left:0; }

    .drawer .item{
      padding:12px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex; gap:10px; align-items:center;
    }
    .drawer .item:hover{ background:rgba(127,127,127,.12); }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      z-index:80;
      padding:14px;
    }
    .modal.show{ display:flex; }
    .modal .box{
      width:100%;
      max-width:460px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
    }

    /* Settings "pages" */
    .settings-page-title{
      font-weight:900; font-size:18px;
      display:flex; align-items:center; gap:10px;
      margin:0 0 12px;
    }
    .settings-item{
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .settings-item:active{ background:rgba(127,127,127,.12); }
    .settings-item .right{ margin-left:auto; color:var(--muted); }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>

<header>
  <div class="left">
    <div class="icon-btn" onclick="openDrawer()"><i class="fa-solid fa-bars"></i></div>
    <div id="headerTitle">EchoStream</div>
  </div>
  <div class="icon-btn" onclick="route('settings')"><i class="fa-solid fa-gear"></i></div>
</header>

<!-- Drawer -->
<div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
<div id="drawer" class="drawer">
  <div class="row">
    <div style="font-weight:900;">Menu</div>
    <div class="space"></div>
    <div class="icon-btn" onclick="closeDrawer()"><i class="fa-solid fa-xmark"></i></div>
  </div>
  <div style="height:8px;"></div>
  <div class="item" onclick="route('feed'); closeDrawer();"><i class="fa-solid fa-house"></i> Feed</div>
  <div class="item" onclick="route('search'); closeDrawer();"><i class="fa-solid fa-magnifying-glass"></i> Search</div>
  <div class="item" onclick="route('messages'); closeDrawer();"><i class="fa-solid fa-message"></i> Messages</div>
  <div class="item" onclick="route('profile'); closeDrawer();"><i class="fa-solid fa-user"></i> Profile</div>
  <div class="item" onclick="route('settings'); closeDrawer();"><i class="fa-solid fa-gear"></i> Settings</div>
</div>

<main>

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <h2 style="margin:0 0 8px;">Welcome to EchoStream</h2>
    <p class="muted" style="margin:0 0 12px;">Sign in to post, follow, message, and search.</p>
    <button onclick="login()">Sign in with Google</button>
  </div>

  <!-- FEED -->
  <div id="feedView" class="hidden">
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Post</div>
      <textarea id="postText" placeholder="What‚Äôs happening?"></textarea>
      <div style="height:10px;"></div>
      <input id="postImage" type="file" accept="image/*"/>
      <div class="row" style="margin-top:10px;">
        <button onclick="createPost()">Post</button>
        <div class="space"></div>
        <span class="muted" id="postStatus"></span>
      </div>
    </div>

    <div id="posts"></div>
  </div>

  <!-- SEARCH -->
  <div id="searchView" class="hidden">
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Search users</div>
      <input id="searchInput" placeholder="Search by username..." oninput="doSearch()"/>
    </div>
    <div id="searchResults"></div>
  </div>

  <!-- MESSAGES -->
  <div id="messagesView" class="hidden">
    <div class="card">
      <div class="row">
        <div style="font-weight:800;">Chat</div>
        <div class="space"></div>
        <button class="secondary" onclick="setChatAI()">EchoBot</button>
      </div>
      <div class="muted" id="chatWith" style="margin-top:6px;">Chatting with: EchoBot</div>
    </div>

    <div class="card" style="padding:10px;">
      <div id="chatBox" style="height:320px; overflow:auto;"></div>
    </div>

    <div class="card">
      <input id="chatInput" placeholder="Type a message..."/>
      <div class="row" style="margin-top:10px;">
        <button onclick="sendMessage()">Send</button>
        <div class="space"></div>
        <span class="muted" id="msgStatus"></span>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profileView" class="hidden"></div>

  <!-- SETTINGS -->
  <div id="settingsView" class="hidden">
    <!-- page: home -->
    <div id="settingsHome" class="hidden">
      <div class="settings-page-title">
        <span>Settings</span>
      </div>

      <div class="settings-item" onclick="openSettingsPage('accountInfo')">
        <i class="fa-regular fa-user"></i>
        <div>
          <div style="font-weight:900;">Your account</div>
          <div class="muted" id="settingsUsernameLine">Loading...</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      <div class="settings-item" onclick="openSettingsPage('security')">
        <i class="fa-solid fa-shield"></i>
        <div>
          <div style="font-weight:900;">Security</div>
          <div class="muted">Sign out, account info</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      <div class="settings-item" onclick="openSettingsPage('appearance')">
        <i class="fa-regular fa-moon"></i>
        <div>
          <div style="font-weight:900;">Appearance</div>
          <div class="muted">Dark mode</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      <div class="settings-item" onclick="openSettingsPage('about')">
        <i class="fa-regular fa-circle-question"></i>
        <div>
          <div style="font-weight:900;">About</div>
          <div class="muted">Version + support</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>
    </div>

    <!-- page: account info -->
    <div id="settingsAccountInfo" class="hidden">
      <div class="settings-page-title">
        <button class="secondary" onclick="openSettingsPage('home')"><i class="fa-solid fa-arrow-left"></i></button>
        <span>Your account</span>
      </div>

      <div class="card">
        <div style="font-weight:900; font-size:18px;" id="accountUsername">username</div>
        <div class="muted" id="accountEmail">email</div>
        <div style="height:10px;"></div>
        <div class="pill" id="accountUid">UID: ...</div>
      </div>

      <div class="settings-item" onclick="openSettingsPage('changeUsername')">
        <i class="fa-solid fa-pen"></i>
        <div>
          <div style="font-weight:900;">Change username</div>
          <div class="muted">Update your public username</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      <div class="settings-item" onclick="openSettingsPage('downloadData')">
        <i class="fa-solid fa-download"></i>
        <div>
          <div style="font-weight:900;">Download your data</div>
          <div class="muted">Export basics (simple)</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>

      <div class="settings-item" onclick="openSettingsPage('deactivate')">
        <i class="fa-regular fa-circle-xmark"></i>
        <div>
          <div style="font-weight:900;">Deactivate account</div>
          <div class="muted">Sign out + stop using</div>
        </div>
        <div class="right"><i class="fa-solid fa-chevron-right"></i></div>
      </div>
    </div>

    <!-- page: change username -->
    <div id="settingsChangeUsername" class="hidden">
      <div class="settings-page-title">
        <button class="secondary" onclick="openSettingsPage('accountInfo')"><i class="fa-solid fa-arrow-left"></i></button>
        <span>Change username</span>
      </div>

      <div class="card">
        <div class="muted" style="margin-bottom:8px;">New username</div>
        <input id="changeUsernameInput" placeholder="lowercase letters / numbers / underscore" maxlength="20"/>
        <div class="row" style="margin-top:10px;">
          <button onclick="changeUsername()">Save</button>
          <div class="space"></div>
          <span class="muted" id="changeUsernameStatus"></span>
        </div>
        <div class="muted" style="margin-top:10px;">
          Note: must be unique. (This is client-side. For real safety, also validate server-side.)
        </div>
      </div>
    </div>

    <!-- page: security -->
    <div id="settingsSecurity" class="hidden">
      <div class="settings-page-title">
        <button class="secondary" onclick="openSettingsPage('home')"><i class="fa-solid fa-arrow-left"></i></button>
        <span>Security</span>
      </div>

      <div class="card">
        <div style="font-weight:900;">Signed in as</div>
        <div class="muted" id="securityEmail">...</div>
        <div style="height:10px;"></div>
        <button class="danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- page: appearance -->
    <div id="settingsAppearance" class="hidden">
      <div class="settings-page-title">
        <button class="secondary" onclick="openSettingsPage('home')"><i class="fa-solid fa-arrow-left"></i></button>
        <span>Appearance</span>
      </div>

      <div class="card">
        <label class="row" style="gap:10px;">
          <input type="checkbox" id="darkToggle" style="width:auto;" />
          <span>Dark mode</span>
        </label>
      </div>
    </div>

    <!-- page: about -->
    <div id="settingsAbout" class="hidden">
      <div class="settings-page-title">
        <button class="secondary" onclick="openSettingsPage('home')"><i class="fa-solid fa-arrow-left"></i></button>
        <span>About</span>
      </div>

      <div class="card">
        <div style="font-weight:900;">EchoStream</div>
        <div class="muted">Version: 1.0</div>
        <div class="muted" style="margin-top:10px;">
          If something breaks, open DevTools ‚Üí Console and paste the error to fix fast.
        </div>
      </div>
    </div>

    <!-- page: download data -->
    <div id="settingsDownloadData" class="hidden">
      <div class="settings-page-title">
        <button class="secondary" onclick="openSettingsPage('accountInfo')"><i class="fa-solid fa-arrow-left"></i></button>
        <span>Download your data</span>
      </div>

      <div class="card">
        <div class="muted" style="margin-bottom:10px;">This exports basic info locally (no server). It will download a JSON file.</div>
        <button onclick="downloadMyData()">Download JSON</button>
        <div class="muted" id="downloadStatus" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- page: deactivate -->
    <div id="settingsDeactivate" class="hidden">
      <div class="settings-page-title">
        <button class="secondary" onclick="openSettingsPage('accountInfo')"><i class="fa-solid fa-arrow-left"></i></button>
        <span>Deactivate</span>
      </div>

      <div class="card">
        <div style="font-weight:900;">Deactivate account</div>
        <div class="muted" style="margin-top:6px;">
          This demo app can‚Äôt delete your Firebase Auth user from the client safely.
          The safe ‚Äúdeactivate‚Äù here just logs you out.
        </div>
        <div style="height:12px;"></div>
        <button class="danger" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

</main>

<!-- Bottom Nav -->
<nav>
  <div class="tab" id="tab-feed" onclick="route('feed')">
    <i class="fa-solid fa-house"></i><div class="muted" style="font-size:12px;">Feed</div>
  </div>
  <div class="tab" id="tab-search" onclick="route('search')">
    <i class="fa-solid fa-magnifying-glass"></i><div class="muted" style="font-size:12px;">Search</div>
  </div>
  <div class="tab" id="tab-messages" onclick="route('messages')">
    <i class="fa-solid fa-message"></i><div class="muted" style="font-size:12px;">Messages</div>
  </div>
  <div class="tab" id="tab-profile" onclick="route('profile')">
    <i class="fa-solid fa-user"></i><div class="muted" style="font-size:12px;">Profile</div>
  </div>
</nav>

<!-- Username Modal (first-time) -->
<div id="usernameModal" class="modal">
  <div class="box">
    <h3 style="margin:0 0 8px;">Pick a username</h3>
    <p class="muted" style="margin:0 0 12px;">Unique, lowercase letters/numbers/underscore only.</p>
    <input id="usernameInput" placeholder="username" maxlength="20"/>
    <div class="row" style="margin-top:12px;">
      <button onclick="saveUsername()">Save</button>
      <div class="space"></div>
      <span class="muted" id="usernameStatus"></span>
    </div>
  </div>
</div>

<!-- Followers/Following Modal -->
<div id="followModal" class="modal">
  <div class="box">
    <div class="row">
      <div id="followTitle" style="font-weight:900;">Followers</div>
      <div class="space"></div>
      <button class="secondary" onclick="closeFollowModal()">Close</button>
    </div>
    <div style="height:10px;"></div>
    <div id="followList" class="noselect"></div>
  </div>
</div>

<script>
  // =========================
  // FIREBASE CONFIG (yours)
  // =========================
  firebase.initializeApp({
    apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
    authDomain: "echostream-a102a.firebaseapp.com",
    projectId: "echostream-a102a",
    storageBucket: "echostream-a102a.appspot.com",
    messagingSenderId: "789062222400",
    appId: "1:789062222400:web:73d478269135a77d7d55a5"
  });

  const auth = firebase.auth();
  const db = firebase.firestore();

  // Storage optional
  let storage = null;
  try { storage = firebase.storage(); } catch(e) { storage = null; }

  let currentUser = null;
  let userData = null;

  // Messaging
  let activeChatUid = "AI";
  let chatUnsub = null;

  // Feed
  let feedUnsub = null;

  // =========================
  // Small safety: filter hateful usernames in UI
  // (You can expand this list.)
  // =========================
  const BANNED_SUBSTRINGS = [
    "nigger", "faggot", "kike", "spic", "chink"
  ];
  function isBannedUsername(name){
    const s = String(name || "").toLowerCase();
    return BANNED_SUBSTRINGS.some(w => s.includes(w));
  }
  function sanitizeUsernameForDisplay(name){
    const s = safeString(name, "user");
    if (isBannedUsername(s)) return "[blocked]";
    return s;
  }

  // =========================
  // UI helpers
  // =========================
  function openDrawer(){
    document.getElementById("drawerBackdrop").classList.add("show");
    document.getElementById("drawer").classList.add("show");
  }
  function closeDrawer(){
    document.getElementById("drawerBackdrop").classList.remove("show");
    document.getElementById("drawer").classList.remove("show");
  }

  function setActiveTab(page){
    ["feed","search","messages","profile"].forEach(p=>{
      const el = document.getElementById("tab-"+p);
      if (!el) return;
      el.classList.toggle("active", p===page);
    });
  }

  function showView(id){
    const views = ["loginView","feedView","searchView","messagesView","profileView","settingsView"];
    views.forEach(v => document.getElementById(v).classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  function setHeaderTitle(t){
    document.getElementById("headerTitle").textContent = t || "EchoStream";
  }

  function safeString(x, fallback=""){
    return (typeof x === "string" && x.trim().length) ? x : fallback;
  }
  function safeArray(x){
    return Array.isArray(x) ? x : [];
  }
  function initialLetter(name){
    const s = safeString(name, "?");
    return (s[0] ? s[0].toUpperCase() : "?");
  }

  function timeAgo(ts){
    if (!ts || !ts.toDate) return "now";
    const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
    if (seconds < 60) return seconds + "s";
    if (seconds < 3600) return Math.floor(seconds/60) + "m";
    if (seconds < 86400) return Math.floor(seconds/3600) + "h";
    return Math.floor(seconds/86400) + "d";
  }

  // =========================
  // AUTH
  // =========================
  function login(){
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }
  function logout(){
    auth.signOut().then(()=>location.reload());
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user){
      currentUser = null;
      userData = null;
      setHeaderTitle("EchoStream");
      showView("loginView");
      return;
    }

    currentUser = user;

    // Load or create user doc
    const userRef = db.collection("users").doc(user.uid);
    const snap = await userRef.get();

    if (!snap.exists){
      const auto = safeString(user.displayName, "user").replace(/\s/g,"").toLowerCase();
      await userRef.set({ username: auto, followers: [], following: [] });
      userData = { username: auto, followers: [], following: [] };
      document.getElementById("usernameModal").classList.add("show");
    } else {
      userData = snap.data() || {};
      if (!userData.username){
        userData.username = safeString(user.displayName, "user").replace(/\s/g,"").toLowerCase();
        await userRef.update({ username: userData.username });
      }
    }

    // Dark mode init
    const dark = localStorage.getItem("darkMode") === "true";
    document.body.classList.toggle("dark", dark);
    const dt = document.getElementById("darkToggle");
    if (dt) dt.checked = dark;

    // Start feed + chat
    route("feed");
    startFeedListener();
    setChatAI();

    // Update settings header lines
    refreshSettingsUI();
  });

  // Dark mode
  document.getElementById("darkToggle").addEventListener("change", (e)=>{
    const v = !!e.target.checked;
    document.body.classList.toggle("dark", v);
    localStorage.setItem("darkMode", String(v));
  });

  // =========================
  // ROUTING
  // =========================
  function route(page){
    if (!currentUser){
      showView("loginView");
      return;
    }

    closeDrawer();

    if (page === "feed"){
      setHeaderTitle("EchoStream");
      showView("feedView");
      setActiveTab("feed");
      startFeedListener();
      return;
    }
    if (page === "search"){
      setHeaderTitle("Search");
      showView("searchView");
      setActiveTab("search");
      document.getElementById("searchInput").value = "";
      document.getElementById("searchResults").innerHTML = "";
      return;
    }
    if (page === "messages"){
      setHeaderTitle("Messages");
      showView("messagesView");
      setActiveTab("messages");
      ensureChatListener();
      return;
    }
    if (page === "profile"){
      setHeaderTitle("Profile");
      showView("profileView");
      setActiveTab("profile");
      openProfile(currentUser.uid);
      return;
    }
    if (page === "settings"){
      setHeaderTitle("Settings");
      showView("settingsView");
      // settings default page
      openSettingsPage("home");
      return;
    }
  }

  // =========================
  // SETTINGS PAGES
  // =========================
  function hideAllSettingsPages(){
    const ids = [
      "settingsHome",
      "settingsAccountInfo",
      "settingsChangeUsername",
      "settingsSecurity",
      "settingsAppearance",
      "settingsAbout",
      "settingsDownloadData",
      "settingsDeactivate"
    ];
    ids.forEach(id => document.getElementById(id).classList.add("hidden"));
  }

  function openSettingsPage(which){
    hideAllSettingsPages();

    if (which === "home") document.getElementById("settingsHome").classList.remove("hidden");
    if (which === "accountInfo") document.getElementById("settingsAccountInfo").classList.remove("hidden");
    if (which === "changeUsername") document.getElementById("settingsChangeUsername").classList.remove("hidden");
    if (which === "security") document.getElementById("settingsSecurity").classList.remove("hidden");
    if (which === "appearance") document.getElementById("settingsAppearance").classList.remove("hidden");
    if (which === "about") document.getElementById("settingsAbout").classList.remove("hidden");
    if (which === "downloadData") document.getElementById("settingsDownloadData").classList.remove("hidden");
    if (which === "deactivate") document.getElementById("settingsDeactivate").classList.remove("hidden");

    refreshSettingsUI();
  }

  async function refreshSettingsUI(){
    if (!currentUser) return;

    // best current username from cache
    const uname = sanitizeUsernameForDisplay(safeString(userData?.username, "user"));
    const email = safeString(currentUser.email, "(no email)");

    const homeLine = document.getElementById("settingsUsernameLine");
    if (homeLine) homeLine.textContent = "@" + uname;

    const au = document.getElementById("accountUsername");
    if (au) au.textContent = uname;

    const ae = document.getElementById("accountEmail");
    if (ae) ae.textContent = email;

    const uid = document.getElementById("accountUid");
    if (uid) uid.textContent = "UID: " + currentUser.uid;

    const se = document.getElementById("securityEmail");
    if (se) se.textContent = email;

    // keep input placeholder
    const cui = document.getElementById("changeUsernameInput");
    if (cui && !cui.value) cui.value = safeString(userData?.username, "");
  }

  async function changeUsername(){
    const status = document.getElementById("changeUsernameStatus");
    status.textContent = "";

    const name = safeString(document.getElementById("changeUsernameInput").value, "").toLowerCase().trim();

    if (name.length < 3){
      status.textContent = "Too short (min 3).";
      return;
    }
    if (!/^[a-z0-9_]+$/.test(name)){
      status.textContent = "Only a-z 0-9 _";
      return;
    }
    if (isBannedUsername(name)){
      status.textContent = "That username isn‚Äôt allowed.";
      return;
    }

    // Must be unique
    const taken = await db.collection("users").where("username","==",name).limit(1).get();
    if (!taken.empty && taken.docs[0].id !== currentUser.uid){
      status.textContent = "Username taken.";
      return;
    }

    await db.collection("users").doc(currentUser.uid).update({ username: name });
    userData.username = name;

    status.textContent = "Saved.";
    setTimeout(()=>status.textContent="", 1200);

    refreshSettingsUI();
  }

  async function downloadMyData(){
    const status = document.getElementById("downloadStatus");
    status.textContent = "Building export...";

    try{
      const me = currentUser.uid;
      const userSnap = await db.collection("users").doc(me).get();
      const userDoc = userSnap.exists ? userSnap.data() : {};

      const postsSnap = await db.collection("posts").where("uid","==",me).get();
      const posts = [];
      postsSnap.forEach(d => posts.push({ id: d.id, ...d.data() }));

      const exportObj = {
        uid: me,
        email: currentUser.email || null,
        user: userDoc,
        posts: posts
      };

      const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "echostream_export.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      status.textContent = "Downloaded.";
      setTimeout(()=>status.textContent="", 1200);
    } catch(e){
      console.error(e);
      status.textContent = "Export failed: " + (e.message || String(e));
    }
  }

  // =========================
  // USERNAME (first-time modal)
  // =========================
  async function saveUsername(){
    const status = document.getElementById("usernameStatus");
    status.textContent = "";

    const name = safeString(document.getElementById("usernameInput").value, "").toLowerCase().trim();

    if (name.length < 3){
      status.textContent = "Too short (min 3).";
      return;
    }
    if (!/^[a-z0-9_]+$/.test(name)){
      status.textContent = "Only a-z 0-9 _";
      return;
    }
    if (isBannedUsername(name)){
      status.textContent = "That username isn‚Äôt allowed.";
      return;
    }

    const taken = await db.collection("users").where("username","==",name).limit(1).get();
    if (!taken.empty && taken.docs[0].id !== currentUser.uid){
      status.textContent = "Username taken.";
      return;
    }

    await db.collection("users").doc(currentUser.uid).update({ username: name });
    userData.username = name;

    document.getElementById("usernameModal").classList.remove("show");
    refreshSettingsUI();
  }

  // =========================
  // POSTS
  // =========================
  async function createPost(){
    const status = document.getElementById("postStatus");
    status.textContent = "";

    const text = safeString(document.getElementById("postText").value, "").trim();
    const file = document.getElementById("postImage").files[0];

    if (!text && !file){
      status.textContent = "Write something first.";
      return;
    }

    let imageUrl = "";
    if (file && storage){
      try{
        const path = `posts/${currentUser.uid}/${Date.now()}_${file.name}`;
        const ref = storage.ref(path);
        await ref.put(file);
        imageUrl = await ref.getDownloadURL();
      } catch(e){
        console.warn("Storage upload skipped:", e);
      }
    }

    const uname = safeString(userData?.username, "user");

    await db.collection("posts").add({
      uid: currentUser.uid,
      username: uname,
      text: text,
      imageUrl: imageUrl,
      likes: [],
      comments: [],
      shares: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("postText").value = "";
    document.getElementById("postImage").value = "";
    status.textContent = "Posted.";
    setTimeout(()=>status.textContent="", 1200);
  }

  function renderPost(doc){
    const post = doc.data() || {};
    const postId = doc.id;

    const usernameRaw = safeString(post.username, "user");
    const username = sanitizeUsernameForDisplay(usernameRaw);

    const likes = safeArray(post.likes);
    const comments = safeArray(post.comments);
    const shares = safeArray(post.shares);

    const liked = likes.includes(currentUser.uid);
    const avatar = initialLetter(username);

    const img = safeString(post.imageUrl, "");

    let commentsHtml = "";
    for (const c of comments){
      const cuRaw = safeString(c.username, "user");
      const cu = sanitizeUsernameForDisplay(cuRaw);
      const ct = safeString(c.text, "");
      commentsHtml += `
        <div class="comment">
          <div class="avatar">${initialLetter(cu)}</div>
          <div style="flex:1;">
            <div style="font-weight:800;">${escapeHtml(cu)}</div>
            <div class="muted">${escapeHtml(ct)}</div>
          </div>
        </div>
      `;
    }

    return `
      <div class="card">
        <div class="row">
          <div class="avatar">${avatar}</div>
          <div style="flex:1;">
            <div style="font-weight:900;">
              <span class="click" onclick="openProfile('${post.uid}')">${escapeHtml(username)}</span>
            </div>
            <div class="muted">${timeAgo(post.timestamp)}</div>
          </div>
        </div>

        ${post.text ? `<div style="margin-top:10px;">${escapeHtml(post.text)}</div>` : ""}

        ${img ? `<img class="post-image" src="${escapeAttr(img)}" alt="post image"/>` : ""}

        <div class="post-actions">
          <span onclick="toggleLike('${postId}')">
            <i class="${liked ? "fa-solid" : "fa-regular"} fa-heart"></i> ${likes.length}
          </span>
          <span onclick="toggleComments('${postId}')">
            <i class="fa-regular fa-comment"></i> ${comments.length}
          </span>
          <span onclick="sharePost('${postId}')">
            <i class="fa-solid fa-retweet"></i> ${shares.length}
          </span>
        </div>

        <div id="comments-${postId}" class="hidden" style="margin-top:12px;">
          ${commentsHtml}
          <div style="height:10px;"></div>
          <input id="commentInput-${postId}" placeholder="Write a comment..."/>
          <div class="row" style="margin-top:10px;">
            <button onclick="addComment('${postId}')">Send</button>
            <div class="space"></div>
          </div>
        </div>
      </div>
    `;
  }

  function startFeedListener(){
    if (feedUnsub) return;
    const postsDiv = document.getElementById("posts");
    postsDiv.innerHTML = `<div class="muted">Loading feed...</div>`;

    feedUnsub = db.collection("posts")
      .orderBy("timestamp","desc")
      .onSnapshot((snap)=>{
        let html = "";
        snap.forEach(doc => { html += renderPost(doc); });
        postsDiv.innerHTML = html || `<div class="muted">No posts yet.</div>`;
      }, (err)=>{
        console.error("Feed listen error:", err);
        postsDiv.innerHTML = `<div class="muted">Feed error: ${escapeHtml(err.message || String(err))}</div>`;
      });
  }

  async function toggleLike(postId){
    const ref = db.collection("posts").doc(postId);
    const snap = await ref.get();
    const data = snap.data() || {};
    let likes = safeArray(data.likes);

    if (likes.includes(currentUser.uid)){
      likes = likes.filter(x => x !== currentUser.uid);
    } else {
      likes.push(currentUser.uid);
    }
    await ref.update({ likes: likes });
  }

  function toggleComments(postId){
    const el = document.getElementById(`comments-${postId}`);
    if (!el) return;
    el.classList.toggle("hidden");
  }

  async function addComment(postId){
    const input = document.getElementById(`commentInput-${postId}`);
    if (!input) return;
    const text = safeString(input.value, "").trim();
    if (!text) return;

    const comment = {
      uid: currentUser.uid,
      username: safeString(userData?.username, "user"),
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("posts").doc(postId).update({
      comments: firebase.firestore.FieldValue.arrayUnion(comment)
    });

    input.value = "";
  }

  async function sharePost(postId){
    await db.collection("posts").doc(postId).update({
      shares: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });
  }

  // =========================
  // PROFILES + FOLLOWERS
  // =========================
  async function openProfile(uid){
    showView("profileView");
    setActiveTab("profile");
    setHeaderTitle("Profile");

    const profile = document.getElementById("profileView");
    profile.innerHTML = `<div class="muted">Loading profile...</div>`;

    try{
      const userSnap = await db.collection("users").doc(uid).get();
      if (!userSnap.exists){
        profile.innerHTML = `<div class="card">User not found.</div>`;
        return;
      }

      const u = userSnap.data() || {};
      const usernameRaw = safeString(u.username, "user");
      const username = sanitizeUsernameForDisplay(usernameRaw);

      const followers = safeArray(u.followers);
      const following = safeArray(u.following);

      const isMe = uid === currentUser.uid;
      const iFollow = followers.includes(currentUser.uid);

      // user posts (may require composite index: uid + timestamp desc)
      let postsHtml = "";
      const postsSnap = await db.collection("posts")
        .where("uid","==",uid)
        .orderBy("timestamp","desc")
        .get();

      postsSnap.forEach(doc=>{
        const p = doc.data() || {};
        const txt = safeString(p.text, "");
        const img = safeString(p.imageUrl, "");
        postsHtml += `
          <div class="card">
            ${txt ? `<div>${escapeHtml(txt)}</div>` : ""}
            ${img ? `<img class="post-image" src="${escapeAttr(img)}" alt="post image"/>` : ""}
            <div class="muted" style="margin-top:8px;">${timeAgo(p.timestamp)}</div>
          </div>
        `;
      });

      profile.innerHTML = `
        <div class="card" style="text-align:center;">
          <div class="avatar" style="width:64px;height:64px;margin:0 auto;font-size:24px;">${initialLetter(username)}</div>
          <div style="margin-top:10px; font-size:20px; font-weight:900;">${escapeHtml(username)}</div>
          <div class="muted">UID: ${escapeHtml(uid)}</div>

          <div class="row noselect" style="justify-content:center; gap:14px; margin-top:12px;">
            <button type="button" class="stat-btn" onclick="openFollowList('${uid}','followers')">
              <div class="stat-num">${followers.length}</div>
              <div class="stat-label">Followers</div>
            </button>
            <button type="button" class="stat-btn" onclick="openFollowList('${uid}','following')">
              <div class="stat-num">${following.length}</div>
              <div class="stat-label">Following</div>
            </button>
          </div>

          ${isMe ? "" : `
            <div style="margin-top:12px;">
              <button onclick="toggleFollow('${uid}')">${iFollow ? "Unfollow" : "Follow"}</button>
              <button class="secondary" style="margin-left:8px;" onclick="startChatWith('${uid}','${escapeAttr(username)}')">Message</button>
            </div>
          `}
        </div>

        <div style="font-weight:900; margin:10px 0 8px;">Posts</div>
        ${postsHtml || `<div class="muted">No posts yet.</div>`}
      `;
    } catch(e){
      console.error(e);
      profile.innerHTML = `<div class="card">Profile error: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  async function toggleFollow(targetUid){
    // IMPORTANT:
    // If you still get "Missing or insufficient permissions" here,
    // it means your Firestore RULES do NOT allow writing to the *target user's* doc.
    // That is a RULES problem (not HTML).
    const meUid = currentUser.uid;

    const myRef = db.collection("users").doc(meUid);
    const targetRef = db.collection("users").doc(targetUid);

    const [mySnap, targetSnap] = await Promise.all([myRef.get(), targetRef.get()]);
    const my = mySnap.data() || {};
    const t = targetSnap.data() || {};

    let following = safeArray(my.following);
    let followers = safeArray(t.followers);

    const iAlreadyFollow = following.includes(targetUid);

    if (iAlreadyFollow){
      following = following.filter(x => x !== targetUid);
      followers = followers.filter(x => x !== meUid);
    } else {
      following.push(targetUid);
      followers.push(meUid);
    }

    await Promise.all([
      myRef.update({ following }),
      targetRef.update({ followers })
    ]);

    openProfile(targetUid);
  }

  // Followers/Following modal
  function closeFollowModal(){
    document.getElementById("followModal").classList.remove("show");
    document.getElementById("followList").innerHTML = "";
  }

  async function openFollowList(profileUid, mode){
    const title = mode === "followers" ? "Followers" : "Following";
    document.getElementById("followTitle").textContent = title;
    document.getElementById("followModal").classList.add("show");

    const listEl = document.getElementById("followList");
    listEl.innerHTML = `<div class="muted">Loading ${title.toLowerCase()}...</div>`;

    try{
      const userSnap = await db.collection("users").doc(profileUid).get();
      if (!userSnap.exists){
        listEl.innerHTML = `<div class="muted">User not found.</div>`;
        return;
      }

      const data = userSnap.data() || {};
      const ids = Array.isArray(data[mode]) ? data[mode] : [];

      if (ids.length === 0){
        listEl.innerHTML = `<div class="muted">No ${title.toLowerCase()} yet.</div>`;
        return;
      }

      // Firestore "in" query limit is 10
      const chunks = [];
      for (let i=0; i<ids.length; i+=10) chunks.push(ids.slice(i,i+10));

      let html = "";
      for (const chunk of chunks){
        const qs = await db.collection("users")
          .where(firebase.firestore.FieldPath.documentId(), "in", chunk)
          .get();

        qs.forEach(doc=>{
          const u = doc.data() || {};
          const unameRaw = safeString(u.username, "user");
          const uname = sanitizeUsernameForDisplay(unameRaw);

          html += `
            <div class="card">
              <div class="row">
                <div class="avatar">${initialLetter(uname)}</div>
                <div style="flex:1;">
                  <div style="font-weight:900;" class="click"
                    onclick="closeFollowModal(); openProfile('${doc.id}')">
                    ${escapeHtml(uname)}
                  </div>
                  <div class="muted">${escapeHtml(doc.id)}</div>
                </div>
                ${doc.id === currentUser.uid ? "" : `
                  <button class="secondary" onclick="startChatWith('${doc.id}','${escapeAttr(uname)}')">Message</button>
                `}
              </div>
            </div>
          `;
        });
      }

      listEl.innerHTML = html;
    } catch(e){
      console.error(e);
      listEl.innerHTML = `<div class="card">Error: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  // =========================
  // SEARCH (prefix query)
  // =========================
  let searchTimer = null;

  function doSearch(){
    clearTimeout(searchTimer);
    searchTimer = setTimeout(runSearch, 200);
  }

  async function runSearch(){
    const q = safeString(document.getElementById("searchInput").value, "").toLowerCase().trim();
    const res = document.getElementById("searchResults");

    if (!q){
      res.innerHTML = "";
      return;
    }

    res.innerHTML = `<div class="muted">Searching...</div>`;

    try{
      const snap = await db.collection("users")
        .orderBy("username")
        .startAt(q)
        .endAt(q + "\uf8ff")
        .limit(20)
        .get();

      let html = "";
      snap.forEach(doc=>{
        const u = doc.data() || {};
        const unameRaw = safeString(u.username, "");
        if (!unameRaw) return;

        const uname = sanitizeUsernameForDisplay(unameRaw);

        html += `
          <div class="card">
            <div class="row">
              <div class="avatar">${initialLetter(uname)}</div>
              <div style="flex:1;">
                <div style="font-weight:900;" class="click" onclick="openProfile('${doc.id}')">${escapeHtml(uname)}</div>
                <div class="muted">${escapeHtml(doc.id)}</div>
              </div>
              <button class="secondary" onclick="startChatWith('${doc.id}','${escapeAttr(uname)}')">Message</button>
            </div>
          </div>
        `;
      });

      res.innerHTML = html || `<div class="muted">No matches.</div>`;
    } catch(e){
      console.error(e);
      res.innerHTML = `<div class="card">Search error: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  // =========================
  // MESSAGES
  // =========================
  function chatId(a,b){
    return (a < b) ? `${a}_${b}` : `${b}_${a}`;
  }

  function setChatAI(){
    activeChatUid = "AI";
    document.getElementById("chatWith").textContent = "Chatting with: EchoBot";
    ensureChatListener();
  }

  function startChatWith(uid, username){
    activeChatUid = uid;
    document.getElementById("chatWith").textContent = "Chatting with: " + safeString(username, uid);
    route("messages");
    ensureChatListener();
  }

  function ensureChatListener(){
    if (!currentUser) return;

    // stop old listener
    if (chatUnsub){
      chatUnsub();
      chatUnsub = null;
    }

    const me = currentUser.uid;
    const other = (activeChatUid === "AI") ? "AI" : activeChatUid;
    const cid = chatId(me, other);

    const box = document.getElementById("chatBox");
    box.innerHTML = `<div class="muted">Loading chat...</div>`;

    chatUnsub = db.collection("messages")
      .doc(cid)
      .collection("messages")
      .orderBy("timestamp","asc")
      .limit(200)
      .onSnapshot((snap)=>{
        let html = "";
        snap.forEach(doc=>{
          const m = doc.data() || {};
          const unameRaw = safeString(m.username, m.uid === "AI" ? "EchoBot" : "user");
          const uname = sanitizeUsernameForDisplay(unameRaw);
          const text = safeString(m.text, "");
          const mine = m.uid === currentUser.uid;

          html += `
            <div class="card" style="margin:8px 0; padding:10px; border-radius:14px; ${mine ? "border-color: rgba(29,161,242,.6);" : ""}">
              <div style="font-weight:900;">${escapeHtml(uname)}</div>
              <div>${escapeHtml(text)}</div>
            </div>
          `;
        });
        box.innerHTML = html || `<div class="muted">No messages yet.</div>`;
        box.scrollTop = box.scrollHeight;
      }, (err)=>{
        console.error("Chat listen error:", err);
        box.innerHTML = `<div class="card">Chat error: ${escapeHtml(err.message || String(err))}</div>`;
      });
  }

  async function sendMessage(){
    const status = document.getElementById("msgStatus");
    status.textContent = "";

    const input = document.getElementById("chatInput");
    const text = safeString(input.value, "").trim();
    if (!text) return;

    // IMPORTANT FIX: capture text BEFORE clearing input (prevents "same thing" bugs)
    input.value = "";

    const me = currentUser.uid;
    const other = (activeChatUid === "AI") ? "AI" : activeChatUid;
    const cid = chatId(me, other);

    try{
      await db.collection("messages")
        .doc(cid)
        .collection("messages")
        .add({
          uid: me,
          username: safeString(userData?.username, "user"),
          text: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

      if (other === "AI"){
        aiReply(cid, text);
      }
    } catch(e){
      console.error(e);
      status.textContent = "Send failed: " + (e.message || String(e));
    }
  }

  async function aiReply(cid, userText){
    const t = (userText || "").toLowerCase();
    let msg = "Tell me more.";

    if (t.includes("hi") || t.includes("hello")) msg = "Hey! What are you up to today?";
    else if (t.includes("wsp") || t.includes("what's up")) msg = "Not much üòÑ Want to post something or message someone?";
    else if (t.includes("help")) msg = "Tell me what‚Äôs broken and paste the console error.";
    else if (t.includes("joke")) msg = "Why did the dev go broke? Because he used up all his cache.";
    else if (t.includes("bye")) msg = "Bye! Come back anytime.";

    setTimeout(async ()=>{
      try{
        await db.collection("messages")
          .doc(cid)
          .collection("messages")
          .add({
            uid: "AI",
            username: "EchoBot",
            text: msg,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
      } catch(e){
        console.warn("AI reply failed:", e);
      }
    }, 650);
  }

  // =========================
  // HTML escaping
  // =========================
  function escapeHtml(str){
    str = String(str ?? "");
    return str
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return escapeHtml(str);
  }
</script>

</body>
</html>