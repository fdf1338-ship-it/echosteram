<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchoStream</title>

<!-- Firebase JS SDK v9 compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --bg:#fff; --text:#000; --card:#f3f3f3; --border:#ddd; --accent:#1da1f2; --red:#ff0000;
}
body.dark { --bg:#000; --text:#fff; --card:#1a1a1a; --border:#333; }
body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); transition:0.3s; }
header { position:fixed; top:0; left:0; right:0; padding:14px; background:var(--bg); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; font-weight:bold; z-index:10; }
nav { position:fixed; bottom:0; left:0; right:0; display:flex; justify-content:space-around; padding:12px 0; background:var(--bg); border-top:1px solid var(--border); }
nav i{font-size:20px; cursor:pointer;}
main{padding:80px 16px 90px; max-width:600px; margin:auto;}
.card{background:var(--card); padding:16px; border-radius:16px; margin-bottom:12px;}
textarea,input{width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text); box-sizing:border-box;}
button{background:var(--accent); color:white; border:none; padding:10px 18px; border-radius:999px; font-weight:600; margin-top:8px; cursor:pointer;}
.hidden{display:none;}
.avatar{width:60px; height:60px; border-radius:50%; background:#666; color:white; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:700;}
.verified{color:#1da1f2; margin-left:6px;}
.post-image{max-width:100%; border-radius:12px; margin-top:8px;}
.comment{display:flex; gap:12px; margin-top:8px;}
.comment-body{flex:1;}
.modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:50;}
.modal-content{background:var(--card); padding:32px; border-radius:16px; width:90%; max-width:400px; text-align:center;}
.username-link { cursor:pointer; }
.username-link:hover { text-decoration:underline; }
</style>
</head>
<body>

<header>
  EchoStream
  <i class="fas fa-cog" onclick="route('settings')"></i>
</header>

<main>
<!-- LOGIN -->
<div id="login">
  <h2>Welcome to EchoStream</h2>
  <button onclick="login()">Sign in with Google</button>
</div>

<!-- FEED -->
<div id="feed" class="hidden">
  <div class="card">
    <textarea id="postText" placeholder="Whatâ€™s happening?"></textarea>
    <input type="file" id="postImage" accept="image/*" style="margin-top:8px;">
    <button onclick="createPost()">Post</button>
  </div>
  <div id="posts"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden"></div>

<!-- SETTINGS -->
<div id="settings" class="hidden">
  <div class="card">
    <h3>Settings</h3>
    <label><input type="checkbox" id="darkToggle"> Dark mode</label><br><br>
    <label><input type="checkbox" id="privateToggle"> Private account</label><br><br>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<!-- ADMIN -->
<div id="admin" class="hidden">
  <div class="card">
    <h3>Admin Panel</h3>
    <input id="verifyUid" placeholder="User UID to verify">
    <button onclick="verifyUser()">Verify User</button>
  </div>
  <div id="adminPanel"></div>
</div>

<!-- USERNAME MODAL -->
<div id="usernameModal" class="modal">
  <div class="modal-content">
    <h3>Pick a username</h3>
    <input id="usernameInput" placeholder="username" maxlength="20">
    <button onclick="saveUsername()">Save</button>
  </div>
</div>

</main>

<nav>
  <i class="fa fa-house" onclick="route('feed')"></i>
  <i class="fa fa-user" onclick="route('profile')"></i>
  <i class="fa fa-gear" onclick="route('settings')"></i>
  <i class="fa fa-shield" onclick="route('admin')"></i>
</nav>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "PASTE_YOUR_API_KEY_HERE",
  authDomain: "PASTE_YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "PASTE_YOUR_PROJECT_ID",
  storageBucket: "PASTE_YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "PASTE_YOUR_MESSAGING_SENDER_ID",
  appId: "PASTE_YOUR_APP_ID",
  measurementId: "PASTE_YOUR_MEASUREMENT_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let currentUser = null;
let userData = null;

// ===== AUTH =====
function login() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout() {
  auth.signOut().then(() => location.reload());
}

auth.onAuthStateChanged(async user => {
  if (!user) {
    document.getElementById("login").style.display = "block";
    ["feed","profile","settings","admin"].forEach(p => document.getElementById(p).classList.add("hidden"));
    return;
  }
  currentUser = user;
  document.getElementById("login").style.display = "none";

  const userRef = db.collection("users").doc(user.uid);
  const snap = await userRef.get();

  if (!snap.exists) {
    // New user
    await userRef.set({
      username: user.displayName?.replace(/\s/g,"").toLowerCase() || "user",
      verified: false,
      role: "user",
      private: false,
      followers: [],
      following: []
    });
    document.getElementById("usernameModal").style.display = "flex";
  } else {
    userData = snap.data();
    document.getElementById("darkToggle").checked = localStorage.getItem("darkMode") === "true";
    document.getElementById("privateToggle").checked = userData.private || false;
  }

  if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark");

  route("feed");
});

// ===== ROUTING =====
function route(page) {
  ["feed","profile","settings","admin"].forEach(p => document.getElementById(p).classList.add("hidden"));
  document.getElementById(page).classList.remove("hidden");

  if (page === "profile") loadProfile(currentUser.uid);
  if (page === "admin") {
    if (!userData || !["owner","admin"].includes(userData.role)) {
      alert("Admins only");
      route("feed");
    } else loadAdminPanel();
  }
}

// ===== DARK MODE =====
document.getElementById("darkToggle").onchange = function() {
  document.body.classList.toggle("dark", this.checked);
  localStorage.setItem("darkMode", this.checked);
};

// ===== PRIVATE ACCOUNT =====
document.getElementById("privateToggle").onchange = function() {
  togglePrivate(this.checked);
};

async function togglePrivate(isPrivate) {
  await db.collection("users").doc(currentUser.uid).update({ private: isPrivate });
  userData.private = isPrivate;
  alert(`Account is now ${isPrivate ? "private" : "public"}`);
  loadFeed();
}

// ===== POST FUNCTIONS =====
async function createPost() {
  const text = document.getElementById("postText").value.trim();
  const file = document.getElementById("postImage").files[0];
  if (!text && !file) return alert("Post cannot be empty");

  let imageUrl = "";
  if (file) {
    const ref = storage.ref("posts/" + currentUser.uid + "/" + Date.now() + "_" + file.name);
    await ref.put(file);
    imageUrl = await ref.getDownloadURL();
  }

  await db.collection("posts").add({
    uid: currentUser.uid,
    username: userData.username,
    text,
    imageUrl,
    likes: [],
    comments: [],
    reposts: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("postText").value = "";
  document.getElementById("postImage").value = "";
  loadFeed();
}

function createPostElement(post) {
  const div = document.createElement("div");
  div.className = "card";
  const liked = post.likes?.includes(currentUser.uid);
  const verifiedBadge = post.verified ? `<span class="verified"><i class="fas fa-check-circle"></i></span>` : "";

  let commentsHtml = "";
  (post.comments || []).forEach(c => {
    commentsHtml += `<div class="comment"><div class="avatar" style="width:36px;height:36px;font-size:18px;">${c.username[0].toUpperCase()}</div><div class="comment-body"><strong>${c.username}</strong><br><small>${c.text}</small></div></div>`;
  });

  div.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;">
      <div class="avatar">${post.username[0].toUpperCase()}</div>
      <div>
        <strong class="username-link" onclick="viewUserProfile('${post.username}')">${post.username}</strong> ${verifiedBadge}<br>
        <small>${timeAgo(post.timestamp)}</small>
      </div>
    </div>
    <p style="margin:12px 0;">${post.text || ""}</p>
    ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image">` : ""}
    <div style="display:flex;gap:20px;margin-top:8px;">
      <span style="cursor:pointer;" onclick="toggleLike('${post.id}')">
        <i class="${liked ? "fas" : "far"} fa-heart"></i> ${post.likes.length}
      </span>
      <span style="cursor:pointer;" onclick="toggleComments('${post.id}')">
        <i class="far fa-comment"></i> ${post.comments.length}
      </span>
      <span style="cursor:pointer;" onclick="repost('${post.id}')">
        <i class="fas fa-retweet"></i> ${post.reposts.length}
      </span>
    </div>
    <div id="comments-${post.id}" class="hidden">
      <div id="comments-list-${post.id}">${commentsHtml}</div>
      <input type="text" placeholder="Write a comment..." id="comment-input-${post.id}">
      <button onclick="addComment('${post.id}')">Send</button>
    </div>
  `;
  return div;
}

async function loadFeed() {
  const postsDiv = document.getElementById("posts");
  postsDiv.innerHTML = "<p>Loading feed...</p>";

  db.collection("posts").orderBy("timestamp", "desc").onSnapshot(async snapshot => {
    postsDiv.innerHTML = "";
    const myFollowing = userData?.following || [];
    const myUid = currentUser.uid;

    for (const doc of snapshot.docs) {
      const post = { id: doc.id, ...doc.data() };
      if (post.uid !== myUid) {
        const posterSnap = await db.collection("users").doc(post.uid).get();
        const posterData = posterSnap.data();
        if (posterData?.private && !myFollowing.includes(post.uid)) continue;
      }
      postsDiv.appendChild(createPostElement(post));
    }
  });
}

// ===== Remaining functions: timeAgo, toggleLike, addComment, toggleComments, repost, profile, admin, username modal =====
// ... (You can copy remaining from the previous code for brevity)

</script>
</body>
</html>