<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EchoStream</title>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#666;
      --card:#f3f3f3; --border:#ddd;
      --accent:#1da1f2; --danger:#ff3b30;
    }
    body.dark{
      --bg:#0b0b0b; --text:#fff; --muted:#aaa;
      --card:#151515; --border:#2a2a2a;
    }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{
      position:fixed; top:0; left:0; right:0;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 14px;
      background:var(--bg);
      border-bottom:1px solid var(--border);
      z-index:20;
      font-weight:800;
    }
    header .left{display:flex; align-items:center; gap:10px;}
    header .icon-btn{
      width:40px; height:40px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    header .icon-btn:hover{ background:rgba(127,127,127,.12); }

    main{
      padding:72px 14px 88px;
      max-width:640px; margin:0 auto;
    }

    nav{
      position:fixed; bottom:0; left:0; right:0;
      display:flex; justify-content:space-around; align-items:center;
      padding:10px 0;
      background:var(--bg);
      border-top:1px solid var(--border);
      z-index:20;
    }
    nav .tab{
      width:25%;
      display:flex; flex-direction:column; align-items:center;
      gap:6px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      padding:6px 0;
    }
    nav .tab.active{ color:var(--accent); }
    nav i{ font-size:20px; }

    .hidden{ display:none !important; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      margin-bottom:12px;
    }

    textarea, input{
      width:100%;
      box-sizing:border-box;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; }

    button{
      border:none;
      background:var(--accent);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-weight:700;
      cursor:pointer;
    }
    button.secondary{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
    }
    button.danger{ background:var(--danger); }

    .row{ display:flex; gap:10px; align-items:center; }
    .space{ flex:1; }

    .avatar{
      width:42px; height:42px;
      border-radius:999px;
      background:#666;
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      font-weight:800;
    }
    .post-image{
      margin-top:10px;
      max-width:100%;
      border-radius:14px;
      border:1px solid var(--border);
    }

    .muted{ color:var(--muted); font-size:13px; }
    .click{ cursor:pointer; }
    .click:hover{ text-decoration:underline; }

    .post-actions{
      display:flex; gap:18px;
      margin-top:10px;
      color:var(--muted);
      user-select:none;
    }
    .post-actions span{ cursor:pointer; }
    .post-actions span:hover{ color:var(--text); }

    .comment{
      display:flex; gap:10px;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--border);
    }
    .comment .avatar{ width:34px; height:34px; font-size:14px; }

    /* Drawer */
    .drawer-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      z-index:50;
      display:none;
    }
    .drawer-backdrop.show{ display:block; }

    .drawer{
      position:fixed; top:0; left:-320px;
      width:300px; height:100%;
      background:var(--bg);
      border-right:1px solid var(--border);
      z-index:60;
      padding:14px;
      transition:left .2s ease;
    }
    .drawer.show{ left:0; }

    .drawer h3{ margin:6px 0 10px; }
    .drawer .item{
      padding:12px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex; gap:10px; align-items:center;
    }
    .drawer .item:hover{ background:rgba(127,127,127,.12); }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      z-index:80;
      padding:14px;
    }
    .modal.show{ display:flex; }
    .modal .box{
      width:100%;
      max-width:420px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
    }

    /* Settings list (X-like) */
    .settings-title{
      font-weight:900;
      font-size:20px;
      margin:0 0 10px;
    }
    .settings-search{
      border-radius:999px;
      padding:12px 14px;
    }
    .settings-list .s-item{
      display:flex; gap:12px; align-items:flex-start;
      padding:14px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .settings-list .s-item:hover{ background:rgba(127,127,127,.10); }
    .settings-list .s-icon{
      width:34px; height:34px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted);
      margin-top:2px;
    }
    .settings-list .s-main{ flex:1; }
    .settings-list .s-h{
      font-weight:900;
      margin:0 0 2px;
    }
    .settings-list .s-p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.25;
    }
    .settings-row{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 10px;
      border-radius:12px;
      cursor:pointer;
    }
    .settings-row:hover{ background:rgba(127,127,127,.10); }
    .pill{
      display:inline-flex;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      gap:6px;
      align-items:center;
    }
  </style>
</head>

<body>

<header>
  <div class="left">
    <!-- Back button (hidden until needed) -->
    <div id="backBtn" class="icon-btn hidden" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></div>

    <!-- Burger button (hidden on subpages) -->
    <div id="burgerBtn" class="icon-btn" onclick="openDrawer()"><i class="fa-solid fa-bars"></i></div>

    <div id="headerTitle">EchoStream</div>
  </div>

  <div id="headerRight" class="icon-btn" onclick="route('settings')"><i class="fa-solid fa-gear"></i></div>
</header>

<!-- Drawer -->
<div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
<div id="drawer" class="drawer">
  <div class="row">
    <div style="font-weight:900;">Menu</div>
    <div class="space"></div>
    <div class="icon-btn" onclick="closeDrawer()"><i class="fa-solid fa-xmark"></i></div>
  </div>
  <div style="height:8px;"></div>
  <div class="item" onclick="route('feed'); closeDrawer();"><i class="fa-solid fa-house"></i> Feed</div>
  <div class="item" onclick="route('search'); closeDrawer();"><i class="fa-solid fa-magnifying-glass"></i> Search</div>
  <div class="item" onclick="route('messages'); closeDrawer();"><i class="fa-solid fa-message"></i> Messages</div>
  <div class="item" onclick="route('profile'); closeDrawer();"><i class="fa-solid fa-user"></i> Profile</div>
  <div class="item" onclick="route('settings'); closeDrawer();"><i class="fa-solid fa-gear"></i> Settings</div>
</div>

<main>

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <h2 style="margin:0 0 8px;">Welcome to EchoStream</h2>
    <p class="muted" style="margin:0 0 12px;">Sign in to post, follow, message, and search.</p>
    <button onclick="login()">Sign in with Google</button>
  </div>

  <!-- FEED -->
  <div id="feedView" class="hidden">
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Post</div>
      <textarea id="postText" placeholder="What’s happening?"></textarea>

      <!-- If you don’t want Storage/images, you can just ignore this input -->
      <div style="height:10px;"></div>
      <input id="postImage" type="file" accept="image/*"/>

      <div class="row" style="margin-top:10px;">
        <button onclick="createPost()">Post</button>
        <div class="space"></div>
        <span class="muted" id="postStatus"></span>
      </div>
    </div>

    <div id="posts"></div>
  </div>

  <!-- SEARCH -->
  <div id="searchView" class="hidden">
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Search users</div>
      <input id="searchInput" placeholder="Search by username..." oninput="doSearch()"/>
    </div>
    <div id="searchResults"></div>
  </div>

  <!-- MESSAGES -->
  <div id="messagesView" class="hidden">
    <div class="card">
      <div class="row">
        <div style="font-weight:800;">Chat</div>
        <div class="space"></div>
        <button class="secondary" onclick="setChatAI()">EchoBot</button>
      </div>
      <div class="muted" id="chatWith" style="margin-top:6px;">Chatting with: EchoBot</div>
    </div>

    <div class="card" style="padding:10px;">
      <div id="chatBox" style="height:320px; overflow:auto;"></div>
    </div>

    <div class="card">
      <input id="chatInput" placeholder="Type a message..."/>
      <div class="row" style="margin-top:10px;">
        <button onclick="sendMessage()">Send</button>
        <div class="space"></div>
        <span class="muted" id="msgStatus"></span>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profileView" class="hidden"></div>

  <!-- SETTINGS (Home) -->
  <div id="settingsHomeView" class="hidden">
    <div class="card">
      <div class="settings-title">Settings</div>
      <input id="settingsSearch" class="settings-search" placeholder="Search settings..." oninput="filterSettings()"/>
      <div style="height:10px;"></div>

      <div id="settingsList" class="settings-list">
        <div class="s-item" data-keywords="your account account info password download archive deactivate" onclick="openSettingsPage('account')">
          <div class="s-icon"><i class="fa-regular fa-user"></i></div>
          <div class="s-main">
            <div class="s-h">Your account</div>
            <p class="s-p">See info about your account, download an archive of your data, or learn about deactivation options.</p>
          </div>
          <div class="s-icon"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <div class="s-item" data-keywords="security account access password sessions apps" onclick="openSettingsPage('security')">
          <div class="s-icon"><i class="fa-solid fa-lock"></i></div>
          <div class="s-main">
            <div class="s-h">Security and account access</div>
            <p class="s-p">Manage your account’s security and keep track of account usage.</p>
          </div>
          <div class="s-icon"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <div class="s-item" data-keywords="privacy safety block mute content" onclick="openSettingsPage('privacy')">
          <div class="s-icon"><i class="fa-regular fa-circle-check"></i></div>
          <div class="s-main">
            <div class="s-h">Privacy and safety</div>
            <p class="s-p">Manage what information you see and share on EchoStream.</p>
          </div>
          <div class="s-icon"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <div class="s-item" data-keywords="notifications push email alerts" onclick="openSettingsPage('notifications')">
          <div class="s-icon"><i class="fa-regular fa-bell"></i></div>
          <div class="s-main">
            <div class="s-h">Notifications</div>
            <p class="s-p">Select the kinds of notifications you get about activity and recommendations.</p>
          </div>
          <div class="s-icon"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <div class="s-item" data-keywords="accessibility display language dark mode" onclick="openSettingsPage('accessibility')">
          <div class="s-icon"><i class="fa-solid fa-universal-access"></i></div>
          <div class="s-main">
            <div class="s-h">Accessibility, display and languages</div>
            <p class="s-p">Manage how EchoStream content is displayed to you.</p>
          </div>
          <div class="s-icon"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <div class="s-item" data-keywords="resources help about terms" onclick="openSettingsPage('resources')">
          <div class="s-icon"><i class="fa-solid fa-ellipsis"></i></div>
          <div class="s-main">
            <div class="s-h">Additional resources</div>
            <p class="s-p">Helpful info to learn more about EchoStream.</p>
          </div>
          <div class="s-icon"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:10px;">
        <input type="checkbox" id="darkToggle" style="width:auto;" />
        <div>
          <div style="font-weight:900;">Dark mode</div>
          <div class="muted">Toggle dark theme</div>
        </div>
        <div class="space"></div>
      </div>
      <div style="height:12px;"></div>
      <button class="danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- SETTINGS: Your account -->
  <div id="accountView" class="hidden">
    <div class="card">
      <div class="row">
        <div style="font-weight:900; font-size:18px;">Your account</div>
        <div class="space"></div>
        <span class="pill"><i class="fa-regular fa-user"></i> <span id="accountAt">@username</span></span>
      </div>
      <div class="muted" style="margin-top:8px;">
        See information about your account, download an archive of your data, or learn about account deactivation options.
      </div>
    </div>

    <div class="card settings-list">
      <div class="settings-row" onclick="openSettingsPage('accountInfo')">
        <div>
          <div style="font-weight:900;">Account information</div>
          <div class="muted">See your account info like your email and user id.</div>
        </div>
        <i class="fa-solid fa-chevron-right" style="color:var(--muted)"></i>
      </div>

      <div class="settings-row" onclick="openSettingsPage('changePassword')">
        <div>
          <div style="font-weight:900;">Change your password</div>
          <div class="muted">Password changes depend on your sign-in provider.</div>
        </div>
        <i class="fa-solid fa-chevron-right" style="color:var(--muted)"></i>
      </div>

      <div class="settings-row" onclick="openSettingsPage('downloadData')">
        <div>
          <div style="font-weight:900;">Download an archive of your data</div>
          <div class="muted">Export your posts and profile info (basic).</div>
        </div>
        <i class="fa-solid fa-chevron-right" style="color:var(--muted)"></i>
      </div>

      <div class="settings-row" onclick="openSettingsPage('deactivate')">
        <div>
          <div style="font-weight:900;">Deactivate account</div>
          <div class="muted">Temporarily disable your account (basic).</div>
        </div>
        <i class="fa-solid fa-chevron-right" style="color:var(--muted)"></i>
      </div>
    </div>
  </div>

  <!-- SETTINGS: Account information -->
  <div id="accountInfoView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Account information</div>
      <div class="muted" style="margin-top:8px;">Basic account details.</div>

      <div style="height:12px;"></div>

      <div class="settings-row" style="cursor:default;">
        <div>
          <div style="font-weight:900;">Username</div>
          <div class="muted" id="infoUsername">@username</div>
        </div>
      </div>

      <div class="settings-row" style="cursor:default;">
        <div>
          <div style="font-weight:900;">Email</div>
          <div class="muted" id="infoEmail">email</div>
        </div>
      </div>

      <div class="settings-row" style="cursor:default;">
        <div>
          <div style="font-weight:900;">User ID</div>
          <div class="muted" id="infoUid">uid</div>
        </div>
      </div>

      <div style="height:16px;"></div>

      <div style="font-weight:900; margin-bottom:8px;">Change username</div>
      <input id="newUsername" placeholder="new_username" maxlength="20" />
      <div class="row" style="margin-top:10px;">
        <button onclick="changeUsername()">Save username</button>
        <div class="space"></div>
        <span class="muted" id="changeUsernameStatus"></span>
      </div>
    </div>
  </div>

  <!-- SETTINGS: Security -->
  <div id="securityView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Security and account access</div>
      <div class="muted" style="margin-top:8px;">
        This is a placeholder screen. We can add: active sessions, login devices, connected apps, etc.
      </div>
    </div>
  </div>

  <!-- SETTINGS: Privacy -->
  <div id="privacyView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Privacy and safety</div>
      <div class="muted" style="margin-top:8px;">
        Placeholder. We can add: private account, blocked users, muted words, etc.
      </div>
    </div>
  </div>

  <!-- SETTINGS: Notifications -->
  <div id="notificationsView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Notifications</div>
      <div class="muted" style="margin-top:8px;">
        Placeholder. We can add: likes/comments/reposts toggles.
      </div>
    </div>
  </div>

  <!-- SETTINGS: Accessibility -->
  <div id="accessibilityView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Accessibility, display and languages</div>
      <div class="muted" style="margin-top:8px;">
        Placeholder. Dark mode is already on Settings.
      </div>
    </div>
  </div>

  <!-- SETTINGS: Resources -->
  <div id="resourcesView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Additional resources</div>
      <div class="muted" style="margin-top:8px;">
        Placeholder. We can add: Terms, Privacy Policy, About.
      </div>
    </div>
  </div>

  <!-- SETTINGS: Download Data -->
  <div id="downloadDataView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Download an archive of your data</div>
      <div class="muted" style="margin-top:8px;">
        This exports a basic JSON of your profile + your posts (not messages).
      </div>

      <div style="height:12px;"></div>

      <button onclick="downloadMyData()">Download JSON</button>
      <div style="height:8px;"></div>
      <div class="muted" id="downloadStatus"></div>
    </div>
  </div>

  <!-- SETTINGS: Deactivate -->
  <div id="deactivateView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Deactivate account</div>
      <div class="muted" style="margin-top:8px;">
        This is a basic “soft deactivate” flag in your user document.
        (Your posts will still exist unless we implement deletion.)
      </div>

      <div style="height:12px;"></div>

      <button class="danger" onclick="toggleDeactivate()">Toggle Deactivate</button>
      <div style="height:8px;"></div>
      <div class="muted" id="deactivateStatus"></div>
    </div>
  </div>

  <!-- SETTINGS: Change password -->
  <div id="changePasswordView" class="hidden">
    <div class="card">
      <div style="font-weight:900; font-size:18px;">Change your password</div>
      <div class="muted" style="margin-top:8px;">
        You’re signing in with Google, so password changes are handled by Google.
        (If you add Email/Password auth later, we can build this screen.)
      </div>
    </div>
  </div>

</main>

<!-- Bottom Nav -->
<nav>
  <div class="tab" id="tab-feed" onclick="route('feed')">
    <i class="fa-solid fa-house"></i><div class="muted" style="font-size:12px;">Feed</div>
  </div>
  <div class="tab" id="tab-search" onclick="route('search')">
    <i class="fa-solid fa-magnifying-glass"></i><div class="muted" style="font-size:12px;">Search</div>
  </div>
  <div class="tab" id="tab-messages" onclick="route('messages')">
    <i class="fa-solid fa-message"></i><div class="muted" style="font-size:12px;">Messages</div>
  </div>
  <div class="tab" id="tab-profile" onclick="route('profile')">
    <i class="fa-solid fa-user"></i><div class="muted" style="font-size:12px;">Profile</div>
  </div>
</nav>

<!-- Username Modal -->
<div id="usernameModal" class="modal">
  <div class="box">
    <h3 style="margin:0 0 8px;">Pick a username</h3>
    <p class="muted" style="margin:0 0 12px;">Unique, lowercase letters/numbers/underscore only.</p>
    <input id="usernameInput" placeholder="username" maxlength="20"/>
    <div class="row" style="margin-top:12px;">
      <button onclick="saveUsername()">Save</button>
      <div class="space"></div>
      <span class="muted" id="usernameStatus"></span>
    </div>
  </div>
</div>

<script>
  // =========================
  // FIREBASE CONFIG (yours)
  // =========================
  firebase.initializeApp({
    apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
    authDomain: "echostream-a102a.firebaseapp.com",
    projectId: "echostream-a102a",
    storageBucket: "echostream-a102a.appspot.com",
    messagingSenderId: "789062222400",
    appId: "1:789062222400:web:73d478269135a77d7d55a5"
  });

  const auth = firebase.auth();
  const db = firebase.firestore();

  // Storage optional
  let storage = null;
  try { storage = firebase.storage(); } catch(e) { storage = null; }

  let currentUser = null;
  let userData = null;

  // For messaging
  let activeChatUid = "AI";
  let chatUnsub = null; // onSnapshot unsubscribe

  // For feed
  let feedUnsub = null;

  // Settings navigation stack (for back button)
  let navStack = []; // stores objects like {page:"settingsHome", title:"Settings"}

  // =========================
  // UI helpers
  // =========================
  function openDrawer(){
    document.getElementById("drawerBackdrop").classList.add("show");
    document.getElementById("drawer").classList.add("show");
  }
  function closeDrawer(){
    document.getElementById("drawerBackdrop").classList.remove("show");
    document.getElementById("drawer").classList.remove("show");
  }

  function setActiveTab(page){
    ["feed","search","messages","profile"].forEach(p=>{
      const el = document.getElementById("tab-"+p);
      if (!el) return;
      el.classList.toggle("active", p===page);
    });
  }

  function showView(id){
    const views = [
      "loginView","feedView","searchView","messagesView","profileView",
      "settingsHomeView","accountView","accountInfoView","securityView","privacyView",
      "notificationsView","accessibilityView","resourcesView",
      "downloadDataView","deactivateView","changePasswordView"
    ];
    views.forEach(v => {
      const el = document.getElementById(v);
      if (el) el.classList.add("hidden");
    });
    const target = document.getElementById(id);
    if (target) target.classList.remove("hidden");
  }

  function setHeader(title, mode){
    // mode: "main" or "sub"
    document.getElementById("headerTitle").textContent = title || "EchoStream";

    const backBtn = document.getElementById("backBtn");
    const burgerBtn = document.getElementById("burgerBtn");
    if (mode === "sub"){
      backBtn.classList.remove("hidden");
      burgerBtn.classList.add("hidden");
    } else {
      backBtn.classList.add("hidden");
      burgerBtn.classList.remove("hidden");
    }
  }

  function safeString(x, fallback=""){
    return (typeof x === "string" && x.trim().length) ? x : fallback;
  }
  function safeArray(x){
    return Array.isArray(x) ? x : [];
  }
  function initialLetter(name){
    const s = safeString(name, "?");
    return (s[0] ? s[0].toUpperCase() : "?");
  }

  function timeAgo(ts){
    if (!ts || !ts.toDate) return "now";
    const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
    if (seconds < 60) return seconds + "s";
    if (seconds < 3600) return Math.floor(seconds/60) + "m";
    if (seconds < 86400) return Math.floor(seconds/3600) + "h";
    return Math.floor(seconds/86400) + "d";
  }

  // =========================
  // AUTH
  // =========================
  function login(){
    auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  }
  function logout(){
    auth.signOut().then(()=>location.reload());
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user){
      currentUser = null;
      userData = null;
      navStack = [];
      setHeader("EchoStream", "main");
      showView("loginView");
      return;
    }

    currentUser = user;

    // Load or create user doc
    const userRef = db.collection("users").doc(user.uid);
    const snap = await userRef.get();

    if (!snap.exists){
      const auto = safeString(user.displayName, "user").replace(/\s/g,"").toLowerCase();
      await userRef.set({
        username: auto,
        followers: [],
        following: [],
        deactivated: false
      });
      userData = { username: auto, followers: [], following: [], deactivated:false };
      document.getElementById("usernameModal").classList.add("show");
    } else {
      userData = snap.data() || {};
      if (!userData.username){
        userData.username = safeString(user.displayName, "user").replace(/\s/g,"").toLowerCase();
        await userRef.update({ username: userData.username });
      }
      if (typeof userData.deactivated !== "boolean"){
        userData.deactivated = false;
        await userRef.update({ deactivated: false });
      }
    }

    // dark mode init
    const dark = localStorage.getItem("darkMode") === "true";
    document.body.classList.toggle("dark", dark);
    document.getElementById("darkToggle").checked = dark;

    // go feed by default
    route("feed");

    // start feed + chat
    startFeedListener();
    setChatAI();

    // fill account header chips
    refreshAccountLabels();
  });

  // Dark mode
  document.getElementById("darkToggle").addEventListener("change", (e)=>{
    const v = !!e.target.checked;
    document.body.classList.toggle("dark", v);
    localStorage.setItem("darkMode", String(v));
  });

  // =========================
  // MAIN ROUTING
  // =========================
  function route(page){
    if (!currentUser){
      navStack = [];
      setHeader("EchoStream", "main");
      showView("loginView");
      return;
    }

    closeDrawer();
    navStack = []; // leaving settings subpages resets stack

    if (page === "feed"){
      setHeader("EchoStream", "main");
      showView("feedView");
      setActiveTab("feed");
      startFeedListener();
      return;
    }
    if (page === "search"){
      setHeader("Search", "main");
      showView("searchView");
      setActiveTab("search");
      document.getElementById("searchInput").value = "";
      document.getElementById("searchResults").innerHTML = "";
      return;
    }
    if (page === "messages"){
      setHeader("Messages", "main");
      showView("messagesView");
      setActiveTab("messages");
      ensureChatListener();
      return;
    }
    if (page === "profile"){
      setHeader("Profile", "main");
      showView("profileView");
      setActiveTab("profile");
      openProfile(currentUser.uid);
      return;
    }
    if (page === "settings"){
      // Settings home (X-like)
      openSettingsPage("settingsHome");
      return;
    }
  }

  // =========================
  // SETTINGS NAV (X-like)
  // =========================
  function openSettingsPage(key){
    // map keys -> views + titles
    const map = {
      settingsHome: { view:"settingsHomeView", title:"Settings" },

      account: { view:"accountView", title:"Your account" },
      accountInfo: { view:"accountInfoView", title:"Account information" },
      changePassword: { view:"changePasswordView", title:"Change password" },
      downloadData: { view:"downloadDataView", title:"Download data" },
      deactivate: { view:"deactivateView", title:"Deactivate account" },

      security: { view:"securityView", title:"Security" },
      privacy: { view:"privacyView", title:"Privacy & safety" },
      notifications: { view:"notificationsView", title:"Notifications" },
      accessibility: { view:"accessibilityView", title:"Accessibility" },
      resources: { view:"resourcesView", title:"Resources" }
    };

    const target = map[key];
    if (!target) return;

    // push stack
    navStack.push({ key, title: target.title });

    // header mode: sub when stack depth > 1 OR when inside settings area
    setHeader(target.title, "sub");

    // show view
    showView(target.view);

    // bottom nav stays as-is (doesn't highlight settings tab)
    refreshAccountLabels();

    // if entering some pages, refresh their info
    if (key === "accountInfo") fillAccountInfoPage();
    if (key === "deactivate") updateDeactivateStatus();
  }

  function goBack(){
    if (navStack.length <= 1){
      // if somehow only one item, go back to feed
      route("feed");
      return;
    }
    // pop current
    navStack.pop();
    const prev = navStack[navStack.length - 1];
    if (!prev){ route("feed"); return; }

    // re-open previous without pushing new (so we "render" it)
    const prevKey = prev.key;
    // temporarily remove, then use openSettingsPage which pushes — so we need a render function:
    renderSettingsKey(prevKey);
  }

  function renderSettingsKey(key){
    // render without pushing stack: rebuild stack up to key
    const existing = navStack.map(x=>x.key);
    const idx = existing.lastIndexOf(key);
    if (idx === -1){
      navStack = [];
      openSettingsPage("settingsHome");
      return;
    }
    navStack = navStack.slice(0, idx+1);

    const titles = {
      settingsHome:"Settings",
      account:"Your account",
      accountInfo:"Account information",
      changePassword:"Change password",
      downloadData:"Download data",
      deactivate:"Deactivate account",
      security:"Security",
      privacy:"Privacy & safety",
      notifications:"Notifications",
      accessibility:"Accessibility",
      resources:"Resources"
    };

    const views = {
      settingsHome:"settingsHomeView",
      account:"accountView",
      accountInfo:"accountInfoView",
      changePassword:"changePasswordView",
      downloadData:"downloadDataView",
      deactivate:"deactivateView",
      security:"securityView",
      privacy:"privacyView",
      notifications:"notificationsView",
      accessibility:"accessibilityView",
      resources:"resourcesView"
    };

    setHeader(titles[key] || "Settings", "sub");
    showView(views[key] || "settingsHomeView");
    refreshAccountLabels();

    if (key === "accountInfo") fillAccountInfoPage();
    if (key === "deactivate") updateDeactivateStatus();
  }

  function refreshAccountLabels(){
    const uname = safeString(userData?.username, "user");
    const at = "@"+uname;
    const el = document.getElementById("accountAt");
    if (el) el.textContent = at;
  }

  function filterSettings(){
    const q = safeString(document.getElementById("settingsSearch").value, "").toLowerCase().trim();
    const list = document.querySelectorAll("#settingsList .s-item");
    list.forEach(item=>{
      const keys = safeString(item.getAttribute("data-keywords"), "").toLowerCase();
      const title = safeString(item.innerText, "").toLowerCase();
      const show = !q || keys.includes(q) || title.includes(q);
      item.style.display = show ? "" : "none";
    });
  }

  // =========================
  // USERNAME (unique)
  // =========================
  async function saveUsername(){
    const status = document.getElementById("usernameStatus");
    status.textContent = "";
    const name = safeString(document.getElementById("usernameInput").value, "").toLowerCase();

    if (name.length < 3){
      status.textContent = "Too short (min 3).";
      return;
    }
    if (!/^[a-z0-9_]+$/.test(name)){
      status.textContent = "Only a-z 0-9 _";
      return;
    }

    // Must be unique
    const taken = await db.collection("users").where("username","==",name).limit(1).get();
    if (!taken.empty){
      status.textContent = "Username taken.";
      return;
    }

    await db.collection("users").doc(currentUser.uid).update({ username: name });
    userData.username = name;

    document.getElementById("usernameModal").classList.remove("show");
    refreshAccountLabels();
  }

  async function changeUsername(){
    const status = document.getElementById("changeUsernameStatus");
    if (status) status.textContent = "";

    const name = safeString(document.getElementById("newUsername").value, "").toLowerCase().trim();

    if (name.length < 3){
      if (status) status.textContent = "Too short (min 3).";
      return;
    }
    if (!/^[a-z0-9_]+$/.test(name)){
      if (status) status.textContent = "Only a-z 0-9 _";
      return;
    }

    const taken = await db.collection("users").where("username","==",name).limit(1).get();
    if (!taken.empty){
      if (status) status.textContent = "Username taken.";
      return;
    }

    try{
      await db.collection("users").doc(currentUser.uid).update({ username: name });
      userData.username = name;
      refreshAccountLabels();
      fillAccountInfoPage();
      if (status) status.textContent = "Saved ✅";
      document.getElementById("newUsername").value = "";
    } catch(e){
      console.error(e);
      if (status) status.textContent = "Error: " + (e.message || String(e));
    }
  }

  function fillAccountInfoPage(){
    const uname = safeString(userData?.username, "user");
    const email = safeString(currentUser?.email, "—");
    const uid = safeString(currentUser?.uid, "—");

    const iu = document.getElementById("infoUsername");
    const ie = document.getElementById("infoEmail");
    const id = document.getElementById("infoUid");

    if (iu) iu.textContent = "@"+uname;
    if (ie) ie.textContent = email;
    if (id) id.textContent = uid;
  }

  // Download basic JSON
  async function downloadMyData(){
    const status = document.getElementById("downloadStatus");
    if (status) status.textContent = "Preparing...";

    try{
      const meUid = currentUser.uid;

      const meDoc = await db.collection("users").doc(meUid).get();
      const meData = meDoc.data() || {};

      const postsSnap = await db.collection("posts").where("uid","==",meUid).get();
      const posts = [];
      postsSnap.forEach(d=>{
        const p = d.data() || {};
        posts.push({ id:d.id, ...p });
      });

      const payload = {
        exportedAt: new Date().toISOString(),
        user: { uid: meUid, email: currentUser.email || null, ...meData },
        posts
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `echostream_export_${meUid}.json`;
      a.click();
      URL.revokeObjectURL(url);

      if (status) status.textContent = "Downloaded ✅";
    } catch(e){
      console.error(e);
      if (status) status.textContent = "Error: " + (e.message || String(e));
    }
  }

  async function toggleDeactivate(){
    const status = document.getElementById("deactivateStatus");
    if (status) status.textContent = "Updating...";

    try{
      const ref = db.collection("users").doc(currentUser.uid);
      const snap = await ref.get();
      const data = snap.data() || {};
      const next = !data.deactivated;

      await ref.update({ deactivated: next });
      userData.deactivated = next;

      updateDeactivateStatus();
    } catch(e){
      console.error(e);
      if (status) status.textContent = "Error: " + (e.message || String(e));
    }
  }

  function updateDeactivateStatus(){
    const status = document.getElementById("deactivateStatus");
    const v = !!userData?.deactivated;
    if (status) status.textContent = v ? "Status: DEACTIVATED" : "Status: ACTIVE";
  }

  // =========================
  // POSTS
  // =========================
  async function createPost(){
    const status = document.getElementById("postStatus");
    status.textContent = "";

    const text = safeString(document.getElementById("postText").value, "").trim();
    const file = document.getElementById("postImage").files[0];

    if (!text && !file){
      status.textContent = "Write something first.";
      return;
    }

    let imageUrl = "";

    if (file && storage){
      try{
        const path = `posts/${currentUser.uid}/${Date.now()}_${file.name}`;
        const ref = storage.ref(path);
        await ref.put(file);
        imageUrl = await ref.getDownloadURL();
      } catch(e){
        console.warn("Storage upload skipped:", e);
      }
    }

    const uname = safeString(userData?.username, "user");

    await db.collection("posts").add({
      uid: currentUser.uid,
      username: uname,
      text: text,
      imageUrl: imageUrl,
      likes: [],
      comments: [],
      shares: [],
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("postText").value = "";
    document.getElementById("postImage").value = "";
    status.textContent = "Posted.";
    setTimeout(()=>status.textContent="", 1200);
  }

  function renderPost(doc){
    const post = doc.data() || {};
    const postId = doc.id;

    const username = safeString(post.username, "user");
    const likes = safeArray(post.likes);
    const comments = safeArray(post.comments);
    const shares = safeArray(post.shares);
    const liked = likes.includes(currentUser.uid);

    const avatar = initialLetter(username);
    const img = safeString(post.imageUrl, "");

    let commentsHtml = "";
    for (const c of comments){
      const cu = safeString(c.username, "user");
      const ct = safeString(c.text, "");
      commentsHtml += `
        <div class="comment">
          <div class="avatar">${initialLetter(cu)}</div>
          <div style="flex:1;">
            <div style="font-weight:800;">${escapeHtml(cu)}</div>
            <div class="muted">${escapeHtml(ct)}</div>
          </div>
        </div>
      `;
    }

    return `
      <div class="card">
        <div class="row">
          <div class="avatar">${avatar}</div>
          <div style="flex:1;">
            <div style="font-weight:900;">
              <span class="click" onclick="openProfile('${post.uid}')">${escapeHtml(username)}</span>
            </div>
            <div class="muted">${timeAgo(post.timestamp)}</div>
          </div>
        </div>

        ${post.text ? `<div style="margin-top:10px;">${escapeHtml(post.text)}</div>` : ""}

        ${img ? `<img class="post-image" src="${escapeAttr(img)}" alt="post image"/>` : ""}

        <div class="post-actions">
          <span onclick="toggleLike('${postId}')">
            <i class="${liked ? "fa-solid" : "fa-regular"} fa-heart"></i> ${likes.length}
          </span>
          <span onclick="toggleComments('${postId}')">
            <i class="fa-regular fa-comment"></i> ${comments.length}
          </span>
          <span onclick="sharePost('${postId}')">
            <i class="fa-solid fa-retweet"></i> ${shares.length}
          </span>
        </div>

        <div id="comments-${postId}" class="hidden" style="margin-top:12px;">
          ${commentsHtml}
          <div style="height:10px;"></div>
          <input id="commentInput-${postId}" placeholder="Write a comment..."/>
          <div class="row" style="margin-top:10px;">
            <button onclick="addComment('${postId}')">Send</button>
            <div class="space"></div>
          </div>
        </div>
      </div>
    `;
  }

  function startFeedListener(){
    if (feedUnsub) return; // already listening
    const postsDiv = document.getElementById("posts");
    postsDiv.innerHTML = `<div class="muted">Loading feed...</div>`;

    feedUnsub = db.collection("posts")
      .orderBy("timestamp","desc")
      .onSnapshot((snap)=>{
        let html = "";
        snap.forEach(doc => { html += renderPost(doc); });
        postsDiv.innerHTML = html || `<div class="muted">No posts yet.</div>`;
      }, (err)=>{
        console.error("Feed listen error:", err);
        postsDiv.innerHTML = `<div class="muted">Feed error: ${escapeHtml(err.message || String(err))}</div>`;
      });
  }

  async function toggleLike(postId){
    const ref = db.collection("posts").doc(postId);
    const snap = await ref.get();
    const data = snap.data() || {};
    let likes = safeArray(data.likes);

    if (likes.includes(currentUser.uid)){
      likes = likes.filter(x => x !== currentUser.uid);
    } else {
      likes.push(currentUser.uid);
    }
    await ref.update({ likes: likes });
  }

  function toggleComments(postId){
    const el = document.getElementById(`comments-${postId}`);
    if (!el) return;
    el.classList.toggle("hidden");
  }

  async function addComment(postId){
    const input = document.getElementById(`commentInput-${postId}`);
    if (!input) return;
    const text = safeString(input.value, "").trim();
    if (!text) return;

    const comment = {
      uid: currentUser.uid,
      username: safeString(userData?.username, "user"),
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("posts").doc(postId).update({
      comments: firebase.firestore.FieldValue.arrayUnion(comment)
    });

    input.value = "";
  }

  async function sharePost(postId){
    await db.collection("posts").doc(postId).update({
      shares: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
    });
  }

  // =========================
  // PROFILES + FOLLOWERS
  // =========================
  async function openProfile(uid){
    showView("profileView");
    setActiveTab("profile");
    setHeader("Profile", "main");
    navStack = []; // leaving settings

    const profile = document.getElementById("profileView");
    profile.innerHTML = `<div class="muted">Loading profile...</div>`;

    try{
      const userSnap = await db.collection("users").doc(uid).get();
      if (!userSnap.exists){
        profile.innerHTML = `<div class="card">User not found.</div>`;
        return;
      }
      const u = userSnap.data() || {};
      const username = safeString(u.username, "user");
      const followers = safeArray(u.followers);
      const following = safeArray(u.following);

      const isMe = uid === currentUser.uid;
      const iFollow = followers.includes(currentUser.uid);

      let postsHtml = "";
      const postsSnap = await db.collection("posts")
        .where("uid","==",uid)
        .orderBy("timestamp","desc")
        .get();

      postsSnap.forEach(doc=>{
        const p = doc.data() || {};
        const txt = safeString(p.text, "");
        const img = safeString(p.imageUrl, "");
        postsHtml += `
          <div class="card">
            ${txt ? `<div>${escapeHtml(txt)}</div>` : ""}
            ${img ? `<img class="post-image" src="${escapeAttr(img)}" alt="post image"/>` : ""}
            <div class="muted" style="margin-top:8px;">${timeAgo(p.timestamp)}</div>
          </div>
        `;
      });

      profile.innerHTML = `
        <div class="card" style="text-align:center;">
          <div class="avatar" style="width:64px;height:64px;margin:0 auto;font-size:24px;">${initialLetter(username)}</div>
          <div style="margin-top:10px; font-size:20px; font-weight:900;">${escapeHtml(username)}</div>
          <div class="muted">UID: ${escapeHtml(uid)}</div>

          <div class="row" style="justify-content:center; gap:18px; margin-top:12px;">
            <div><div style="font-weight:900;">${followers.length}</div><div class="muted">Followers</div></div>
            <div><div style="font-weight:900;">${following.length}</div><div class="muted">Following</div></div>
          </div>

          ${isMe ? "" : `
            <div style="margin-top:12px;">
              <button onclick="toggleFollow('${uid}')">${iFollow ? "Unfollow" : "Follow"}</button>
              <button class="secondary" style="margin-left:8px;" onclick="startChatWith('${uid}','${escapeAttr(username)}')">Message</button>
            </div>
          `}
        </div>

        <div style="font-weight:900; margin:10px 0 8px;">Posts</div>
        ${postsHtml || `<div class="muted">No posts yet.</div>`}
      `;
    } catch(e){
      console.error(e);
      profile.innerHTML = `<div class="card">Profile error: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  async function toggleFollow(targetUid){
    const meUid = currentUser.uid;

    const myRef = db.collection("users").doc(meUid);
    const targetRef = db.collection("users").doc(targetUid);

    const [mySnap, targetSnap] = await Promise.all([myRef.get(), targetRef.get()]);
    const my = mySnap.data() || {};
    const t = targetSnap.data() || {};

    let following = safeArray(my.following);
    let followers = safeArray(t.followers);

    const iAlreadyFollow = following.includes(targetUid);

    if (iAlreadyFollow){
      following = following.filter(x => x !== targetUid);
      followers = followers.filter(x => x !== meUid);
    } else {
      following.push(targetUid);
      followers.push(meUid);
    }

    await Promise.all([
      myRef.update({ following }),
      targetRef.update({ followers })
    ]);

    openProfile(targetUid);
  }

  // =========================
  // SEARCH
  // =========================
  let searchTimer = null;

  function doSearch(){
    clearTimeout(searchTimer);
    searchTimer = setTimeout(runSearch, 200);
  }

  async function runSearch(){
    const q = safeString(document.getElementById("searchInput").value, "").toLowerCase().trim();
    const res = document.getElementById("searchResults");

    if (!q){
      res.innerHTML = "";
      return;
    }

    res.innerHTML = `<div class="muted">Searching...</div>`;

    try{
      const snap = await db.collection("users")
        .orderBy("username")
        .startAt(q)
        .endAt(q + "\uf8ff")
        .limit(20)
        .get();

      let html = "";
      snap.forEach(doc=>{
        const u = doc.data() || {};
        const uname = safeString(u.username, "");
        if (!uname) return;

        html += `
          <div class="card">
            <div class="row">
              <div class="avatar">${initialLetter(uname)}</div>
              <div style="flex:1;">
                <div style="font-weight:900;" class="click" onclick="openProfile('${doc.id}')">${escapeHtml(uname)}</div>
                <div class="muted">${doc.id}</div>
              </div>
              <button class="secondary" onclick="startChatWith('${doc.id}','${escapeAttr(uname)}')">Message</button>
            </div>
          </div>
        `;
      });

      res.innerHTML = html || `<div class="muted">No matches.</div>`;
    } catch(e){
      console.error(e);
      res.innerHTML = `<div class="card">Search error: ${escapeHtml(e.message || String(e))}</div>`;
    }
  }

  // =========================
  // MESSAGES
  // =========================
  function chatId(a,b){
    return (a < b) ? `${a}_${b}` : `${b}_${a}`;
  }

  function setChatAI(){
    activeChatUid = "AI";
    document.getElementById("chatWith").textContent = "Chatting with: EchoBot";
    ensureChatListener();
  }

  function startChatWith(uid, username){
    activeChatUid = uid;
    document.getElementById("chatWith").textContent = "Chatting with: " + safeString(username, uid);
    route("messages");
    ensureChatListener();
  }

  function ensureChatListener(){
    if (!currentUser) return;

    if (chatUnsub){
      chatUnsub();
      chatUnsub = null;
    }

    const me = currentUser.uid;
    const other = activeChatUid === "AI" ? "AI" : activeChatUid;
    const cid = chatId(me, other);

    const box = document.getElementById("chatBox");
    box.innerHTML = `<div class="muted">Loading chat...</div>`;

    chatUnsub = db.collection("messages")
      .doc(cid)
      .collection("messages")
      .orderBy("timestamp","asc")
      .limit(200)
      .onSnapshot((snap)=>{
        let html = "";
        snap.forEach(doc=>{
          const m = doc.data() || {};
          const uname = safeString(m.username, m.uid === "AI" ? "EchoBot" : "user");
          const text = safeString(m.text, "");
          const mine = m.uid === currentUser.uid;

          html += `
            <div class="card" style="margin:8px 0; padding:10px; border-radius:14px; ${mine ? "border-color: rgba(29,161,242,.6);" : ""}">
              <div style="font-weight:900;">${escapeHtml(uname)}</div>
              <div>${escapeHtml(text)}</div>
            </div>
          `;
        });
        box.innerHTML = html || `<div class="muted">No messages yet.</div>`;
        box.scrollTop = box.scrollHeight;
      }, (err)=>{
        console.error("Chat listen error:", err);
        box.innerHTML = `<div class="card">Chat error: ${escapeHtml(err.message || String(err))}</div>`;
      });
  }

  async function sendMessage(){
    const status = document.getElementById("msgStatus");
    status.textContent = "";

    const input = document.getElementById("chatInput");
    const text = safeString(input.value, "").trim();
    if (!text) return;

    const me = currentUser.uid;
    const other = activeChatUid === "AI" ? "AI" : activeChatUid;
    const cid = chatId(me, other);

    try{
      await db.collection("messages")
        .doc(cid)
        .collection("messages")
        .add({
          uid: me,
          username: safeString(userData?.username, "user"),
          text: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

      input.value = "";

      if (other === "AI"){
        aiReply(cid, text);
      }
    } catch(e){
      console.error(e);
      status.textContent = "Send failed: " + (e.message || String(e));
    }
  }

  async function aiReply(cid, userText){
    const t = (userText || "").toLowerCase();
    let msg = "Tell me more.";

    if (t.includes("hi") || t.includes("hello")) msg = "Hey! What are you up to today?";
    else if (t.includes("help")) msg = "What do you want help with in EchoStream?";
    else if (t.includes("joke")) msg = "Why did the dev go broke? Because he used up all his cache.";
    else if (t.includes("bye")) msg = "Bye! Come back anytime.";

    setTimeout(async ()=>{
      try{
        await db.collection("messages")
          .doc(cid)
          .collection("messages")
          .add({
            uid: "AI",
            username: "EchoBot",
            text: msg,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
      } catch(e){
        console.warn("AI reply failed:", e);
      }
    }, 650);
  }

  // =========================
  // HTML escaping
  // =========================
  function escapeHtml(str){
    str = String(str ?? "");
    return str
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return escapeHtml(str);
  }
</script>

</body>
</html>