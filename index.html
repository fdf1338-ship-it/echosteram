<!-- Main App -->
<div id="app">
    <div class="header">
        <svg class="logo" viewBox="0 0 32 32">
            <circle cx="16" cy="16" r="14" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="16" cy="16" r="4" fill="var(--red)"/>
        </svg>
        <i class="fas fa-cog" style="font-size:26px;cursor:pointer;" onclick="toggleSettings()"></i>
    </div>

    <div class="post-box">
        <textarea id="post-text" placeholder="What's happening?"></textarea>
        <button onclick="createPost()">Post</button>
    </div>

    <div class="feed" id="feed"></div>

    <!-- Search View -->
    <div id="search-view">
        <input id="search-input" placeholder="Search posts..." style="width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; margin-bottom:20px;"/>
        <div id="search-results"></div>
    </div>

    <!-- Messages View -->
    <div id="messages-view">
        <h2>Messages</h2>
        <div id="dm-list"></div>
    </div>

    <!-- Profile View -->
    <div id="profile-view">
        <div style="text-align:center; margin:20px 0;">
            <div class="avatar" id="profile-avatar" style="margin:0 auto; width:80px; height:80px;"></div>
            <h2 id="profile-username"></h2>
            <p id="profile-bio"></p>
        </div>
        <div id="profile-posts"></div>
    </div>

    <div class="bottom-nav">
        <i class="fas fa-home nav-item active" onclick="switchTab('home')"></i>
        <i class="fas fa-search nav-item" onclick="switchTab('search')"></i>
        <i class="fas fa-envelope nav-item" onclick="switchTab('messages')"></i>
        <i class="fas fa-user nav-item" onclick="switchTab('profile')"></i>
    </div>
</div>

<!-- Settings Sidebar -->
<div id="settings-sidebar">
    <div class="settings-header">Settings</div>
    <div class="settings-item">
        <span>Dark mode</span>
        <label class="switch">
            <input type="checkbox" id="dark-toggle" onchange="toggleDark()">
            <span class="slider"></span>
        </label>
    </div>
    <div class="settings-item"><span>Privacy & safety</span><span>Public</span></div>
    <div class="settings-item"><span>Notifications</span><span>All on</span></div>
    <div class="settings-item"><span>Display</span><span>Standard</span></div>
    <div class="settings-item"><span>Security</span><span>2FA off</span></div>
    <div class="settings-item"><span>Manage verified badges (Owner only)</span><span onclick="toggleVerifyPanel()">→</span></div>
    <div class="settings-item"><span>Change profile picture</span><input type="file" accept="image/*" onchange="uploadProfilePic(event)"></div>
    <div class="settings-item"><span>Update bio</span><input id="bio-input" placeholder="Your bio" style="width:100%;"></div>
    <button style="background:var(--accent); width:100%; padding:14px; margin-top:10px;" onclick="updateBio()">Save bio</button>
    <div class="settings-item"><span>About</span><span>Built with hope and a laptop</span></div>
    <button style="background:#d33; width:100%; padding:14px; margin-top:30px; border-radius:999px;" onclick="logout()">Logout</button>
</div>

<!-- Owner Verified Panel -->
<div id="verify-panel">
    <h2>Manage Verified Badges</h2>
    <div id="user-list"></div>
    <button style="background:#666; width:100%; margin-top:20px;" onclick="toggleVerifyPanel()">Close</button>
</div>

<!-- Username Modal -->
<div id="username-modal" class="modal">
    <div class="modal-content">
        <h2>Complete your profile</h2>
        <div style="margin:20px 0;">
            <div class="avatar" id="avatar-preview">?</div>
            <input type="file" id="avatar-upload" accept="image/*" onchange="previewAvatar(event)" style="margin-top:12px;">
        </div>
        <input id="username-input" placeholder="@username" maxlength="20" style="width:100%; padding:12px; font-size:16px; margin:15px 0; border-radius:12px; border:1px solid var(--border);"/>
        <button onclick="saveProfile()">Save & Continue</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
        authDomain: "echostream-a102a.firebaseapp.com",
        projectId: "echostream-a102a",
        storageBucket: "echostream-a102a.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;
    let currentUserData = null;

    document.getElementById('google-signin').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            await loadUserData();
            loadFeed();
            loadProfile();
        } else {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('app').style.display = 'none';
        }
    });

    async function loadUserData() {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists) {
            currentUserData = doc.data();
            if (!currentUserData.username) {
                document.getElementById('username-modal').style.display = 'flex';
            }
        } else {
            document.getElementById('username-modal').style.display = 'flex';
        }
    }

    function previewAvatar(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => document.getElementById('avatar-preview').style.backgroundImage = `url(${ev.target.result})`;
            reader.readAsDataURL(file);
        }
    }

    async function saveProfile() {
        const input = document.getElementById('username-input').value.trim().replace('@','');
        if (input.length < 3) return alert('Username too short');
        const snap = await db.collection('users').where('username', '==', input).get();
        if (!snap.empty) return alert('Username taken');

        let photoURL = currentUser.photoURL || null;
        const file = document.getElementById('avatar-upload').files[0];
        if (file) {
            const ref = storage.ref(`avatars/${currentUser.uid}`);
            await ref.put(file);
            photoURL = await ref.getDownloadURL();
        }

        await db.collection('users').doc(currentUser.uid).set({
            username: input,
            photoURL: photoURL,
            verified: false,
            bio: ""
        }, {merge: true});

        currentUserData = {username: input, photoURL, verified: false, bio: ""};
        document.getElementById('username-modal').style.display = 'none';
        loadFeed();
    }

    function toggleDark() {
        document.body.classList.toggle('dark');
        localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }

    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark');
        document.getElementById('dark-toggle').checked = true;
    }

    async function createPost() {
        const text = document.getElementById('post-text').value.trim();
        if (!text) return;
        await db.collection('posts').add({
            text,
            uid: currentUser.uid,
            username: currentUserData.username,
            photoURL: currentUserData.photoURL,
            likes: [],
            comments: [],
            reposts: [],
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('post-text').value = '';
        loadFeed();
    }

    async function loadFeed() {
        const snap = await db.collection('posts').orderBy('timestamp', 'desc').get();
        const feed = document.getElementById('feed');
        feed.innerHTML = '';
        snap.forEach(doc => {
            const d = doc.data();
            const isLiked = d.likes?.includes(currentUser.uid);
            const div = document.createElement('div');
            div.className = 'post';
            div.innerHTML = `
                <div class="post-header">
                    <div class="avatar" style="background-image:url(\( {d.photoURL || ''})"> \){(d.username||'A')[0]}</div>
                    <div class="post-user">
                        <div class="username">\( {d.username || 'Anonymous'} \){d.verified ? '<span class="verified">✓</span>' : ''}</div>
                        <div class="time">${timeAgo(d.timestamp)}</div>
                    </div>
                </div>
                <div class="post-text">${d.text}</div>
                <div class="post-actions">
                    <div class="action \( {isLiked ? 'liked' : ''}" onclick="toggleLike(' \){doc.id}')">
                        <i class="fa${isLiked ? 's' : 'r'} fa-heart"></i>
                        <span class="action-count">${d.likes?.length || 0}</span>
                    </div>
                    <div class="action" onclick="toggleComments('${doc.id}')">
                        <i class="far fa-comment"></i>
                        <span class="action-count">${d.comments?.length || 0}</span>
                    </div>
                    <div class="action" onclick="repost('${doc.id}')">
                        <i class="fas fa-retweet"></i>
                        <span class="action-count">${d.reposts?.length || 0}</span>
                    </div>
                </div>
                <div class="comments-section" id="comments-${doc.id}" style="display:none;">
                    <input class="comment-input" id="comment-input-${doc.id}" placeholder="Reply...">
                    <button onclick="addComment('${doc.id}')">Send</button>
                    <div id="comments-list-${doc.id}"></div>
                </div>
            `;
            feed.appendChild(div);
        });
        // AI reply chance
        if (Math.random() < 0.2) echoAIReply(snap.docs[0].id); // Reply to the newest post
    }

    async function echoAIReply(postId) {
        const messages = ["Interesting point.", "I see what you mean.", "That's thought-provoking.", "Be careful what you wish for."];
        const random = messages[Math.floor(Math.random() * messages.length)];
        await addComment(postId, random, 'Echo_AI', true);
    }

    async function toggleComments(postId) {
        const section = document.getElementById(`comments-${postId}`);
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
        if (section.style.display === 'block') loadComments(postId);
    }

    async function addComment(postId, text = null, userName = currentUserData.username, isAI = false) {
        text = text || document.getElementById(`comment-input-${postId}`).value.trim();
        if (!text) return;
        const comment = {
            text,
            uid: isAI ? 'echo_ai' : currentUser.uid,
            username: isAI ? 'Echo_AI' : userName,
            photoURL: isAI ? '' : currentUserData.photoURL,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('posts').doc(postId).update({comments: firebase.firestore.FieldValue.arrayUnion(comment)});
        document.getElementById(`comment-input-${postId}`).value = '';
        loadComments(postId);
        loadFeed(); // Refresh count
    }

    async function loadComments(postId) {
        const doc = await db.collection('posts').doc(postId).get();
        const comments = doc.data().comments || [];
        const list = document.getElementById(`comments-list-${postId}`);
        list.innerHTML = '';
        comments.forEach(c => {
            const div = document.createElement('div');
            div.className = 'comment';
            div.innerHTML = `
                <div class="comment-avatar" style="background-image:url(\( {c.photoURL || ''})"> \){(c.username||'A')[0]}</div>
                <div class="comment-body">
                    <div class="username">${c.username}</div>
                    <div>${c.text}</div>
                    <div class="time">${timeAgo(c.timestamp)}</div>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function timeAgo(ts) {
        if (!ts) return 'now';
        const seconds = Math.floor((Date.now() - ts.toDate().getTime()) / 1000);
        if (seconds < 60) return seconds + 's';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
        return Math.floor(seconds / 86400) + 'd';
    }

    async function toggleLike(postId) {
        const ref = db.collection('posts').doc(postId);
        const doc = await ref.get();
        const likes = doc.data().likes || [];
        if (likes.includes(currentUser.uid)) {
            likes.splice(likes.indexOf(currentUser.uid), 1);
        } else {
            likes.push(currentUser.uid);
        }
        await ref.update({likes});
        loadFeed();
    }

    async function repost(postId) {
        const original = await db.collection('posts').doc(postId).get();
        await db.collection('posts').add({
            text: original.data().text,
            uid: currentUser.uid,
            username: currentUserData.username,
            photoURL: currentUserData.photoURL,
            originalId: postId,
            isRepost: true,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadFeed();
    }

    function toggleSettings() {
        document.getElementById('settings-sidebar').classList.toggle('open');
    }

    function switchTab(tab) {
        document.querySelectorAll('#feed, #search-view, #messages-view, #profile-view').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if (tab === 'home') {
            document.getElementById('feed').style.display = 'block';
            document.querySelector('.fa-home').classList.add('active');
        } else if (tab === 'search') {
            document.getElementById('search-view').style.display = 'block';
            document.querySelector('.fa-search').classList.add('active');
        } else if (tab === 'messages') {
            document.getElementById('messages-view').style.display = 'block';
            document.querySelector('.fa-envelope').classList.add('active');
        } else if (tab === 'profile') {
            document.getElementById('profile-view').style.display = 'block';
            document.querySelector('.fa-user').classList.add('active');
            loadProfile();
        }
    }

    async function loadProfile() {
        document.getElementById('profile-username').textContent = currentUserData.username || 'Anonymous';
        document.getElementById('profile-bio').textContent = currentUserData.bio || 'No bio yet';
        document.getElementById('profile-avatar').style.backgroundImage = `url(${currentUserData.photoURL || ''})`;
        const snap = await db.collection('posts').where('uid', '==', currentUser.uid).orderBy('timestamp', 'desc').get();
        const posts = document.getElementById('profile-posts');
        posts.innerHTML = '';
        snap.forEach(doc => {
            const d = doc.data();
            const isLiked = d.likes?.includes(currentUser.uid);
            const div = document.createElement('div');
            div.className = 'post';
            div.innerHTML = `
                <div class="post-header">
                    <div class="avatar" style="background-image:url(\( {d.photoURL || ''})"> \){(d.username||'A')[0]}</div>
                    <div class="post-user">
                        <div class="username">\( {d.username || 'Anonymous'} \){d.verified ? '<span class="verified">✓</span>' : ''}</div>
                        <div class="time">${timeAgo(d.timestamp)}</div>
                    </div>
                </div>
                <div class="post-text">${d.text}</div>
                <div class="post-actions">
                    <div class="action \( {isLiked ? 'liked' : ''}" onclick="toggleLike(' \){doc.id}')">
                        <i class="fa${isLiked ? 's' : 'r'} fa-heart"></i>
                        <span class="action-count">${d.likes?.length || 0}</span>
                    </div>
                    <div class="action" onclick="toggleComments('${doc.id}')">
                        <i class="far fa-comment"></i>
                        <span class="action-count">${d.comments?.length || 0}</span>
                    </div>
                    <div class="action" onclick="repost('${doc.id}')">
                        <i class="fas fa-retweet"></i>
                        <span class="action-count">${d.reposts?.length || 0}</span>
                    </div>
                </div>
                <div class="comments-section" id="comments-${doc.id}" style="display:none;">
                    <input class="comment-input" id="comment-input-${doc.id}" placeholder="Reply...">
                    <button onclick="addComment('${doc.id}')">Send</button>
                    <div id="comments-list-${doc.id}"></div>
                </div>
            `;
            posts.appendChild(div);
        });
    }

    function logout() {
        auth.signOut();
    }
</script>