<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EchoStream</title>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --bg:#fff; --text:#000; --card:#f3f3f3; --border:#ddd; --accent:#1da1f2;
      --muted:#666; --danger:#ff3b30;
    }
    body.dark{
      --bg:#000; --text:#fff; --card:#141414; --border:#2a2a2a; --muted:#aaa;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg); color:var(--text);
    }

    header{
      position:fixed; top:0; left:0; right:0;
      padding:14px 14px;
      background:var(--bg); border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      z-index:50; font-weight:800;
    }
    header .left{ display:flex; align-items:center; gap:10px; }
    header .btnIcon{ cursor:pointer; font-size:18px; padding:8px; border-radius:10px; }
    header .btnIcon:hover{ background:rgba(0,0,0,0.06); }
    body.dark header .btnIcon:hover{ background:rgba(255,255,255,0.08); }

    main{
      padding:74px 14px 90px;
      max-width:680px; margin:0 auto;
    }
    nav{
      position:fixed; bottom:0; left:0; right:0;
      background:var(--bg); border-top:1px solid var(--border);
      display:flex; justify-content:space-around; padding:10px 0;
      z-index:60;
    }
    nav .tab{
      width:25%; text-align:center; cursor:pointer; padding:8px 0;
      color:var(--muted);
    }
    nav .tab.active{ color:var(--accent); font-weight:700; }
    nav i{ font-size:20px; }

    .hidden{ display:none !important; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      padding:14px;
      border-radius:16px;
      margin-bottom:12px;
    }

    input, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--bg);
      color:var(--text);
      outline:none;
    }
    textarea{ resize:vertical; min-height:70px; }

    button{
      background:var(--accent);
      color:white;
      border:none;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
    }
    button.secondary{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
    }
    button.danger{
      background:var(--danger);
    }
    .row{ display:flex; gap:10px; align-items:center; }
    .grow{ flex:1; }
    .muted{ color:var(--muted); }

    .avatar{
      width:46px; height:46px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:#777; color:white; font-weight:900;
      flex:0 0 auto;
      user-select:none;
    }
    .avatar.sm{ width:34px; height:34px; font-size:14px; }
    .link{ cursor:pointer; }
    .link:hover{ text-decoration:underline; }

    .postActions{
      display:flex; gap:18px; margin-top:10px; align-items:center;
      color:var(--muted);
    }
    .postActions span{ cursor:pointer; user-select:none; }
    .postActions span:hover{ text-decoration:underline; }
    .postImg{
      width:100%; border-radius:14px; margin-top:10px; border:1px solid var(--border);
    }

    /* Side menu (settings) */
    .sheetBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.45);
      display:none; z-index:100;
    }
    .sheet{
      position:fixed; top:0; bottom:0; left:-320px;
      width:300px; max-width:85vw;
      background:var(--bg);
      border-right:1px solid var(--border);
      transition:0.25s;
      z-index:101;
      padding:14px;
      overflow:auto;
    }
    .sheetBackdrop.open{ display:block; }
    .sheet.open{ left:0; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:transparent;
      color:var(--text);
      font-size:12px; font-weight:700;
    }

    /* Modal (username) */
    .modalBackdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.55);
      display:none; align-items:center; justify-content:center;
      z-index:200;
      padding:14px;
    }
    .modal{
      width:100%; max-width:420px;
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
    }

    /* Messages */
    #chatBox{
      height:340px;
      overflow-y:auto;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:var(--bg);
    }
    .bubble{
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      margin:8px 0;
      max-width:92%;
    }
    .bubble.me{ margin-left:auto; }
  </style>
</head>

<body>
  <header>
    <div class="left">
      <i class="fa-solid fa-bars btnIcon" onclick="openSettingsSheet()"></i>
      <div>EchoStream</div>
    </div>
    <div class="right">
      <span class="pill" id="headerUserPill" style="display:none;"></span>
    </div>
  </header>

  <!-- Side settings sheet -->
  <div id="sheetBackdrop" class="sheetBackdrop" onclick="closeSettingsSheet()"></div>
  <div id="sheet" class="sheet">
    <div class="row" style="justify-content:space-between;">
      <strong>Settings</strong>
      <i class="fa-solid fa-xmark btnIcon" onclick="closeSettingsSheet()"></i>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:800;">Dark mode</div>
          <div class="muted" style="font-size:13px;">Toggle theme</div>
        </div>
        <input type="checkbox" id="darkToggle" style="width:auto; transform:scale(1.2);" />
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800;">Account</div>
      <div class="muted" id="accountInfo" style="margin-top:6px;"></div>
      <div class="row" style="margin-top:10px;">
        <button class="secondary" onclick="route('profile')">My Profile</button>
        <button class="danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800;">Debug</div>
      <div class="muted" style="font-size:13px; margin-top:6px;">
        If you ever see ‚ÄúCORS Listen channel‚Äù, it‚Äôs usually browser/network/adblock. Try:
        Chrome, disable adblock, or reload.
      </div>
      <button class="secondary" style="margin-top:10px;" onclick="hardReload()">Hard Reload</button>
    </div>

    <div class="card">
      <div style="font-weight:800;">Images</div>
      <div class="muted" style="font-size:13px; margin-top:6px;">
        Images are OFF by default (no Storage needed).
      </div>
    </div>
  </div>

  <main>
    <!-- LOGIN -->
    <div id="loginView" class="card">
      <h2 style="margin:0 0 10px;">Welcome to EchoStream</h2>
      <div class="muted" style="margin-bottom:12px;">Sign in to post, search, and message.</div>
      <button onclick="login()">Sign in with Google</button>
    </div>

    <!-- FEED -->
    <div id="feedView" class="hidden">
      <div class="card">
        <div style="font-weight:800; margin-bottom:10px;">Create Post</div>
        <textarea id="postText" placeholder="What‚Äôs happening?"></textarea>

        <!-- Storage OFF: file input hidden by default -->
        <div id="imageRow" class="hidden" style="margin-top:10px;">
          <input type="file" id="postImage" accept="image/*" />
        </div>

        <div class="row" style="margin-top:10px;">
          <button onclick="createPost()">Post</button>
          <button class="secondary" onclick="refreshFeed()">Refresh</button>
        </div>
      </div>

      <div id="posts"></div>
    </div>

    <!-- SEARCH -->
    <div id="searchView" class="hidden">
      <div class="card">
        <div style="font-weight:800; margin-bottom:10px;">Search Users</div>
        <input id="searchInput" placeholder="Type a username..." oninput="doSearch()" />
        <div class="muted" style="margin-top:8px; font-size:13px;">
          Tip: search is by username.
        </div>
      </div>
      <div id="searchResults"></div>
    </div>

    <!-- MESSAGES -->
    <div id="messagesView" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:800;">Messages</div>
            <div class="muted" style="font-size:13px;">Default chat: EchoBot</div>
          </div>
          <button class="secondary" onclick="setActiveChat('AI')">EchoBot</button>
        </div>
      </div>

      <div class="card">
        <div id="chatBox"></div>
        <div class="row" style="margin-top:10px;">
          <input id="chatInput" class="grow" placeholder="Type a message..." />
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="profileView" class="hidden"></div>

    <!-- USERNAME MODAL -->
    <div id="usernameModalBackdrop" class="modalBackdrop">
      <div class="modal">
        <h3 style="margin:0 0 10px;">Pick a username</h3>
        <div class="muted" style="margin-bottom:10px; font-size:13px;">
          Usernames are unique (no duplicates). Use letters, numbers, underscore.
        </div>
        <input id="usernameInput" placeholder="username" maxlength="20" />
        <div class="row" style="margin-top:12px;">
          <button onclick="saveUsername()">Save</button>
          <button class="secondary" onclick="suggestUsername()">Suggest</button>
        </div>
        <div class="muted" id="usernameHint" style="margin-top:10px; font-size:13px;"></div>
      </div>
    </div>
  </main>

  <nav>
    <div id="tabFeed" class="tab" onclick="route('feed')"><i class="fa-solid fa-house"></i></div>
    <div id="tabSearch" class="tab" onclick="route('search')"><i class="fa-solid fa-magnifying-glass"></i></div>
    <div id="tabMessages" class="tab" onclick="route('messages')"><i class="fa-solid fa-message"></i></div>
    <div id="tabProfile" class="tab" onclick="route('profile')"><i class="fa-solid fa-user"></i></div>
  </nav>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
// Turn ON later when you pay/enable Storage.
// For now: false -> no Storage required.
const USE_STORAGE = false;

/** =========================
 *  FIREBASE INIT
 *  ========================= */
firebase.initializeApp({
  apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
  authDomain: "echostream-a102a.firebaseapp.com",
  projectId: "echostream-a102a",
  storageBucket: "echostream-a102a.appspot.com",
  messagingSenderId: "789062222400",
  appId: "1:789062222400:web:73d478269135a77d7d55a5"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser = null;
let userData = null;

// navigation state
let currentView = "feed";
let viewingProfileUid = null;

// chat state
let activeChatUid = "AI";
let unsubscribeChat = null;

/** =========================
 *  HELPERS
 *  ========================= */
function $(id){ return document.getElementById(id); }

function safeStr(v, fallback=""){
  return (typeof v === "string" && v.trim().length) ? v : fallback;
}
function safeArr(v){
  return Array.isArray(v) ? v : [];
}
function firstLetter(name){
  const s = safeStr(name, "?");
  return s[0] ? s[0].toUpperCase() : "?";
}
function normalizePost(p){
  // Fix old/broken post shapes so UI never crashes.
  const out = Object.assign({}, p);
  out.username = safeStr(out.username, "unknown");
  out.text = safeStr(out.text, "");
  out.imageUrl = safeStr(out.imageUrl, "");
  out.likes = safeArr(out.likes);
  out.comments = safeArr(out.comments).map(c => ({
    uid: safeStr(c?.uid, ""),
    username: safeStr(c?.username, "unknown"),
    text: safeStr(c?.text, "")
  }));
  out.shares = safeArr(out.shares);
  return out;
}
function setTabsActive(view){
  ["feed","search","messages","profile"].forEach(v=>{
    $("tab"+cap(v)).classList.toggle("active", v===view);
  });
}
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

function toast(msg){
  alert(msg);
}

function timeAgo(ts){
  if(!ts || !ts.toDate) return "now";
  const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
  if (seconds < 60) return seconds + "s";
  if (seconds < 3600) return Math.floor(seconds/60) + "m";
  if (seconds < 86400) return Math.floor(seconds/3600) + "h";
  return Math.floor(seconds/86400) + "d";
}

function hardReload(){
  location.reload(true);
}

/** =========================
 *  SETTINGS SHEET
 *  ========================= */
function openSettingsSheet(){
  $("sheetBackdrop").classList.add("open");
  $("sheet").classList.add("open");
}
function closeSettingsSheet(){
  $("sheetBackdrop").classList.remove("open");
  $("sheet").classList.remove("open");
}

/** =========================
 *  AUTH
 *  ========================= */
function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function logout(){
  auth.signOut().then(()=>location.reload());
}

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    currentUser = null;
    userData = null;
    $("loginView").classList.remove("hidden");
    ["feedView","searchView","messagesView","profileView"].forEach(id=>$(id).classList.add("hidden"));
    $("headerUserPill").style.display = "none";
    return;
  }

  currentUser = user;
  $("loginView").classList.add("hidden");
  $("headerUserPill").style.display = "inline-flex";

  // dark mode from local storage
  const dark = localStorage.getItem("darkMode")==="true";
  $("darkToggle").checked = dark;
  document.body.classList.toggle("dark", dark);

  // Storage toggle in UI
  $("imageRow").classList.toggle("hidden", !USE_STORAGE);

  await ensureUserDoc();
  updateHeaderAccountInfo();

  route("feed");
  startFeedListener();
  setActiveChat("AI");
});

async function ensureUserDoc(){
  const userRef = db.collection("users").doc(currentUser.uid);
  const snap = await userRef.get();

  if(!snap.exists){
    // Create minimal user doc (username will be picked in modal)
    await userRef.set({
      username: "",
      usernameLower: "",
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      followers: [],
      following: []
    }, { merge:true });

    userData = (await userRef.get()).data();
    openUsernameModal();
    return;
  }

  userData = snap.data() || {};

  // If missing username, force modal
  if(!safeStr(userData.username)){
    openUsernameModal();
  }
}

/** =========================
 *  DARK MODE
 *  ========================= */
$("darkToggle").addEventListener("change", ()=>{
  document.body.classList.toggle("dark", $("darkToggle").checked);
  localStorage.setItem("darkMode", $("darkToggle").checked ? "true" : "false");
});

/** =========================
 *  ROUTING
 *  ========================= */
function route(view){
  currentView = view;
  setTabsActive(view);

  $("feedView").classList.toggle("hidden", view!=="feed");
  $("searchView").classList.toggle("hidden", view!=="search");
  $("messagesView").classList.toggle("hidden", view!=="messages");
  $("profileView").classList.toggle("hidden", view!=="profile");

  if(view==="profile"){
    // If user clicked another profile earlier, show that; else show my profile.
    loadProfile(viewingProfileUid || currentUser.uid);
  }
  if(view==="messages"){
    loadMessages();
  }
}

/** =========================
 *  USERNAME MODAL + UNIQUE USERNAMES
 *  Uses /usernames/{usernameLower} claim doc
 *  ========================= */
function openUsernameModal(){
  $("usernameModalBackdrop").style.display = "flex";
  $("usernameHint").textContent = "";
  suggestUsername();
}
function closeUsernameModal(){
  $("usernameModalBackdrop").style.display = "none";
}

function suggestUsername(){
  const base = safeStr(currentUser.displayName, "user")
    .toLowerCase()
    .replace(/\s+/g,"")
    .replace(/[^a-z0-9_]/g,"")
    .slice(0,14);

  const rand = Math.floor(Math.random()*9000)+1000;
  const suggestion = (base || "user") + "_" + rand;
  $("usernameInput").value = suggestion;
  $("usernameHint").textContent = "Suggestion generated. You can edit it.";
}

async function saveUsername(){
  const raw = $("usernameInput").value.trim().toLowerCase();
  if(raw.length < 3) return toast("Username must be at least 3 characters.");
  if(raw.length > 20) return toast("Username must be 20 characters or less.");
  if(!/^[a-z0-9_]+$/.test(raw)) return toast("Only lowercase letters, numbers, underscore.");

  // 1) Create username claim doc
  // doc id is raw (usernameLower)
  const claimRef = db.collection("usernames").doc(raw);

  try{
    await db.runTransaction(async (tx)=>{
      const claimSnap = await tx.get(claimRef);
      if(claimSnap.exists){
        throw new Error("taken");
      }
      tx.set(claimRef, {
        ownerUid: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      const userRef = db.collection("users").doc(currentUser.uid);
      tx.set(userRef, {
        username: raw,
        usernameLower: raw
      }, { merge:true });
    });
  }catch(e){
    if(String(e?.message).includes("taken")) return toast("That username is taken. Try another.");
    console.error(e);
    return toast("Could not save username. Check Rules and try again.");
  }

  // refresh userData
  userData = (await db.collection("users").doc(currentUser.uid).get()).data();
  closeUsernameModal();
  updateHeaderAccountInfo();
  toast("Username saved!");
}

/** =========================
 *  HEADER ACCOUNT INFO
 *  ========================= */
function updateHeaderAccountInfo(){
  const uname = safeStr(userData?.username, "no-username");
  $("headerUserPill").textContent = "@" + uname;
  $("accountInfo").innerHTML =
    `<div><strong>@${uname}</strong></div>
     <div class="muted" style="font-size:13px;">UID: ${currentUser.uid}</div>
     <div class="muted" style="font-size:13px;">Email: ${safeStr(currentUser.email,"")}</div>`;
}

/** =========================
 *  POSTS
 *  ========================= */
async function createPost(){
  if(!safeStr(userData?.username)){
    openUsernameModal();
    return;
  }

  const text = $("postText").value.trim();
  if(!text) return toast("Write something first.");

  let imageUrl = "";
  if(USE_STORAGE){
    const file = $("postImage").files[0];
    if(file){
      const path = `posts/${currentUser.uid}/${Date.now()}_${file.name}`;
      const ref = storage.ref(path);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }
  }

  await db.collection("posts").add({
    uid: currentUser.uid,
    username: userData.username,
    text,
    imageUrl,
    likes: [],
    comments: [],
    shares: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  $("postText").value = "";
  if(USE_STORAGE) $("postImage").value = "";
}

let unsubscribeFeed = null;

function startFeedListener(){
  if(unsubscribeFeed) unsubscribeFeed();

  unsubscribeFeed = db.collection("posts")
    .orderBy("timestamp","desc")
    .onSnapshot((snapshot)=>{
      const postsDiv = $("posts");
      postsDiv.innerHTML = "";

      snapshot.forEach(doc=>{
        const post = normalizePost(doc.data());
        postsDiv.insertAdjacentHTML("beforeend", renderPost(post, doc.id));
      });

      // attach dynamic handlers (safer than inline for big apps, but we keep it simple)
    }, (err)=>{
      console.error("Feed listen error:", err);
      // If you see "Missing or insufficient permissions", it‚Äôs rules.
      // If you see "CORS Listen", try another browser or disable adblock.
    });
}

function refreshFeed(){
  // quick manual refresh
  startFeedListener();
}

function renderPost(post, postId){
  const liked = safeArr(post.likes).includes(currentUser.uid);
  const likeCount = safeArr(post.likes).length;
  const commentCount = safeArr(post.comments).length;
  const shareCount = safeArr(post.shares).length;

  const commentsHtml = safeArr(post.comments).slice(0, 10).map(c=>{
    const cu = safeStr(c.username, "unknown");
    return `
      <div class="row" style="gap:10px; margin-top:10px;">
        <div class="avatar sm">${firstLetter(cu)}</div>
        <div class="grow">
          <div style="font-weight:800; font-size:14px;">@${cu}</div>
          <div style="font-size:14px;">${escapeHtml(safeStr(c.text,""))}</div>
        </div>
      </div>
    `;
  }).join("");

  return `
    <div class="card" id="post-${postId}">
      <div class="row" style="gap:10px;">
        <div class="avatar">${firstLetter(post.username)}</div>
        <div class="grow">
          <div style="font-weight:900;">
            <span class="link" onclick="openProfileFromPost('${post.uid}')">@${escapeHtml(post.username)}</span>
          </div>
          <div class="muted" style="font-size:13px;">${timeAgo(post.timestamp)}</div>
        </div>
      </div>

      <div style="margin-top:10px; font-size:15px;">${escapeHtml(post.text)}</div>

      ${post.imageUrl ? `<img class="postImg" src="${post.imageUrl}" />` : ""}

      <div class="postActions">
        <span onclick="toggleLike('${postId}')">
          <i class="${liked ? "fa-solid" : "fa-regular"} fa-heart"></i> ${likeCount}
        </span>
        <span onclick="toggleComments('${postId}')">
          <i class="fa-regular fa-comment"></i> ${commentCount}
        </span>
        <span onclick="sharePost('${postId}')">
          <i class="fa-solid fa-retweet"></i> ${shareCount}
        </span>
      </div>

      <div id="comments-${postId}" class="hidden" style="margin-top:10px;">
        <div style="font-weight:800; margin-bottom:8px;">Comments</div>
        ${commentsHtml || `<div class="muted">No comments yet.</div>`}

        <div class="row" style="margin-top:10px;">
          <input class="grow" id="commentInput-${postId}" placeholder="Write a comment..." />
          <button onclick="addComment('${postId}')">Send</button>
        </div>
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function toggleLike(postId){
  const ref = db.collection("posts").doc(postId);
  const snap = await ref.get();

  // normalize in case old data was wrong
  const post = normalizePost(snap.data() || {});
  let likes = safeArr(post.likes);

  if(likes.includes(currentUser.uid)){
    likes = likes.filter(x => x !== currentUser.uid);
  }else{
    likes = likes.concat([currentUser.uid]);
  }
  await ref.update({ likes });
}

function toggleComments(postId){
  $("comments-"+postId).classList.toggle("hidden");
}

async function addComment(postId){
  if(!safeStr(userData?.username)){
    openUsernameModal();
    return;
  }
  const input = $("commentInput-"+postId);
  const text = input.value.trim();
  if(!text) return;

  const ref = db.collection("posts").doc(postId);
  // store a simple comment object
  await ref.update({
    comments: firebase.firestore.FieldValue.arrayUnion({
      uid: currentUser.uid,
      username: userData.username,
      text: text
    })
  });

  input.value = "";
}

async function sharePost(postId){
  const ref = db.collection("posts").doc(postId);
  await ref.update({
    shares: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
  });
}

/** =========================
 *  PROFILE
 *  ========================= */
function openProfileFromPost(uid){
  viewingProfileUid = uid;
  route("profile");
}

async function loadProfile(uid){
  viewingProfileUid = uid;

  const profileDiv = $("profileView");
  profileDiv.innerHTML = `<div class="card">Loading profile...</div>`;

  const userSnap = await db.collection("users").doc(uid).get();
  if(!userSnap.exists){
    profileDiv.innerHTML = `<div class="card">User not found.</div>`;
    return;
  }

  const u = userSnap.data() || {};
  const username = safeStr(u.username, "unknown");
  const followers = safeArr(u.followers);
  const following = safeArr(u.following);

  const isMe = uid === currentUser.uid;
  const iFollow = followers.includes(currentUser.uid); // since followers are on target doc

  // Posts for this user
  // (If Firestore asks for an index, it will give you a link to create it.)
  let postsHtml = "";
  try{
    const postsSnap = await db.collection("posts")
      .where("uid","==",uid)
      .orderBy("timestamp","desc")
      .get();

    postsSnap.forEach(doc=>{
      const p = normalizePost(doc.data());
      postsHtml += `
        <div class="card">
          <div class="muted" style="font-size:13px; margin-bottom:6px;">${timeAgo(p.timestamp)}</div>
          <div style="font-size:15px;">${escapeHtml(p.text)}</div>
          ${p.imageUrl ? `<img class="postImg" src="${p.imageUrl}">` : ""}
        </div>
      `;
    });
  }catch(e){
    console.error("Profile posts query error:", e);
    postsHtml = `
      <div class="card">
        <div style="font-weight:800;">Posts</div>
        <div class="muted" style="margin-top:6px;">
          Firestore needs an index for this query. If you saw an ‚Äúindex required‚Äù link in console, click it and create the index.
        </div>
      </div>
    `;
  }

  profileDiv.innerHTML = `
    <div class="card" style="text-align:center;">
      <div class="avatar" style="margin:0 auto;">${firstLetter(username)}</div>
      <div style="font-weight:900; font-size:18px; margin-top:8px;">@${escapeHtml(username)}</div>

      <div class="row" style="justify-content:center; gap:16px; margin-top:10px;">
        <span class="pill">${followers.length} followers</span>
        <span class="pill">${following.length} following</span>
      </div>

      ${!isMe ? `
        <div style="margin-top:12px;">
          <button onclick="toggleFollow('${uid}')">${iFollow ? "Unfollow" : "Follow"}</button>
          <button class="secondary" style="margin-left:8px;" onclick="setActiveChat('${uid}')">Message</button>
        </div>
      ` : `
        <div style="margin-top:12px;">
          <button class="secondary" onclick="openSettingsSheet()">Open Settings</button>
        </div>
      `}
    </div>

    <div style="font-weight:900; margin:8px 2px;">Posts</div>
    ${postsHtml || `<div class="card" class="muted">No posts yet.</div>`}
  `;
}

async function toggleFollow(targetUid){
  if(targetUid === currentUser.uid) return toast("You can‚Äôt follow yourself.");

  const myRef = db.collection("users").doc(currentUser.uid);
  const targetRef = db.collection("users").doc(targetUid);

  await db.runTransaction(async (tx)=>{
    const mySnap = await tx.get(myRef);
    const tSnap = await tx.get(targetRef);

    const my = mySnap.data() || {};
    const t = tSnap.data() || {};

    let myFollowing = safeArr(my.following);
    let tFollowers = safeArr(t.followers);

    const already = myFollowing.includes(targetUid);

    if(already){
      myFollowing = myFollowing.filter(x=>x!==targetUid);
      tFollowers = tFollowers.filter(x=>x!==currentUser.uid);
    }else{
      myFollowing = myFollowing.concat([targetUid]);
      tFollowers = tFollowers.concat([currentUser.uid]);
    }

    tx.set(myRef, { following: myFollowing }, { merge:true });
    tx.set(targetRef, { followers: tFollowers }, { merge:true });
  });

  // refresh profile view
  await loadProfile(targetUid);
}

/** =========================
 *  SEARCH (prefix search)
 *  Requires users.usernameLower set.
 *  ========================= */
let searchTimer = null;

function doSearch(){
  clearTimeout(searchTimer);
  searchTimer = setTimeout(runSearch, 200);
}

async function runSearch(){
  const q = $("searchInput").value.trim().toLowerCase();
  const res = $("searchResults");

  if(q.length < 1){
    res.innerHTML = "";
    return;
  }

  res.innerHTML = `<div class="card">Searching...</div>`;

  try{
    // prefix search on usernameLower
    const snap = await db.collection("users")
      .where("usernameLower", ">=", q)
      .where("usernameLower", "<=", q + "\uf8ff")
      .limit(20)
      .get();

    let html = "";
    snap.forEach(doc=>{
      const u = doc.data() || {};
      const uname = safeStr(u.username, "");
      if(!uname) return;

      html += `
        <div class="card">
          <div class="row" style="gap:10px;">
            <div class="avatar sm">${firstLetter(uname)}</div>
            <div class="grow">
              <div style="font-weight:900;">
                <span class="link" onclick="openProfileFromSearch('${doc.id}')">@${escapeHtml(uname)}</span>
              </div>
              <div class="muted" style="font-size:13px;">
                ${safeArr(u.followers).length} followers
              </div>
            </div>
          </div>
        </div>
      `;
    });

    res.innerHTML = html || `<div class="card">No users found.</div>`;
  }catch(e){
    console.error(e);
    res.innerHTML = `<div class="card">Search error. Check Rules + Console.</div>`;
  }
}

function openProfileFromSearch(uid){
  viewingProfileUid = uid;
  route("profile");
}

/** =========================
 *  MESSAGES + SIMPLE AI
 *  ========================= */
function chatId(a,b){
  return (a < b) ? (a + "_" + b) : (b + "_" + a);
}

function setActiveChat(uid){
  activeChatUid = uid || "AI";
  route("messages");
  loadMessages();
}

function loadMessages(){
  if(unsubscribeChat) unsubscribeChat();

  const box = $("chatBox");
  box.innerHTML = "";

  const cid = chatId(currentUser.uid, activeChatUid);
  const ref = db.collection("chats").doc(cid).collection("messages").orderBy("timestamp","asc");

  unsubscribeChat = ref.onSnapshot((snap)=>{
    box.innerHTML = "";
    snap.forEach(doc=>{
      const m = doc.data() || {};
      const who = safeStr(m.username, "unknown");
      const text = safeStr(m.text, "");
      const mine = (m.uid === currentUser.uid);

      box.insertAdjacentHTML("beforeend", `
        <div class="bubble ${mine ? "me" : ""}">
          <div style="font-weight:900; font-size:13px;">@${escapeHtml(who)}</div>
          <div style="font-size:14px;">${escapeHtml(text)}</div>
        </div>
      `);
    });
    box.scrollTop = box.scrollHeight;
  }, (err)=>{
    console.error("Chat listen error:", err);
  });
}

async function sendMessage(){
  if(!safeStr(userData?.username)){
    openUsernameModal();
    return;
  }

  const input = $("chatInput");
  const text = input.value.trim();
  if(!text) return;

  const cid = chatId(currentUser.uid, activeChatUid);
  const ref = db.collection("chats").doc(cid).collection("messages");

  await ref.add({
    uid: currentUser.uid,
    username: userData.username,
    text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  input.value = "";

  // If talking to AI, reply
  if(activeChatUid === "AI"){
    aiReply(text);
  }
}

async function aiReply(userText){
  const cid = chatId(currentUser.uid, "AI");
  const ref = db.collection("chats").doc(cid).collection("messages");

  const t = userText.toLowerCase();
  let msg = "Tell me more üëÄ";

  if(t.includes("hi") || t.includes("hello")) msg = "Hey! üëã What are you building today?";
  else if(t.includes("help")) msg = "Tell me what‚Äôs broken and what you expect to happen, and I‚Äôll guide you.";
  else if(t.includes("joke")) msg = "Why do programmers hate nature? Too many bugs üêõ";
  else if(t.includes("profile")) msg = "Profiles work best when every user doc has username, followers[], following[].";
  else if(t.includes("search")) msg = "Search works off usernameLower prefix. Make sure usernameLower is saved.";
  else if(t.includes("bye")) msg = "Later! üëã";

  setTimeout(async ()=>{
    await ref.add({
      uid: "AI",
      username: "EchoBot",
      text: msg,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  }, 700);
}
</script>
</body>
</html>