<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchoStream</title>

<!-- Firebase (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {--bg:#fff;--text:#000;--card:#f3f3f3;--border:#ddd;--accent:#1da1f2;}
body.dark {--bg:#000;--text:#fff;--card:#1a1a1a;--border:#333;}
body {margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);transition:0.3s;}
header {position:fixed;top:0;left:0;right:0;padding:14px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:bold;z-index:10;}
nav {position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;padding:12px 0;background:var(--bg);border-top:1px solid var(--border);}
nav i{font-size:20px;cursor:pointer;}
main{padding:80px 16px 90px;max-width:600px;margin:auto;}
.card{background:var(--card);padding:16px;border-radius:16px;margin-bottom:12px;}
textarea,input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);box-sizing:border-box;}
button{background:var(--accent);color:white;border:none;padding:10px 18px;border-radius:999px;font-weight:600;margin-top:8px;cursor:pointer;}
.hidden{display:none;}
.avatar{width:60px;height:60px;border-radius:50%;background:#666;color:white;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;}
.verified{color:#1da1f2;margin-left:6px;}
.post-image{max-width:100%;border-radius:12px;margin-top:8px;}
.comment{display:flex;gap:12px;margin-top:8px;}
.comment-body{flex:1;}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:50;}
.modal-content{background:var(--card);padding:32px;border-radius:16px;width:90%;max-width:400px;text-align:center;}
.username-link{cursor:pointer;}
.username-link:hover{text-decoration:underline;}
</style>
</head>
<body>

<header>
  EchoStream
  <i class="fas fa-cog" onclick="route('settings')"></i>
</header>

<main>
<!-- LOGIN -->
<div id="login">
  <h2>Welcome to EchoStream</h2>
  <button onclick="login()">Sign in with Google</button>
</div>

<!-- FEED -->
<div id="feed" class="hidden">
  <div class="card">
    <textarea id="postText" placeholder="Whatâ€™s happening?"></textarea>
    <input type="file" id="postImage" accept="image/*" style="margin-top:8px;">
    <button onclick="createPost()">Post</button>
  </div>
  <div id="posts"></div>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden"></div>

<!-- SETTINGS -->
<div id="settings" class="hidden">
  <div class="card">
    <h3>Settings</h3>
    <label><input type="checkbox" id="darkToggle"> Dark mode</label><br><br>
    <label><input type="checkbox" id="privateToggle"> Private account</label><br><br>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<!-- ADMIN -->
<div id="admin" class="hidden">
  <div class="card">
    <h3>Admin Panel</h3>
    <input id="verifyUid" placeholder="User UID to verify">
    <button onclick="verifyUser()">Verify User</button>
  </div>
  <div id="adminPanel"></div>
</div>

<!-- USERNAME MODAL -->
<div id="usernameModal" class="modal">
  <div class="modal-content">
    <h3>Pick a username</h3>
    <input id="usernameInput" placeholder="username" maxlength="20">
    <button onclick="saveUsername()">Save</button>
  </div>
</div>

</main>

<nav>
  <i class="fa fa-house" onclick="route('feed')"></i>
  <i class="fa fa-user" onclick="route('profile')"></i>
  <i class="fa fa-gear" onclick="route('settings')"></i>
  <i class="fa fa-shield" onclick="route('admin')"></i>
</nav>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let currentUser = null;
let userData = null;

// ===== AUTH =====
function login(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}
function logout(){auth.signOut().then(()=>location.reload());}

auth.onAuthStateChanged(async user=>{
  if(!user){
    document.getElementById("login").style.display="block";
    ["feed","profile","settings","admin"].forEach(p=>document.getElementById(p).classList.add("hidden"));
    return;
  }
  currentUser=user;
  document.getElementById("login").style.display="none";
  const userRef=db.collection("users").doc(user.uid);
  const snap=await userRef.get();
  if(!snap.exists){
    await userRef.set({username:user.displayName?.replace(/\s/g,"").toLowerCase()||"user",verified:false,role:"user",private:false,followers:[],following:[]});
    document.getElementById("usernameModal").style.display="flex";
  }else userData=snap.data();
  document.getElementById("darkToggle").checked=localStorage.getItem("darkMode")==="true";
  document.getElementById("privateToggle").checked=userData?.private||false;
  document.body.classList.toggle("dark",localStorage.getItem("darkMode")==="true");
  route("feed");
  loadFeed();
});

// ===== ROUTING =====
function route(page){
  ["feed","profile","settings","admin"].forEach(p=>document.getElementById(p).classList.add("hidden"));
  document.getElementById(page).classList.remove("hidden");
  if(page==="profile") loadProfile(currentUser.uid);
  if(page==="admin"){
    if(!userData||!["owner","admin"].includes(userData.role)){alert("Admins only"); route("feed"); return;}
    loadAdminPanel();
  }
}

// ===== DARK MODE =====
document.getElementById("darkToggle").onchange=function(){
  document.body.classList.toggle("dark",this.checked);
  localStorage.setItem("darkMode",this.checked);
}

// ===== PRIVATE ACCOUNT =====
document.getElementById("privateToggle").onchange=function(){togglePrivate(this.checked);}
async function togglePrivate(isPrivate){await db.collection("users").doc(currentUser.uid).update({private:isPrivate});userData.private=isPrivate;loadFeed();}

// ===== POSTS =====
async function createPost(){
  const text=document.getElementById("postText").value.trim();
  const file=document.getElementById("postImage").files[0];
  if(!text&&!file)return alert("Post cannot be empty");
  let imageUrl="";
  if(file){const path="posts/"+currentUser.uid+"/"+Date.now()+"_"+file.name;const ref=storage.ref(path);await ref.put(file);imageUrl=await ref.getDownloadURL();}
  await db.collection("posts").add({uid:currentUser.uid,username:userData.username,text,imageUrl,likes:[],comments:[],reposts:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()});
  document.getElementById("postText").value="";
  document.getElementById("postImage").value="";
  loadFeed();
}

function createPostElement(post){
  const div=document.createElement("div");div.className="card";
  let commentsHtml="";(post.comments||[]).forEach(c=>{commentsHtml+=`<div class="comment"><div class="avatar">${c.username[0].toUpperCase()}</div><div class="comment-body"><strong>${c.username}</strong><br><small>${c.text}</small></div></div>`;});
  const liked=(post.likes||[]).includes(currentUser.uid);
  const verifiedBadge=post.verified?`<span class="verified"><i class="fas fa-check-circle"></i></span>`:"";
  div.innerHTML=`<div style="display:flex;align-items:center;gap:12px;"><div class="avatar">${post.username[0].toUpperCase()}</div><div><strong class="username-link" onclick="viewUserProfile('${post.username}')">${post.username}</strong>${verifiedBadge}<br><small>${timeAgo(post.timestamp)}</small></div></div>
  <p>${post.text||""}</p>${post.imageUrl?`<img src="${post.imageUrl}" class="post-image">`:''}
  <div style="display:flex;gap:20px;margin-top:8px;">
  <span style="cursor:pointer;" onclick="toggleLike('${post.id}')"><i class="${liked?"fas":"far"} fa-heart"></i> ${post.likes?.length||0}</span>
  <span style="cursor:pointer;" onclick="toggleComments('${post.id}')"><i class="far fa-comment"></i> ${post.comments?.length||0}</span>
  <span style="cursor:pointer;" onclick="repost('${post.id}')"><i class="fas fa-retweet"></i> ${post.reposts?.length||0}</span>
  </div>
  <div id="comments-${post.id}" class="hidden">${commentsHtml}<input type="text" placeholder="Write a comment..." id="comment-input-${post.id}"><button onclick="addComment('${post.id}')">Send</button></div>`;
  return div;
}

async function loadFeed(){
  const postsDiv=document.getElementById("posts");postsDiv.innerHTML="<p>Loading feed...</p>";
  db.collection("posts").orderBy("timestamp","desc").onSnapshot(async snapshot=>{
    postsDiv.innerHTML="";
    const myFollowing=userData?.following||[];const myUid=currentUser.uid;
    for(const doc of snapshot.docs){
      const post={id:doc.id,...doc.data()};
      if(post.uid!==myUid){
        const posterSnap=await db.collection("users").doc(post.uid).get();
        if(posterSnap.data()?.private&&!myFollowing.includes(post.uid)) continue;
      }
      postsDiv.appendChild(createPostElement(post));
    }
  });
}

function timeAgo(timestamp){if(!timestamp)return"now";const s=Math.floor((Date.now()-timestamp.toDate())/1000);if(s<60)return s+"s";if(s<3600)return Math.floor(s/60)+"m";if(s<86400)return Math.floor(s/3600)+"h";return Math.floor(s/86400)+"d";}
async function toggleLike(postId){const ref=db.collection("posts").doc(postId);const snap=await ref.get();let likes=snap.data().likes||[];if(likes.includes(currentUser.uid))likes=likes.filter(u=>u!==currentUser.uid);else likes.push(currentUser.uid);await ref.update({likes});}
function toggleComments(postId){document.getElementById(`comments-${postId}`).classList.toggle("hidden");}
async function addComment(postId){const input=document.getElementById(`comment-input-${postId}`);const text=input.value.trim();if(!text)return;await db.collection("posts").doc(postId).update({comments:firebase.firestore.FieldValue.arrayUnion({uid:currentUser.uid,username:userData.username,text,timestamp:firebase.firestore.FieldValue.serverTimestamp()})});input.value="";}

// ===== PROFILE =====
async function loadProfile(uid){
  const profileDiv=document.getElementById("profile");profileDiv.innerHTML="<p>Loading profile...</p>";
  const userSnap=await db.collection("users").doc(uid).get();if(!userSnap.exists)return alert("User not found");
  const user=userSnap.data();
  const postsSnap=await db.collection("posts").where("uid","==",uid).orderBy("timestamp","desc").get();
  let postsHtml="";postsSnap.forEach(doc=>{const p=doc.data();postsHtml+=`<div class="card"><p>${p.text||""}</p>${p.imageUrl?`<img src="${p.imageUrl}" class="post-image">`:''}</div>`;});
  profileDiv.innerHTML=`<div style="text-align:center;margin-bottom:16px;"><div class="avatar">${user.username[0].toUpperCase()}</div><h3>${user.username}${user.verified?` <span class="verified"><i class="fas fa-check-circle"></i></span>`:""}</h3><p>Followers: ${user.followers?.length||0} | Following: ${user.following?.length||0}</p>${uid!==currentUser.uid?`<button onclick="toggleFollow('${uid}')">Follow / Unfollow</button>`:""}</div><h4>Posts</h4>${postsHtml}`;
}

// ===== FOLLOW =====
async function toggleFollow(targetUid){
  if(currentUser.uid===targetUid)return alert("Can't follow yourself");
  const myRef=db.collection("users").doc(currentUser.uid);
  const targetRef=db.collection("users").doc(targetUid);
  const [mySnap,targetSnap]=await Promise.all([myRef.get(),targetRef.get()]);
  let myFollowing=mySnap.data().following||[],targetFollowers=targetSnap.data().followers||[];
  if(myFollowing.includes(targetUid)){myFollowing=myFollowing.filter(u=>u!==targetUid);targetFollowers=targetFollowers.filter(u=>u!==currentUser.uid);}
  else{myFollowing.push(targetUid);targetFollowers.push(currentUser.uid);}
  await Promise.all([myRef.update({following:myFollowing}),targetRef.update({followers:targetFollowers})]);
  loadProfile(targetUid);
}

async function viewUserProfile(username){
  const snap=await db.collection("users").where("username","==",username).get();
  if(snap.empty)return alert("User not found");
  const doc=snap.docs[0];
  loadProfile(doc.id);
  route("profile");
}

// ===== REPOST =====
async function repost(postId){
  const snap=await db.collection("posts").doc(postId).get();
  const original=snap.data();
  await db.collection("posts").add({uid:currentUser.uid,username:userData.username,text:original.text,imageUrl:original.imageUrl||"",likes:[],comments:[],reposts:[],timestamp:firebase.firestore.FieldValue.serverTimestamp(),originalId:postId});
  await db.collection("posts").doc(postId).update({reposts:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
}

// ===== ADMIN =====
async function verifyUser(){
  const uid=document.getElementById("verifyUid").value.trim();if(!uid)return alert("Enter UID");
  await db.collection("users").doc(uid).update({verified:true});
  alert("User verified!");loadAdminPanel();
}
async function promoteUser(uid){if(userData.role!=="owner")return alert("Only owner can promote");await db.collection("users").doc(uid).update({role:"admin"});alert("User promoted!");loadAdminPanel();}
async function banUser(uid){if(!["owner","admin"].includes(userData.role))return alert("Unauthorized");await db.collection("users").doc(uid).update({banned:true});alert("User banned!");loadAdminPanel();}
async function loadAdminPanel(){
  const panel=document.getElementById("adminPanel");panel.innerHTML="<p>Loading users...</p>";
  const usersSnap=await db.collection("users").get();
  let usersHtml="<h3>All Users</h3>";
  usersSnap.forEach(doc=>{const u=doc.data();usersHtml+=`<div class="card" style="margin:8px 0;"><strong>${u.username||"No username"}</strong>${u.verified?` <span class="verified"><i class="fas fa-check-circle"></i></span>`:""}<br>Role: ${u.role||"user"}<button onclick="verifyUser('${doc.id}')">Verify</button><button onclick="promoteUser('${doc.id}')">Promote to Admin</button><button onclick="banUser('${doc.id}')">Ban</button></div>`;});
  panel.innerHTML=usersHtml;
}

// ===== USERNAME MODAL =====
async function saveUsername(){
  let input=document.getElementById("usernameInput").value.trim().toLowerCase();
  if(input.length<3)return alert("Username too short");
  if(!/^[a-z0-9_]+$/.test(input))return alert("Invalid characters");
  const snap=await db.collection("users").where("username","==",input).get();
  if(!snap.empty)return alert("Username taken");
  await db.collection("users").doc(currentUser.uid).update({username:input});
  userData.username=input;
  document.getElementById("usernameModal").style.display="none";
  loadFeed();
}
</script>
</body>
</html>
