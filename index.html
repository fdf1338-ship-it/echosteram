// Firebase configuration
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let currentUser, userData;

function signUp() {
  const email = prompt("Enter your email:");
  const password = prompt("Enter your password:");
  if (!email || !password) {
    alert("Please enter a valid email and password.");
    return;
  }
  auth
    .createUserWithEmailAndPassword(email, password)
    .then(async (userCredential) => {
      currentUser = userCredential.user;
      await db.collection("users").doc(currentUser.uid)
        .set({
          username: "",
          following: [],
          followers: []
        })
        .then(() => {
          usernameModal.style.display = "flex";
          usernameInput.focus();
        })
        .catch((error) => {
          console.error("Error setting user data:", error);
          alert("Error signing up. Please try again later.");
        });
    })
    .catch((error) => {
      console.error("Error signing up:", error);
      alert("Error signing up. Please try again later.");
    });
}

function login() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
    .then(() => {
      route("feed");
    })
    .catch((error) => {
      console.error("Error signing in:", error);
      alert("Error signing in. Please try again later.");
    });
}

function logout() {
  auth.signOut()
    .then(() => {
      location.reload();
    })
    .catch((error) => {
      console.error("Error signing out:", error);
      alert("Error signing out. Please try again later.");
    });
}

async function createPost() {
  const text = postText.value.trim();
  const file = postImage.files[0];
  let imageUrl = "";

  if (file) {
    const path = `posts/${currentUser.uid}/${Date.now()}_${file.name}`;
    const ref = storage.ref(path);
    await ref.put(file);
    imageUrl = await ref.getDownloadURL();
  }

  await db.collection("posts").add({
    uid: currentUser.uid,
    username: userData.username,
    text,
    imageUrl,
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  postText.value = "";
  postImage.value = "";
}

async function loadFeed() {
  db.collection("posts")
    .orderBy("timestamp", "desc")
    .onSnapshot((snap) => {
      posts.innerHTML = "";
      snap.forEach((doc) => {
        const p = doc.data();
        posts.innerHTML += `
          <div class="card">
            <strong onclick="viewUser('${p.username}')">${p.username}</strong>
            <p>${p.text}</p>
            ${p.imageUrl ? `<img src="${p.imageUrl}" class="post-image">` : ""}
          </div>
        `;
      });
    });
}

async function loadProfile(uid) {
  const snap = await db.collection("users").doc(uid).get();
  const u = snap.data();
  profile.innerHTML = `
    <div class="card">
      <div class="avatar">${u.username[0].toUpperCase()}</div>
      <h3>${u.username}</h3>
    </div>
  `;
}

async function viewUser(username) {
  const snap = await db.collection("users").where("username", "==", username).get();
  if (!snap.empty) {
    loadProfile(snap.docs[0].id);
    route("profile");
  }
}

async function saveUsername() {
  const name = usernameInput.value.trim().toLowerCase();
  await db.collection("users").doc(currentUser.uid)
    .update({ username: name })
    .then(() => {
      userData.username = name;
      usernameModal.style.display = "none";
      route("profile");
    })
    .catch((error) => {
      console.error("Error saving username:", error);
      alert("Error saving username. Please try again later.");
    });
}

function route(page) {
  ["feed", "profile", "settings"].forEach((p) =>
