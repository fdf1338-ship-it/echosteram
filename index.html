<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchoStream</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {--bg:#fff;--text:#000;--card:#f3f3f3;--border:#ddd;--accent:#1da1f2;}
body.dark{--bg:#000;--text:#fff;--card:#1a1a1a;--border:#333;}
body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);}
header{position:fixed;top:0;left:0;right:0;padding:14px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;z-index:10;font-weight:bold;}
nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;padding:12px 0;background:var(--bg);border-top:1px solid var(--border);}
nav i{font-size:22px;cursor:pointer;}
main{padding:80px 16px 90px;max-width:600px;margin:auto;}
.card{background:var(--card);padding:16px;border-radius:16px;margin-bottom:12px;}
textarea,input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);box-sizing:border-box;}
button{background:var(--accent);color:#fff;border:none;padding:10px 18px;border-radius:999px;cursor:pointer;margin-top:8px;font-weight:600;}
.hidden{display:none;}
.avatar{width:50px;height:50px;border-radius:50%;background:#666;color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;}
.verified{color:#1da1f2;margin-left:6px;}
.post-image{max-width:100%;border-radius:12px;margin-top:8px;}
.comment{display:flex;gap:12px;margin-top:8px;}
.comment-body{flex:1;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);justify-content:center;align-items:center;z-index:50;}
.modal-content{background:var(--card);padding:32px;border-radius:16px;width:90%;max-width:400px;text-align:center;}
.username-link{cursor:pointer;}
.username-link:hover{text-decoration:underline;}
#chatBox{height:300px;overflow-y:auto;border:1px solid var(--border);padding:8px;border-radius:12px;margin-bottom:8px;}
#chatInput{width:100%;padding:8px;border-radius:12px;border:1px solid var(--border);margin-bottom:8px;}
</style>
</head>

<body>
<header>
EchoStream
<i class="fas fa-cog" onclick="route('settings')"></i>
</header>

<main>

<!-- LOGIN -->
<div id="login">
<h2>Welcome to EchoStream</h2>
<button onclick="login()">Sign in with Google</button>
</div>

<!-- FEED -->
<div id="feed" class="hidden">
<div class="card">
<textarea id="postText" placeholder="Whatâ€™s happening?"></textarea>
<input type="file" id="postImage" accept="image/*">
<button onclick="createPost()">Post</button>
</div>
<div id="posts"></div>
</div>

<!-- SEARCH -->
<div id="search" class="hidden">
<input type="text" id="searchInput" placeholder="Search users..." oninput="doSearch()">
<div id="searchResults"></div>
</div>

<!-- MESSAGES -->
<div id="messages" class="hidden">
<div id="chatBox"></div>
<input type="text" id="chatInput" placeholder="Type a message...">
<button onclick="sendMessage()">Send</button>
</div>

<!-- PROFILE -->
<div id="profile" class="hidden"></div>

<!-- SETTINGS -->
<div id="settings" class="hidden">
<div class="card">
<label><input type="checkbox" id="darkToggle"> Dark mode</label><br><br>
<button onclick="logout()">Logout</button>
</div>
</div>

<!-- USERNAME MODAL -->
<div id="usernameModal" class="modal">
<div class="modal-content">
<h3>Pick a username</h3>
<input id="usernameInput" placeholder="username" maxlength="20">
<button onclick="saveUsername()">Save</button>
</div>
</div>

</main>

<nav>
<i class="fa fa-house" onclick="route('feed')"></i>
<i class="fa fa-magnifying-glass" onclick="route('search')"></i>
<i class="fa fa-message" onclick="route('messages')"></i>
<i class="fa fa-user" onclick="route('profile')"></i>
</nav>

<script>
firebase.initializeApp({
apiKey:"AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
authDomain:"echostream-a102a.firebaseapp.com",
projectId:"echostream-a102a",
storageBucket:"echostream-a102a.appspot.com",
messagingSenderId:"789062222400",
appId:"1:789062222400:web:73d478269135a77d7d55a5"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let currentUser, userData, activeChatUid = null;

function login(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}
function logout(){auth.signOut().then(()=>location.reload());}

auth.onAuthStateChanged(async user=>{
if(!user){document.getElementById("login").style.display="block";return;}
currentUser=user;
document.getElementById("login").style.display="none";
const ref=db.collection("users").doc(user.uid);
const snap=await ref.get();
if(!snap.exists){
await ref.set({username:user.displayName.replace(/\s/g,"").toLowerCase(),followers:[],following:[]});
document.getElementById("usernameModal").style.display="flex";
}else{userData=snap.data();}
route("feed");
loadFeed();
});

// DARK MODE
document.getElementById("darkToggle").onchange=function(){
document.body.classList.toggle("dark",this.checked);
localStorage.setItem("darkMode",this.checked);
};
if(localStorage.getItem("darkMode")==="true")document.body.classList.add("dark");

// ROUTING
function route(page){
["feed","search","messages","profile","settings"].forEach(p=>document.getElementById(p).classList.add("hidden"));
document.getElementById(page).classList.remove("hidden");
if(page==="profile")loadProfile(currentUser.uid);
}

// CREATE POST
async function createPost(){
const text=document.getElementById("postText").value.trim();
const file=document.getElementById("postImage").files[0];
let imageUrl="";
if(file){
const path=`posts/${currentUser.uid}/${Date.now()}_${file.name}`;
const ref=storage.ref(path);
await ref.put(file);
imageUrl=await ref.getDownloadURL();
}
await db.collection("posts").add({
uid:currentUser.uid,
username:userData.username,
text,imageUrl,likes:[],comments:[],shares:[],timestamp:firebase.firestore.FieldValue.serverTimestamp()
});
document.getElementById("postText").value="";
document.getElementById("postImage").value="";
}

// LOAD FEED
function createPostElement(post,id){
const liked=post.likes?.includes(currentUser.uid);
let commentsHtml="";
(post.comments||[]).forEach(c=>{
commentsHtml+=`<div class="comment">
<div class="avatar">${c.username[0].toUpperCase()}</div>
<div class="comment-body"><strong>${c.username}</strong><br>${c.text}</div>
</div>`;
});
return `
<div class="card">
<div style="display:flex;align-items:center;gap:12px;">
<div class="avatar">${post.username[0].toUpperCase()}</div>
<div>
<strong class="username-link" onclick="loadProfile('${post.uid}')">${post.username}</strong><br>
<small>${timeAgo(post.timestamp)}</small>
</div>
</div>
<p>${post.text}</p>
${post.imageUrl?`<img src="${post.imageUrl}" class="post-image">`:""}
<div style="display:flex;gap:20px;margin-top:8px;">
<span style="cursor:pointer;" onclick="toggleLike('${id}')">
<i class="${liked?"fas":"far"} fa-heart"></i> ${post.likes?.length||0}
</span>
<span style="cursor:pointer;" onclick="toggleComments('${id}')">
<i class="far fa-comment"></i> ${post.comments?.length||0}
</span>
<span style="cursor:pointer;" onclick="sharePost('${id}')">
<i class="fas fa-retweet"></i> ${post.shares?.length||0}
</span>
</div>
<div id="comments-${id}" class="hidden">
${commentsHtml}
<input type="text" placeholder="Comment..." id="commentInput-${id}"><button onclick="addComment('${id}')">Send</button>
</div>
</div>`;
}

function loadFeed(){
const postsDiv=document.getElementById("posts");
db.collection("posts").orderBy("timestamp","desc").onSnapshot(snapshot=>{
postsDiv.innerHTML="";
snapshot.forEach(doc=>{
postsDiv.innerHTML+=createPostElement(doc.data(),doc.id);
});
});
}

function timeAgo(timestamp){
if(!timestamp)return"now";
const seconds=Math.floor((Date.now()-timestamp.toDate())/1000);
if(seconds<60)return seconds+"s";
if(seconds<3600)return Math.floor(seconds/60)+"m";
if(seconds<86400)return Math.floor(seconds/3600)+"h";
return Math.floor(seconds/86400)+"d";
}

// LIKES / COMMENTS / SHARES
async function toggleLike(postId){
const ref=db.collection("posts").doc(postId);
const snap=await ref.get();
let likes=snap.data().likes||[];
if(likes.includes(currentUser.uid))likes=likes.filter(u=>u!==currentUser.uid);
else likes.push(currentUser.uid);
await ref.update({likes});
}
function toggleComments(postId){
document.getElementById(`comments-${postId}`).classList.toggle("hidden");
}
async function addComment(postId){
const input=document.getElementById(`commentInput-${postId}`);
const text=input.value.trim();
if(!text)return;
await db.collection("posts").doc(postId).update({
comments:firebase.firestore.FieldValue.arrayUnion({uid:currentUser.uid,username:userData.username,text})
});
input.value="";
}
async function sharePost(postId){
await db.collection("posts").doc(postId).update({
shares:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
});
}

// PROFILE
async function loadProfile(uid){
const snap=await db.collection("users").doc(uid).get();
const u=snap.data();
const postsSnap=await db.collection("posts").where("uid","==",uid).orderBy("timestamp","desc").get();
let postsHtml="";
postsSnap.forEach(doc=>{
const p=doc.data();
postsHtml+=`<div class="card"><p>${p.text}</p>${p.imageUrl?`<img src="${p.imageUrl}" class="post-image">`:""}</div>`;
});
document.getElementById("profile").innerHTML=`
<div class="card" style="text-align:center">
<div class="avatar">${u.username[0].toUpperCase()}</div>
<h3>${u.username}</h3>
<p>Followers: ${u.followers?.length||0} | Following: ${u.following?.length||0}</p>
${uid!==currentUser.uid?`<button onclick="toggleFollow('${uid}')">Follow/Unfollow</button>`:""}
</div>
<h4>Posts</h4>${postsHtml}`;
}

// FOLLOW
async function toggleFollow(uid){
const myRef=db.collection("users").doc(currentUser.uid);
const targetRef=db.collection("users").doc(uid);
const [mySnap,targetSnap]=await Promise.all([myRef.get(),targetRef.get()]);
let myData=mySnap.data();
let targetData=targetSnap.data();
let following=myData.following||[];
let followers=targetData.followers||[];
if(following.includes(uid)){following=following.filter(u=>u!==uid);followers=followers.filter(u=>u!==currentUser.uid);}
else{following.push(uid);followers.push(currentUser.uid);}
await Promise.all([myRef.update({following}),targetRef.update({followers})]);
loadProfile(uid);
}

// SEARCH
async function doSearch(){
const q=document.getElementById("searchInput").value.toLowerCase();
const res=document.getElementById("searchResults");
if(!q){res.innerHTML="";return;}
const snap=await db.collection("users").get();
let html="";
snap.forEach(doc=>{
const u=doc.data();
if(u.username.includes(q))html+=`<div class="card"><strong onclick="loadProfile('${doc.id}')">${u.username}</strong></div>`;
});
res.innerHTML=html;
}

// USERNAME
async function saveUsername(){
const name=document.getElementById("usernameInput").value.trim().toLowerCase();
if(!/^[a-z0-9_]+$/.test(name)){alert("Only lowercase letters, numbers, underscore");return;}
const snap=await db.collection("users").where("username","==",name).get();
if(!snap.empty){alert("Username taken");return;}
await db.collection("users").doc(currentUser.uid).update({username:name});
userData.username=name;
document.getElementById("usernameModal").style.display="none";
}

// MESSAGES + AI
function chatId(a,b){return a<b?a+"_"+b:b+"_"+a;}
async function sendMessage(){
const text=document.getElementById("chatInput").value.trim();
if(!text)return;
if(!activeChatUid){activeChatUid="AI";}
const ref=db.collection("messages").doc(chatId(currentUser.uid,activeChatUid)).collection("messages");
await ref.add({uid:currentUser.uid,username:userData.username,text,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
document.getElementById("chatInput").value="";
aiReply();
loadMessages();
}
async function loadMessages(){
const box=document.getElementById("chatBox");
if(!activeChatUid)activeChatUid="AI";
const ref=db.collection("messages").doc(chatId(currentUser.uid,activeChatUid)).collection("messages").orderBy("timestamp");
ref.onSnapshot(snap=>{
box.innerHTML="";
snap.forEach(doc=>{
const m=doc.data();
box.innerHTML+=`<div class="card" style="margin:4px 0;padding:6px;"><strong>${m.username}</strong>: ${m.text}</div>`;
});
box.scrollTop=box.scrollHeight;
});
}

// SIMPLE AI
async function aiReply(){
if(!activeChatUid)return;
const inputText=document.getElementById("chatInput").value.toLowerCase();
let msg="Tell me more!";
if(inputText.includes("hi")||inputText.includes("hello"))msg="Hello! How are you?";
else if(inputText.includes("how are you"))msg="I'm a bot, doing great!";
else if(inputText.includes("help"))msg="Sure! What do you need help with?";
else if(inputText.includes("joke"))msg="Why did the programmer quit? He didn't get arrays!";
else if(inputText.includes("bye"))msg="Goodbye! Talk to you soon!";
setTimeout(async()=>{
await db.collection("messages").doc(chatId(currentUser.uid,activeChatUid)).collection("messages").add({uid:"AI",username:"EchoBot",text:msg,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
loadMessages();
},1000);
}
</script>

</body>
</html>