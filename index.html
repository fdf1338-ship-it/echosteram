<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>EchoStream</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root {
  --bg:#fff; --text:#000; --card:#fff; --border:#ddd;
  --accent:#1da1f2; --red:#ff2d2d;
}
body.dark {
  --bg:#000; --text:#fff; --card:#1a1a1a; --border:#333;
}
body {
  margin:0; font-family:system-ui; background:var(--bg);
  color:var(--text); transition:.3s;
}
.container { text-align:center; padding-top:100px; }
button {
  background:var(--accent); color:#fff; border:none;
  padding:12px 28px; border-radius:999px; font-weight:600;
  cursor:pointer;
}
textarea,input {
  width:100%; padding:14px; border-radius:14px;
  border:1px solid var(--border); background:var(--card);
  color:var(--text);
}
.header {
  position:fixed; top:0; left:0; right:0;
  padding:10px 16px; display:flex; justify-content:space-between;
  background:var(--bg); border-bottom:1px solid var(--border);
}
.feed { margin-top:70px; padding-bottom:100px; }
.post {
  background:var(--card); margin:12px 16px;
  padding:16px; border-radius:16px;
}
.avatar {
  width:40px;height:40px;border-radius:50%;
  background:#666;color:#fff;font-weight:bold;
  display:flex;align-items:center;justify-content:center;
}
.post-header { display:flex; gap:10px; align-items:center; }
.username { color:var(--accent); cursor:pointer; font-weight:600; }
.time { font-size:12px; color:#888; margin-left:auto; }
.post-actions { display:flex; justify-content:space-around; margin-top:10px; color:#666; }
.action { cursor:pointer; display:flex; gap:6px; }
.action.liked { color:#e0245e; }
.bottom-nav {
  position:fixed; bottom:0; left:0; right:0;
  display:flex; justify-content:space-around;
  background:var(--bg); border-top:1px solid var(--border);
  padding:10px 0;
}
.nav-item { font-size:22px; color:#666; cursor:pointer; }
.nav-item.active { color:var(--accent); }
.comments { display:none; margin-top:10px; }
.comment { display:flex; gap:10px; margin-top:8px; }
.comment-avatar {
  width:30px;height:30px;border-radius:50%;
  background:#555;color:#fff;font-size:14px;
  display:flex;align-items:center;justify-content:center;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="container">
  <h1>EchoStream</h1>
  <p style="color:var(--red)">The feed they don't want you seeing.</p>
  <button id="loginBtn">Sign in with Google</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

<div class="header">
  <strong>EchoStream</strong>
  <i class="fas fa-moon" onclick="toggleDark()"></i>
</div>

<div class="feed" id="feed"></div>

<div class="bottom-nav">
  <i class="fas fa-home nav-item active" onclick="switchTab('home')"></i>
  <i class="fas fa-search nav-item" onclick="switchTab('search')"></i>
  <i class="fas fa-user nav-item" onclick="switchTab('profile')"></i>
</div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
  authDomain:"echostream-a102a.firebaseapp.com",
  projectId:"echostream-a102a",
  storageBucket:"echostream-a102a.appspot.com"
});
const auth=firebase.auth();
const db=firebase.firestore();

let user=null, userData=null, allPosts=[];

/* AUTH */
loginBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
auth.onAuthStateChanged(async u=>{
  if(!u) return;
  user=u;
  login.style.display="none";
  app.style.display="block";
  await loadUser();
  loadFeed();
});

/* USER */
async function loadUser(){
  const ref=db.collection("users").doc(user.uid);
  const snap=await ref.get();
  if(!snap.exists){
    const username=prompt("Pick a username");
    await ref.set({username});
    userData={username};
  } else userData=snap.data();
}

/* POSTS */
async function loadFeed(){
  const snap=await db.collection("posts").orderBy("timestamp","desc").get();
  allPosts=snap.docs.map(d=>({id:d.id,...d.data()}));
  render(allPosts);
}

function render(posts){
  feed.innerHTML="";
  posts.forEach(p=>{
    const liked=p.likes?.includes(user.uid);
    const div=document.createElement("div");
    div.className="post";
    div.innerHTML=`
      <div class="post-header">
        <div class="avatar">${p.username[0]}</div>
        <div class="username" onclick="openProfile('${p.username}')">${p.username}</div>
        <div class="time">${timeAgo(p.timestamp)}</div>
      </div>
      <div>${p.text}</div>
      <div class="post-actions">
        <div class="action ${liked?"liked":""}" onclick="like('${p.id}')">
          <i class="fa${liked?"s":"r"} fa-heart"></i> ${p.likes?.length||0}
        </div>
        <div class="action" onclick="toggleComments('${p.id}')">
          <i class="far fa-comment"></i> ${p.comments?.length||0}
        </div>
        <div class="action" onclick="repost('${p.id}')">
          <i class="fas fa-retweet"></i> ${p.reposts?.length||0}
        </div>
      </div>
      <div class="comments" id="c-${p.id}"></div>
    `;
    const c=div.querySelector(`#c-${p.id}`);
    (p.comments||[]).forEach(cm=>{
      const cd=document.createElement("div");
      cd.className="comment";
      cd.innerHTML=`
        <div class="comment-avatar">${cm.username[0]}</div>
        <div><b>${cm.username}</b><br>${cm.text}</div>
      `;
      c.appendChild(cd);
    });
    feed.appendChild(div);
  });
}

/* ACTIONS */
async function like(id){
  const ref=db.collection("posts").doc(id);
  const doc=await ref.get();
  let likes=doc.data().likes||[];
  likes=likes.includes(user.uid)?likes.filter(x=>x!==user.uid):[...likes,user.uid];
  await ref.update({likes});
  loadFeed();
}

async function repost(id){
  await db.collection("posts").doc(id).update({
    reposts:firebase.firestore.FieldValue.arrayUnion(user.uid)
  });
  loadFeed();
}

function toggleComments(id){
  const el=document.getElementById(`c-${id}`);
  el.style.display=el.style.display==="block"?"none":"block";
}

/* UTIL */
function timeAgo(ts){
  if(!ts) return "now";
  const s=Math.floor((Date.now()-ts.toDate())/1000);
  if(s<60) return s+"s";
  if(s<3600) return Math.floor(s/60)+"m";
  if(s<86400) return Math.floor(s/3600)+"h";
  return Math.floor(s/86400)+"d";
}
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.dark=document.body.classList.contains("dark");
}
if(localStorage.dark==="true") document.body.classList.add("dark");
</script>

</body>
</html>