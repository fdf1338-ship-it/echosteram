<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoStream</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --bg: #fff; --text: #000; --card: #fff; --border: #ddd; --accent: #1da1f2; --red: #ff0000; }
        body.dark { --bg: #000; --text: #fff; --card: #1a1a1a; --border: #333; }
        body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); transition:0.3s; }
        .container { max-width:600px; margin:0 auto; text-align:center; padding-top:100px; }
        h1 { font-size:48px; margin:0; }
        .tagline { color:var(--red); font-size:16px; margin:15px 0 30px; font-weight:600; }
        button { padding:12px 28px; background:var(--accent); color:white; border:none; border-radius:999px; cursor:pointer; font-size:16px; font-weight:600; }
        button:hover { opacity:0.9; }
        #app { display:none; }
        .header { position:fixed; top:0; left:0; right:0; background:var(--bg); border-bottom:1px solid var(--border); padding:10px 16px; display:flex; justify-content:space-between; align-items:center; z-index:10; }
        .logo { width:40px; height:40px; }
        .avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; background:#666; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:bold; color:white; }
        .bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--bg); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:8px 0; z-index:10; }
        .nav-item { font-size:26px; color:#666; cursor:pointer; }
        .nav-item.active { color:var(--accent); }
        .post-box { margin:70px 20px 80px; }
        textarea { width:100%; min-height:100px; padding:16px; border:1px solid var(--border); border-radius:16px; background:var(--card); color:var(--text); font-size:16px; resize:none; }
        .feed { padding-bottom:100px; }
        .post { background:var(--card); margin:12px 20px; padding:16px; border-radius:16px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .post-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
        .post-user { display:flex; align-items:center; gap:8px; }
        .username { font-weight:600; cursor:pointer; color:var(--accent); text-decoration:underline; }
        .time { font-size:14px; color:#666; margin-left:auto; }
        .post-text { margin:8px 0 16px; white-space:pre-wrap; font-size:16px; line-height:1.5; }
        .post-actions { display:flex; justify-content:space-around; font-size:20px; color:#666; }
        .action { cursor:pointer; display:flex; align-items:center; gap:6px; }
        .action.liked { color:#e0245e; }
        .action-count { font-size:14px; }
        .comments-section { margin-top:16px; padding-top:12px; border-top:1px solid var(--border); display:none; }
        .comment { display:flex; gap:12px; margin-top:12px; }
        .comment-avatar { width:32px; height:32px; border-radius:50%; background:#666; flex-shrink:0; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; }
        .comment-body { flex:1; }
        .comment-input { width:100%; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--card); color:var(--text); margin-top:8px; }
        #settings-sidebar { position:fixed; top:0; bottom:0; right:-320px; width:320px; background:var(--card); box-shadow:-4px 0 16px rgba(0,0,0,0.2); transition:right 0.3s ease; z-index:20; padding:20px; overflow-y:auto; }
        #settings-sidebar.open { right:0; }
        .settings-header { font-size:20px; font-weight:bold; margin-bottom:20px; }
        .settings-item { padding:16px 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
        .switch { position:relative; display:inline-block; width:52px; height:32px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#ccc; transition:0.4s; border-radius:34px; }
        .slider:before { position:absolute; content:""; height:26px; width:26px; left:3px; bottom:3px; background:white; transition:0.4s; border-radius:50%; }
        input:checked + .slider { background:var(--accent); }
        input:checked + .slider:before { transform:translateX(20px); }
        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:30; }
        .modal-content { background:var(--card); padding:32px; border-radius:16px; width:90%; max-width:400px; text-align:center; }
        #search-view, #messages-view, #profile-view { display:none; padding:20px; margin-top:70px; }
        .overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:15; display:none; }
    </style>
</head>
<body>
    <div id="login-screen" class="container">
        <h1>EchoStream</h1>
        <p class="tagline">The feed they don't want you seeing.</p>
        <button id="google-signin">Sign in with Google</button>
    </div>

    <div id="app">
        <div class="header">
            <svg class="logo" viewBox="0 0 32 32">
                <circle cx="16" cy="16" r="14" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="16" cy="16" r="4" fill="var(--red)"/>
            </svg>
            <i class="fas fa-cog" style="font-size:26px;cursor:pointer;" onclick="toggleSettings()"></i>
        </div>

        <div class="post-box">
            <textarea id="post-text" placeholder="What's happening?"></textarea>
            <button onclick="createPost()">Post</button>
        </div>

        <div class="feed" id="feed"></div>

        <div id="search-view">
            <input id="search-input" placeholder="Search EchoStream..." oninput="searchPosts()" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; margin-bottom:20px;"/>
            <div id="search-results"></div>
        </div>

        <div id="messages-view">
            <h2>Messages</h2>
            <p>Direct messages will appear here when someone messages you.</p>
        </div>

        <div id="profile-view">
            <div style="text-align:center; margin:20px 0;">
                <div class="avatar" id="profile-avatar" style="margin:0 auto; width:80px; height:80px; font-size:32px;">?</div>
                <h2 id="profile-username">Loading...</h2>
            </div>
            <div id="profile-posts"></div>
        </div>

        <div class="bottom-nav">
            <i class="fas fa-home nav-item active" onclick="switchTab('home')"></i>
            <i class="fas fa-search nav-item" onclick="switchTab('search')"></i>
            <i class="fas fa-envelope nav-item" onclick="switchTab('messages')"></i>
            <i class="fas fa-user nav-item" onclick="switchTab('profile')"></i>
        </div>
    </div>

    <div class="overlay" onclick="toggleSettings()"></div>

    <!-- Settings Sidebar -->
    <div id="settings-sidebar">
        <i class="fas fa-times" style="position:absolute; top:16px; right:16px; font-size:26px; cursor:pointer;" onclick="toggleSettings()"></i>
        <div class="settings-header">Settings</div>
        <div class="settings-item">
            <span>Dark mode</span>
            <label class="switch">
                <input type="checkbox" id="dark-toggle" onchange="toggleDark()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="settings-item"><span>Privacy & safety</span><span>Public</span></div>
        <div class="settings-item"><span>Notifications</span><span>All on</span></div>
        <div class="settings-item"><span>Display</span><span>Standard</span></div>
        <div class="settings-item"><span>Security</span><span>2FA off</span></div>
        <div class="settings-item"><span>Change profile picture</span><input type="file" accept="image/*" onchange="uploadProfilePic(event)"></div>
        <div class="settings-item"><span>About</span><span>Built with hope and a laptop</span></div>
        <button style="background:#d33; width:100%; padding:14px; margin-top:30px; border-radius:999px;" onclick="logout()">Logout</button>
    </div>

    <!-- Username Modal -->
    <div id="username-modal" class="modal">
        <div class="modal-content">
            <h2>Pick a username</h2>
            <input id="username-input" placeholder="username" maxlength="20" style="width:100%; padding:12px; font-size:16px; margin:15px 0;"/>
            <button onclick="saveUsername()">Save</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
            authDomain: "echostream-a102a.firebaseapp.com",
            projectId: "echostream-a102a",
            storageBucket: "echostream-a102a.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentUser = null;
        let currentUserData = null;
        let allPosts = [];

        document.getElementById('google-signin').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                await loadUserData();
                loadFeed();
            }
        });

        async function loadUserData() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                currentUserData = doc.data();
                if (!currentUserData.username) {
                    document.getElementById('username-modal').style.display = 'flex';
                }
            } else {
                document.getElementById('username-modal').style.display = 'flex';
            }
        }

        async function saveUsername() {
            const input = document.getElementById('username-input').value.trim();
            if (input.length < 3) return alert('Too short');
            const snap = await db.collection('users').where('username', '==', input).get();
            if (!snap.empty) return alert('Taken');
            await db.collection('users').doc(currentUser.uid).set({username: input}, {merge: true});
            currentUserData = {username: input};
            document.getElementById('username-modal').style.display = 'none';
            loadFeed();
        }

        function toggleDark() {
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark');
            document.getElementById('dark-toggle').checked = true;
        }

        async function createPost() {
            const text = document.getElementById('post-text').value.trim();
            if (!text) return;
            await db.collection('posts').add({
                text,
                uid: currentUser.uid,
                username: currentUserData.username,
                likes: [],
                comments: [],
                reposts: [],
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('post-text').value = '';
            loadFeed();
        }

        async function loadFeed() {
            const snap = await db.collection('posts').orderBy('timestamp', 'desc').get();
            allPosts = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderFeed(allPosts);
        }

        function renderFeed(posts) {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            posts.forEach(p => {
                if (!p.username || p.username.length < 3) return;
                const isLiked = p.likes?.includes(currentUser?.uid);
                const div = document.createElement('div');
                div.className = 'post';
                div.innerHTML = `
                    <div class="post-header">
                        <div class="avatar">${p.username[0].toUpperCase()}</div>
                        <div class="post-user">
                            <div class="username" onclick="alert('Profile view coming soon')">${p.username}</div>
                            <div class="time">${timeAgo(p.timestamp)}</div>
                        </div>
                    </div>
                    <div class="post-text">${p.text}</div>
                    <div class="post-actions">
                        <div class="action \( {isLiked ? 'liked' : ''}" onclick="toggleLike(' \){p.id}')">
                            <i class="fa${isLiked ? 's' : 'r'} fa-heart"></i>
                            <span class="action-count">${p.likes?.length || 0}</span>
                        </div>
                        <div class="action" onclick="toggleComments('${p.id}')">
                            <i class="far fa-comment"></i>
                            <span class="action-count">${p.comments?.length || 0}</span>
                        </div>
                        <div class="action" onclick="alert('Repost coming soon')">
                            <i class="fas fa-retweet"></i>
                            <span class="action-count">${p.reposts?.length || 0}</span>
                        </div>
                    </div>
                    <div class="comments-section" id="comments-${p.id}">
                        <div id="comments-list-${p.id}"></div>
                        <input class="comment-input" id="comment-input-${p.id}" placeholder="Write a reply...">
                        <button onclick="addComment('${p.id}')">Send</button>
                    </div>
                `;
                feed.appendChild(div);
            });
        }

        async function toggleLike(postId) {
            if (!currentUser) return alert('Sign in to like');
            const ref = db.collection('posts').doc(postId);
            const doc = await ref.get();
            let likes = doc.data().likes || [];
            if (likes.includes(currentUser.uid)) {
                likes = likes.filter(u => u !== currentUser.uid);
            } else {
                likes.push(currentUser.uid);
            }
            await ref.update({likes});
            loadFeed();
        }

        async function addComment(postId) {
            if (!currentUser) return alert('Sign in to comment');
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;
            const comment = {
                text,
                uid: currentUser.uid,
                username: currentUserData.username,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('posts').doc(postId).update({comments: firebase.firestore.FieldValue.arrayUnion(comment)});
            input.value = '';
            loadFeed();
        }

        function toggleComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            section.style.display = section.style.display === 'block' ? 'none' : 'block';
        }

        function timeAgo(ts) {
            if (!ts) return 'now';
            const seconds = Math.floor((Date.now() - ts.toDate()) / 1000);
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }

        function toggleSettings() {
            const sidebar = document.getElementById('settings-sidebar');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('open');
            overlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
        }

        function switchTab(tab) {
            document.querySelectorAll('#feed, #search-view, #messages-view, #profile-view').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if (tab === 'home') {
                document.getElementById('feed').style.display = 'block';
                document.querySelector('.fa-home').parentElement.classList.add('active');
            } else if (tab === 'search') {
                document.getElementById('search-view').style.display = 'block';
                document.querySelector('.fa-search').parentElement.classList.add('active');
            } else if (tab === 'messages') {
                document.getElementById('messages-view').style.display = 'block';
                document.querySelector('.fa-envelope').parentElement.classList.add('active');
            } else if (tab === 'profile') {
                document.getElementById('profile-view').style.display = 'block';
                document.querySelector('.fa-user').parentElement.classList.add('active');
                loadProfile();
            }
        }

        async function loadProfile() {
            document.getElementById('profile-username').textContent = currentUserData.username || 'Anonymous';
            const snap = await db.collection('posts').where('uid', '==', currentUser.uid).orderBy('timestamp', 'desc').get();
            const postsDiv = document.getElementById('profile-posts');
            postsDiv.innerHTML = '<h3>Your Posts</h3>';
            snap.forEach(doc => {
                const p = doc.data();
                const div = document.createElement('div');
                div.className = 'post';
                div.innerHTML = `<div class="post-text">${p.text}</div>`;
                postsDiv.appendChild(div);
            });
        }

        async function uploadProfilePic(e) {
            if (!currentUser) return alert('Sign in first');
            const file = e.target.files[0];
            if (file) {
                const ref = storage.ref(`avatars/${currentUser.uid}`);
                await ref.put(file);
                const url = await ref.getDownloadURL();
                await db.collection('users').doc(currentUser.uid).update({photoURL: url});
                alert('Profile picture updated!');
                loadFeed();
            }
        }

        function logout() {
            auth.signOut();
        }
    </script>
</body>
</html>