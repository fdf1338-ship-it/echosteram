<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EchoStream</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --bg:#fff; --text:#000; --card:#f3f3f3; --border:#ddd; --accent:#1da1f2;
}
body.dark {
  --bg:#000; --text:#fff; --card:#1a1a1a; --border:#333;
}
body {
  margin:0;
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  color:var(--text);
}
header {
  position:fixed; top:0; left:0; right:0;
  padding:14px;
  background:var(--bg);
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  z-index:10;
}
nav {
  position:fixed; bottom:0; left:0; right:0;
  display:flex; justify-content:space-around;
  padding:12px 0;
  background:var(--bg);
  border-top:1px solid var(--border);
}
main {
  padding:80px 16px 90px;
  max-width:600px;
  margin:auto;
}
.card {
  background:var(--card);
  padding:16px;
  border-radius:16px;
  margin-bottom:12px;
}
textarea,input {
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--bg);
  color:var(--text);
}
button {
  background:var(--accent);
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:999px;
  margin-top:8px;
  cursor:pointer;
}
.hidden { display:none; }
.avatar {
  width:60px;height:60px;
  border-radius:50%;
  background:#666;
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  font-weight:bold;
}
.verified { color:#1da1f2; }
.post-image {
  max-width:100%;
  border-radius:12px;
  margin-top:8px;
}
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  justify-content:center;
  align-items:center;
}
.modal-content {
  background:var(--card);
  padding:24px;
  border-radius:16px;
  width:90%;
  max-width:400px;
}
</style>
</head>

<body>

<header>
  EchoStream
  <i class="fas fa-cog" onclick="route('settings')"></i>
</header>

<main>

<div id="login">
  <h2>Welcome to EchoStream</h2>
  <button onclick="login()">Sign in with Google</button>
</div>

<div id="feed" class="hidden">
  <div class="card">
    <textarea id="postText" placeholder="Whatâ€™s happening?"></textarea>
    <input type="file" id="postImage" accept="image/*">
    <button onclick="createPost()">Post</button>
  </div>
  <div id="posts"></div>
</div>

<div id="profile" class="hidden"></div>

<div id="settings" class="hidden">
  <div class="card">
    <label>
      <input type="checkbox" id="darkToggle"> Dark mode
    </label><br><br>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<div id="usernameModal" class="modal">
  <div class="modal-content">
    <h3>Pick a username</h3>
    <input id="usernameInput">
    <button onclick="saveUsername()">Save</button>
  </div>
</div>

</main>

<nav>
  <i class="fa fa-house" onclick="route('feed')"></i>
  <i class="fa fa-user" onclick="route('profile')"></i>
  <i class="fa fa-gear" onclick="route('settings')"></i>
</nav>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCmY_zfNcH5XnEaQxlqaTW1D8EUR670-Zo",
  authDomain: "echostream-a102a.firebaseapp.com",
  projectId: "echostream-a102a",
  storageBucket: "echostream-a102a.appspot.com",
  messagingSenderId: "789062222400",
  appId: "1:789062222400:web:73d478269135a77d7d55a5"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
let currentUser, userData;

function login() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function logout() {
  auth.signOut().then(() => location.reload());
}

auth.onAuthStateChanged(async user => {
  if (!user) return;
  currentUser = user;
  document.getElementById("login").style.display = "none";
  route("feed");

  const ref = db.collection("users").doc(user.uid);
  const snap = await ref.get();

  if (!snap.exists) {
    await ref.set({
      username: user.displayName.replace(/\s/g,"").toLowerCase(),
      following: [],
      followers: []
    });
    document.getElementById("usernameModal").style.display = "flex";
  } else {
    userData = snap.data();
  }

  loadFeed();
});

function route(page) {
  ["feed","profile","settings"].forEach(p =>
    document.getElementById(p).classList.add("hidden")
  );
  document.getElementById(page).classList.remove("hidden");
  if (page === "profile") loadProfile(currentUser.uid);
}

async function createPost() {
  const text = postText.value.trim();
  const file = postImage.files[0];
  let imageUrl = "";

  if (file) {
    const path = `posts/${currentUser.uid}/${Date.now()}_${file.name}`;
    const ref = storage.ref(path);
    await ref.put(file);
    imageUrl = await ref.getDownloadURL();
  }

  await db.collection("posts").add({
    uid: currentUser.uid,
    username: userData.username,
    text,
    imageUrl,
    likes: [],
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  postText.value = "";
  postImage.value = "";
}

function loadFeed() {
  db.collection("posts")
    .orderBy("timestamp","desc")
    .onSnapshot(snap => {
      posts.innerHTML = "";
      snap.forEach(doc => {
        const p = doc.data();
        posts.innerHTML += `
          <div class="card">
            <strong onclick="viewUser('${p.username}')">${p.username}</strong>
            <p>${p.text}</p>
            ${p.imageUrl ? `<img src="${p.imageUrl}" class="post-image">` : ""}
          </div>
        `;
      });
    });
}

async function loadProfile(uid) {
  const snap = await db.collection("users").doc(uid).get();
  const u = snap.data();
  profile.innerHTML = `
    <div class="card">
      <div class="avatar">${u.username[0].toUpperCase()}</div>
      <h3>${u.username}</h3>
    </div>
  `;
}

async function viewUser(username) {
  const snap = await db.collection("users").where("username","==",username).get();
  if (!snap.empty) {
    loadProfile(snap.docs[0].id);
    route("profile");
  }
}

async function saveUsername() {
  const name = usernameInput.value.trim().toLowerCase();
  await db.collection("users").doc(currentUser.uid).update({ username: name });
  userData.username = name;
  usernameModal.style.display = "none";
}
</script>

</body>
</html>